# Upload_Mapper 구조 문서

## 📋 전체 구조 개요

```
Upload_Mapper/
├── 🎯 솔루션 레벨 (Solution Level)
│   └── 다팔자 (DafalzaSolution)
│       ├── 📦 마켓 레벨 (Market Level)
│       │   ├── 스마트스토어 (스스)
│       │   ├── 지마켓
│       │   ├── 옥션
│       │   ├── 11번가
│       │   ├── 쿠팡
│       │   ├── 토스
│       │   └── 톡스토어
│       │
│       └── ⚙️ 공통 기능 (Common Features)
│
├── 🔧 규칙 엔진 (Rules Engine)
│   ├── 배송비 계산 (Shipping Fee)
│   ├── 옵션금액 보정 (Option Price Correction)
│   └── 가격 계산 (Price Calculation)
│
└── 🎨 UI 레벨 (GUI Level)
    ├── STEP 1: 솔루션 선택 및 파일 불러오기
    ├── STEP 2: 컬럼 매핑 설정
    └── STEP 3: 매핑 실행 및 결과 저장
```

---

## 🎯 1단계: 솔루션 레벨 (Solution Level)

### 1.1 다팔자 솔루션 (DafalzaSolution)

**위치**: `solutions/dafalza.py`

**기본 구조**:
- **BaseSolution** 상속 (`solutions/base_solution.py`)
- **공통 컬럼**: 상품코드, 상품명, 가격, 배송비, 옵션, 상세정보 등

**주요 기능**:
1. **기본 매핑 규칙** (`get_default_mapping`)
   - 상품코드 → 상품코드
   - ST4_최종결과 → 상품명
   - 사용URL → 대표 이미지
   - search_keywords → 키워드

2. **특화 규칙 적용** (`apply_solution_specific_rules`)
   - 상품명 변환 (ST4_최종결과)
   - 이미지 매핑 (마켓별 처리)
   - 키워드 합치기 및 중복 제거
   - 브랜드/제조사 자동 설정
   - 배송비 계산 (마켓별)
   - 옵션금액 자동 보정
   - 상세정보 HTML 생성

---

## 📦 2단계: 마켓 레벨 (Market Level)

### 2.1 마켓 감지 시스템

**위치**: `main.py` - `_detect_market_from_filename()`

**마켓 접두사 목록** (기본값):
- `스스`, `스마트스토어` → 스스
- `쿠팡` → 쿠팡
- `11번가` → 11번가
- `옥션` → 옥션
- `지마켓` → 지마켓
- `토스` → 토스
- `톡스토어` → 톡스토어

**감지 로직**:
1. 파일명 시작 부분 우선 검사
2. 파일명 전체 검색 (구분자 기준)
3. 긴 접두사 우선 매칭 (예: "스마트스토어" > "스스")

### 2.2 마켓별 기본 매핑 규칙

**위치**: `main.py` - `_get_market_specific_mapping()`

#### 2.2.1 공통 매핑 (모든 마켓)
- `마켓판매가격` → `가격`
- `판매자 부담 할인` → `판매자 부담 할인`

#### 2.2.2 11번가
- `대표 이미지` → `대표 이미지`

#### 2.2.3 쿠팡
- `목록 이미지` → `목록 이미지` (또는 `대표 이미지`)

#### 2.2.4 옥션, 지마켓
- `사용URL` (또는 `목록이미지`, `목록 이미지`) → `목록 이미지` (또는 `대표 이미지`)
- `반품배송비` → `반품배송비` (배송비, 교환배송비 컬럼 없음)

#### 2.2.5 스스 (스마트스토어)
- `사용URL` → `대표 이미지`

### 2.3 마켓별 특화 처리

**위치**: `solutions/dafalza.py` - `apply_solution_specific_rules()`

#### 2.3.1 이미지 처리
- **11번가**: 대표 이미지 사용
- **쿠팡**: 목록 이미지 사용
- **옥션/지마켓**: 사용URL 또는 목록이미지 사용
- **스스**: 사용URL을 대표 이미지로 매핑

#### 2.3.2 배송비 처리
- **옥션/지마켓**: 반품배송비만 처리 (배송비, 교환배송비 컬럼 없음)
- **그 외 마켓**: 배송비, 반품배송비, 교환배송비 모두 처리

---

## 🔧 3단계: 규칙 엔진 (Rules Engine)

### 3.1 배송비 계산 (Shipping Fee)

**위치**: `rules/shipping_fee.py`

**클래스**: `ShippingFeeCalculator`

#### 3.1.1 형식 1: 기본 배송비 변환 로직 (standard)
```
0원 → 0원
2000~3000원 → 3000원
3000~3500원 → 3500원
3500~4000원 → 4000원
4000~5000원 → 5000원
5000~10000원 → 원본 + 1000원
10000원 이상 → 원본 + 2000원
2000원 미만 → 원본 유지
```

**반품배송비**: 변경된 배송비 + 1000원
**교환배송비**: 변경된 반품배송비 × 2

#### 3.1.2 형식 2: 무료배송으로 전환 (free)
```
배송비 → 0원
반품배송비 → 기존 배송비 + 1000원
교환배송비 → (기존 배송비 + 1000원) × 2
```

### 3.2 옵션금액 보정 (Option Price Correction)

**위치**: `rules/option_price_correction.py`

**클래스**: `OptionPriceCorrector`

#### 3.2.1 최대 옵션추가금 계산 (max_delta)
```
P < 2,000원: max_delta = P
2,000 ≤ P < 10,000원: max_delta = P
P ≥ 10,000원: max_delta = P × 0.5
```

#### 3.2.2 단위 내림 규칙
```
1만원 이하: 10원 단위 내림
1만원 초과 3만원 이하: 100원 단위 내림
3만원 초과 6만원 이하: 500원 단위 내림
6만원 초과: 1000원 단위 내림
```

#### 3.2.3 보정 규칙
1. **-값 처리**: 모든 음수 옵션금액을 0으로 변경
2. **0 옵션 보장**: 최소 1개 옵션은 +0원이어야 함
3. **양수 값이 1개인 경우**: max_delta로 고정 (단위 내림 적용)
4. **양수 값이 2개 이상인 경우**: 비율 유지 스케일링 (단위 내림 적용)

**예시**:
- 원본: `색상:빨강,+5000원\n색상:파랑,+3000원`
- 마켓판매가격: 8000원
- max_delta: 8000원
- 보정 후: `색상:빨강,+8000원\n색상:파랑,+4800원` (비율 유지, 단위 내림)

### 3.3 가격 계산 (Price Calculation)

**위치**: `rules/price_calculation.py`

**현재 상태**: 사용 안함 (매핑으로 대체)

---

## 🎨 4단계: UI 레벨 (GUI Level)

### 4.1 STEP 1: 솔루션 선택 및 파일 불러오기

**위치**: `main.py` - `_init_ui()`

**기능**:
1. **솔루션 선택**
   - 콤보박스에서 솔루션 선택 (현재: 다팔자만)
   - 다팔자 선택 시 CSV 생성 버튼 표시

2. **등록 솔루션 엑셀 불러오기**
   - 파일 선택 다이얼로그
   - 기본 경로: `C:\Users\{username}\AppData\Roaming\dafalza\temp`
   - 파일 로드 및 컬럼 확인

3. **가공된 엑셀 불러오기**
   - 파일 선택 다이얼로그
   - **마켓 자동 감지** (파일명 접두사 기반)
   - 필수 컬럼 검증:
     - `마켓판매가격` (다팔자 필수)
     - `판매자 부담 할인` (다팔자 필수)

### 4.2 STEP 2: 컬럼 매핑 설정

**위치**: `main.py` - `_update_mapping_ui()`

**기능**:
1. **매핑 테이블 생성**
   - 가공 엑셀 컬럼 목록 표시
   - 솔루션 엑셀 컬럼 선택 (콤보박스)
   - 기본값 입력 필드

2. **자동 매핑**
   - 기본 매핑 규칙 적용 (`get_default_mapping`)
   - 마켓별 기본 매핑 적용 (`_get_market_specific_mapping`)
   - 저장된 매핑 설정 불러오기

3. **설정 버튼**
   - 💾 매핑 설정 저장 (마켓별 저장)
   - 📥 매핑 설정 불러오기 (자동)
   - 📝 상세설명 문구 설정
   - ⚙️ 솔루션별 고급 설정
   - 🔧 마켓 설정 (다팔자 전용)

### 4.3 STEP 3: 매핑 실행 및 결과 저장

**위치**: `main.py` - `_execute_mapping()`

**실행 순서**:
1. **매핑 정보 수집**
   - 사용자 설정 매핑
   - 기본 매핑 규칙 병합

2. **매핑 적용** (`apply_mapping`)
   - 상품코드 기준 매칭
   - 컬럼 값 복사
   - 판매자 부담 할인 형식 변환 (소수 → 백분율)

3. **솔루션별 특화 규칙 적용** (`apply_solution_specific_rules`)
   - 상품명 변환
   - 이미지 매핑 (마켓별)
   - 키워드 합치기
   - 브랜드/제조사 설정
   - 배송비 계산
   - 옵션금액 보정
   - 상세정보 HTML 생성

4. **기본값 적용**
   - 빈 값에 기본값 채우기

5. **결과 저장**
   - **다팔자**: 원본 파일에 저장 (백업 자동 생성)
   - **그 외**: 새 파일로 저장

6. **결과 팝업**
   - 매핑 통계 표시
   - 상품코드 매칭 통계
   - 컬럼별 매핑 결과

---

## ⚙️ 5단계: 고급 설정

### 5.1 배송비 계산 방식

**위치**: `main.py` - `_open_advanced_settings()`

**옵션**:
- 형식 1: 기본 배송비 변환 로직
- 형식 2: 무료배송으로 전환

### 5.2 옵션금액 규칙

**옵션**:
- 스마트스토어 기준 (기본값)
- 사용 안함

### 5.3 상세정보 상단 설정

**구성 요소**:
1. **대표 이미지**
   - 가로/세로 사이즈 설정
   - 원본 등록 솔루션 엑셀의 이미지 사용

2. **상품명 표시**
   - 텍스트 형식: `[상품명: {상품명}]`
   - 컬러, 폰트 사이즈 설정

3. **필독 문구**
   - 텍스트: `[필독] 제품명 및 상세설명에 기재된 '본품'만 발송됩니다.`
   - 배경 컬러, 패딩 설정

### 5.4 상세정보 하단 설정

**구성 요소**:
1. **하단 이미지 URL 목록**
   - 여러 URL 중 랜덤으로 1개 선택 (엑셀 전체 공통)
   - 기본값: exchange_0.jpg ~ exchange_9.jpg

2. **하단 문구**
   - HTML 형식 사용 가능
   - 템플릿 선택 가능

### 5.5 마켓 설정 (다팔자 전용)

**위치**: `main.py` - `_open_market_settings()`

**기능**:
- 마켓 접두사 추가/수정/삭제
- 파일명 접두사로 마켓 자동 감지

---

## 📊 6단계: 설정 관리

### 6.1 설정 파일 구조

**위치**: `config_manager.py`

**파일**: `upload_mapper_config.json`

**구조**:
```json
{
  "solutions": {
    "다팔자": {
      "market_mappings": {
        "스스": {
          "column_mapping": {...},
          "default_values": {...}
        },
        "지마켓": {...},
        "옥션": {...},
        ...
      },
      "shipping_method": "standard",
      "option_price_rule": "smartstore",
      "detail_top_image_width": 500,
      ...
    }
  },
  "market_prefixes": {
    "스스": "스스",
    "스마트스토어": "스스",
    ...
  }
}
```

### 6.2 마켓별 설정 분리

- **공통 설정**: 모든 마켓에 공통 적용
- **마켓별 설정**: `market_mappings` 내에 마켓별로 저장
  - `column_mapping`: 컬럼 매핑 규칙
  - `default_values`: 기본값 설정

---

## 🔄 7단계: 데이터 흐름

### 7.1 전체 흐름도

```
[등록 솔루션 엑셀] + [가공된 엑셀]
         ↓
    [마켓 감지]
         ↓
    [매핑 설정]
         ↓
    [기본 매핑 적용]
         ↓
    [마켓별 매핑 적용]
         ↓
    [솔루션별 특화 규칙]
         ├─ 배송비 계산
         ├─ 옵션금액 보정
         └─ 상세정보 HTML 생성
         ↓
    [기본값 적용]
         ↓
    [결과 저장]
```

### 7.2 상세 처리 순서

1. **파일 로드**
   - 등록 솔루션 엑셀 → `solution_df`
   - 가공된 엑셀 → `processed_df`

2. **마켓 감지**
   - 파일명 접두사 분석 → `detected_market`

3. **매핑 설정 로드**
   - 마켓별 설정 불러오기 → `config`

4. **매핑 적용**
   - 상품코드 기준 매칭
   - 컬럼 값 복사

5. **특화 규칙 적용**
   - 배송비 계산
   - 옵션금액 보정
   - 상세정보 생성

6. **결과 저장**
   - 다팔자: 원본 파일 덮어쓰기 (백업 생성)
   - 그 외: 새 파일로 저장

---

## 📝 8단계: 주요 기능 상세

### 8.1 다팔자 CSV 생성

**위치**: `main.py` - `_create_dafalza_csv()`

**기능**:
- 여러 엑셀 파일 일괄 처리
- 각 파일의 첫 번째 열만 추출
- CSV 파일로 저장 (인덱스/헤더 없음)
- 통합 CSV 생성 (상품코드 중복 제거)
- 전체 엑셀 병합 파일 생성

### 8.2 상세정보 HTML 생성

**위치**: `solutions/dafalza.py` - `apply_solution_specific_rules()`

**구조**:
```html
<center>
  <img src="[대표 이미지]" style="width: 500px; height: 500px;" /><br>
  <span style="color: blue; font-size: 10px;">[상품명: {상품명}]</span><br>
  <span style="background-color: yellow; padding: 2px 5px;">[필독] ...</span>
</center>
<br>
[원본 상세정보]
<br>
<center>
  <img src="[하단 이미지 URL]" />
</center>
<br>
<center>[하단 문구]</center>
```

### 8.3 키워드 합치기

**로직**:
1. 가공 엑셀의 키워드 가져오기
2. 등록 솔루션 엑셀의 기존 키워드 가져오기
3. 쉼표로 분리하여 리스트로 변환
4. 순서: 가공키워드 먼저, 그 다음 등록솔루션 키워드
5. 중복 제거 (순서 유지)
6. 쉼표로 다시 합치기

---

## 🎯 요약

### 계층 구조
```
솔루션 (다팔자)
  └─ 마켓 (스스, 지마켓, 옥션, 11번가, 쿠팡, 토스, 톡스토어)
      ├─ 기본 매핑 (공통)
      ├─ 마켓별 매핑 (특화)
      └─ 규칙 적용
          ├─ 배송비 계산
          ├─ 옵션금액 보정
          └─ 상세정보 생성
```

### 주요 특징
1. **마켓별 설정 분리**: 각 마켓마다 독립적인 매핑 설정 저장
2. **자동 마켓 감지**: 파일명 접두사로 마켓 자동 인식
3. **규칙 기반 처리**: 배송비, 옵션금액 등 자동 계산
4. **HTML 상세정보**: 이미지, 텍스트, 스타일 자동 생성
5. **백업 자동 생성**: 다팔자 원본 파일 저장 시 백업 생성

