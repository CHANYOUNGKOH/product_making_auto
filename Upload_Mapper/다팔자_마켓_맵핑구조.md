# 다팔자 솔루션 - 오픈마켓 맵핑 구조

## 📋 개요

다팔자 솔루션은 7개의 오픈마켓(스마트스토어, 지마켓, 옥션, 11번가, 쿠팡, 토스, 톡스토어)과 매핑되며, 각 마켓별로 특화된 처리 규칙이 적용됩니다.

---

## 🎯 1. 마켓 감지 시스템

### 1.1 파일명 접두사 기반 자동 감지

**위치**: `main.py` - `_detect_market_from_filename()`

**기본 접두사 목록** (`config_manager.py`):
```python
{
    "스스": "스스",
    "스마트스토어": "스스",
    "쿠팡": "쿠팡",
    "11번가": "11번가",
    "옥션": "옥션",
    "지마켓": "지마켓",
    "토스": "토스",
    "톡스토어": "톡스토어"
}
```

**감지 로직**:
1. 파일명 시작 부분 우선 검사
2. 파일명 전체 검색 (구분자 `_`, `-`, 공백, `.` 기준)
3. 긴 접두사 우선 매칭 (예: "스마트스토어" > "스스")

**예시**:
- `스스_상품목록.xlsx` → **스스** 감지
- `스마트스토어_2024.xlsx` → **스스** 감지
- `쿠팡-상품.xlsx` → **쿠팡** 감지
- `11번가 상품.xlsx` → **11번가** 감지

---

## 🔄 2. 기본 매핑 규칙 (공통)

### 2.1 다팔자 기본 매핑

**위치**: `solutions/dafalza.py` - `get_default_mapping()`

```python
{
    "상품코드": "상품코드",
    "ST4_최종결과": "상품명",
    "사용URL": "대표 이미지",
    "search_keywords": "키워드"
}
```

### 2.2 공통 마켓별 매핑

**위치**: `main.py` - `_get_market_specific_mapping()`

**모든 마켓 공통**:
- `마켓판매가격` → `가격`
- `판매자 부담 할인` → `판매자 부담 할인`

---

## 📦 3. 마켓별 특화 매핑 규칙

### 3.1 스마트스토어 (스스)

**이미지 매핑**:
- `사용URL` → `대표 이미지`

**배송비 처리**:
- `배송비`, `반품배송비`, `교환배송비` 모두 처리
- 배송비 계산 규칙 적용 (형식 1 또는 형식 2)

**특화 처리**:
- 상세정보 상단에 원본 등록 솔루션 엑셀의 대표 이미지 사용

---

### 3.2 지마켓

**이미지 매핑**:
- `사용URL` 또는 `목록이미지` 또는 `목록 이미지` → `목록 이미지` (또는 `대표 이미지`)

**배송비 처리**:
- `반품배송비`만 처리 (등록 솔루션에 `배송비`, `교환배송비` 컬럼 없음)
- 배송비 계산 규칙 적용 안 함

**특화 처리**:
- 상세정보 상단에 원본 등록 솔루션 엑셀의 목록이미지 우선 사용

---

### 3.3 옥션

**이미지 매핑**:
- `사용URL` 또는 `목록이미지` 또는 `목록 이미지` → `목록 이미지` (또는 `대표 이미지`)

**배송비 처리**:
- `반품배송비`만 처리 (등록 솔루션에 `배송비`, `교환배송비` 컬럼 없음)
- 배송비 계산 규칙 적용 안 함

**특화 처리**:
- 상세정보 상단에 원본 등록 솔루션 엑셀의 목록이미지 우선 사용

---

### 3.4 11번가

**이미지 매핑**:
- `대표 이미지` → `대표 이미지`

**배송비 처리**:
- `배송비`, `반품배송비`, `교환배송비` 모두 처리
- 배송비 계산 규칙 적용 (형식 1 또는 형식 2)

**특화 처리**:
- 상세정보 상단에 원본 등록 솔루션 엑셀의 대표 이미지 우선 사용

---

### 3.5 쿠팡

**이미지 매핑**:
- `목록 이미지` → `목록 이미지` (또는 `대표 이미지`)

**배송비 처리**:
- `배송비`, `반품배송비`, `교환배송비` 모두 처리
- 배송비 계산 규칙 적용 (형식 1 또는 형식 2)

**특화 처리**:
- 상세정보 상단에 원본 등록 솔루션 엑셀의 목록 이미지 우선 사용

---

### 3.6 토스

**이미지 매핑**:
- 기본: `사용URL` 또는 `대표 이미지` 사용

**배송비 처리**:
- `배송비`, `반품배송비`, `교환배송비` 모두 처리
- 배송비 계산 규칙 적용 (형식 1 또는 형식 2)

---

### 3.7 톡스토어

**이미지 매핑**:
- 기본: `사용URL` 또는 `대표 이미지` 사용

**배송비 처리**:
- `배송비`, `반품배송비`, `교환배송비` 모두 처리
- 배송비 계산 규칙 적용 (형식 1 또는 형식 2)

---

## 🔧 4. 마켓별 특화 처리 규칙

### 4.1 이미지 처리 로직

**위치**: `solutions/dafalza.py` - `apply_solution_specific_rules()`

| 마켓 | 가공 엑셀 컬럼 (우선순위) | 등록 솔루션 컬럼 | 상세정보 이미지 |
|------|------------------------|----------------|----------------|
| **스스** | `사용URL` | `대표 이미지` | 원본 등록 솔루션의 `대표 이미지` |
| **지마켓** | `사용URL` → `목록이미지` → `목록 이미지` | `목록 이미지` 또는 `대표 이미지` | 원본 등록 솔루션의 `목록이미지` 우선 |
| **옥션** | `사용URL` → `목록이미지` → `목록 이미지` | `목록 이미지` 또는 `대표 이미지` | 원본 등록 솔루션의 `목록이미지` 우선 |
| **11번가** | `대표 이미지` | `대표 이미지` | 원본 등록 솔루션의 `대표 이미지` 우선 |
| **쿠팡** | `목록 이미지` | `목록 이미지` 또는 `대표 이미지` | 원본 등록 솔루션의 `목록 이미지` 우선 |
| **토스** | `사용URL` → `대표 이미지` | `대표 이미지` | 원본 등록 솔루션의 `대표 이미지` 우선 |
| **톡스토어** | `사용URL` → `대표 이미지` | `대표 이미지` | 원본 등록 솔루션의 `대표 이미지` 우선 |

**참고**: 상세정보 상단 이미지는 항상 **원본 등록 솔루션 엑셀**의 이미지를 사용하며, 가공된 엑셀의 이미지는 매핑 컬럼에만 반영됩니다.

---

### 4.2 배송비 처리 로직

**위치**: `solutions/dafalza.py` - `apply_solution_specific_rules()`

#### 4.2.1 옥션, 지마켓 (특수 처리)

- **처리 컬럼**: `반품배송비`만 처리
- **이유**: 등록 솔루션에 `배송비`, `교환배송비` 컬럼이 없음
- **처리 방식**: 가공 엑셀의 `반품배송비` 값을 그대로 복사

```python
# 옥션, 지마켓: 반품배송비만 처리
if detected_market in ["옥션", "지마켓"]:
    if "반품배송비" in result_df.columns:
        # 가공 엑셀의 반품배송비 값을 그대로 복사
        return_fee_value = processed_dict[product_code].get("반품배송비", 0)
        result_df.at[idx, "반품배송비"] = return_fee_num
```

#### 4.2.2 그 외 마켓 (스스, 11번가, 쿠팡, 토스, 톡스토어)

- **처리 컬럼**: `배송비`, `반품배송비`, `교환배송비` 모두 처리
- **처리 방식**: 배송비 계산 규칙 적용

**배송비 계산 규칙** (`rules/shipping_fee.py`):

**형식 1: 기본 배송비 변환 로직 (standard)**
```
0원 → 0원
2000~3000원 → 3000원
3000~3500원 → 3500원
3500~4000원 → 4000원
4000~5000원 → 5000원
5000~10000원 → 원본 + 1000원
10000원 이상 → 원본 + 2000원
2000원 미만 → 원본 유지
```

**반품배송비 계산**:
- 배송비가 0인 경우: `원본 반품배송비 + 1000원`
- 배송비가 0이 아닌 경우: `변경된 배송비 + 1000원`

**교환배송비 계산**:
- 배송비가 0인 경우: `(원본 반품배송비 + 1000원) × 2`
- 배송비가 0이 아닌 경우: `변경된 반품배송비 × 2`

**형식 2: 무료배송으로 전환 (free)**
```
배송비 → 0원
반품배송비 → 기존 배송비 + 1000원
교환배송비 → (기존 배송비 + 1000원) × 2
```

---

### 4.3 키워드 처리

**위치**: `solutions/dafalza.py` - `apply_solution_specific_rules()`

**처리 로직**:
1. 가공 엑셀의 `search_keywords` 가져오기
2. 등록 솔루션 엑셀의 기존 `키워드` 가져오기
3. **키워드 정규화**: 각 키워드의 앞뒤 공백 제거 후 **내부 띄어쓰기 제거**
4. 쉼표로 분리하여 리스트로 변환
5. **순서**: 가공키워드 먼저, 그 다음 등록솔루션 키워드
6. 중복 제거 (순서 유지)
7. 쉼표로 다시 합치기

**키워드 정규화 함수**:
```python
def normalize_keyword(k):
    """키워드 정규화: 앞뒤 공백 제거 후 내부 띄어쓰기 제거"""
    return k.strip().replace(" ", "")
```

**예시**:
- 가공 엑셀: `"키워드1, 키워드 2, 키워드3"` → 정규화 후: `["키워드1", "키워드2", "키워드3"]`
- 등록 솔루션: `"키워드2, 키워드 4"` → 정규화 후: `["키워드2", "키워드4"]`
- 결과: `"키워드1,키워드2,키워드3,키워드4"` (중복 제거, 순서 유지, 띄어쓰기 제거)

---

### 4.4 옵션금액 보정

**위치**: `rules/option_price_correction.py`

**적용 조건**:
- 옵션금액 규칙이 "none"이 아니고
- `옵션` 컬럼과 `마켓판매가격` 컬럼이 있을 때만 보정 수행

**보정 규칙**:

1. **최대 옵션추가금 계산 (max_delta)**:
   ```
   P < 2,000원: max_delta = P
   2,000 ≤ P < 10,000원: max_delta = P
   P ≥ 10,000원: max_delta = P × 0.5
   ```

2. **단위 내림 규칙**:
   ```
   1만원 이하: 10원 단위 내림
   1만원 초과 3만원 이하: 100원 단위 내림
   3만원 초과 6만원 이하: 500원 단위 내림
   6만원 초과: 1000원 단위 내림
   ```

3. **보정 규칙**:
   - **-값 처리**: 모든 음수 옵션금액을 0으로 변경
   - **0 옵션 보장**: 최소 1개 옵션은 +0원이어야 함
   - **양수 값이 1개인 경우**: max_delta로 고정 (단위 내림 적용)
   - **양수 값이 2개 이상인 경우**: 비율 유지 스케일링 (단위 내림 적용)

**예시**:
- 원본 옵션: `색상:빨강,+5000원\n색상:파랑,+3000원`
- 마켓판매가격: 8000원
- max_delta: 8000원
- 보정 후: `색상:빨강,+8000원\n색상:파랑,+4800원` (비율 유지, 단위 내림)

---

### 4.5 상세정보 HTML 생성

**위치**: `solutions/dafalza.py` - `apply_solution_specific_rules()`

**구조**:
```html
<center>
  <!-- 상단: 대표 이미지 (원본 등록 솔루션 엑셀) -->
  <img src="[대표 이미지 URL]" style="width: 500px; height: 500px;" /><br>
  
  <!-- 상품명 표시 -->
  <span style="color: blue; font-size: 10px;">[상품명: {상품명}]</span><br>
  
  <!-- 필독 문구 -->
  <span style="background-color: yellow; padding: 2px 5px;">
    [필독] 제품명 및 상세설명에 기재된 '본품'만 발송됩니다.
  </span>
</center>
<br>

<!-- 원본 상세정보 -->
[원본 상세정보]
<br>

<!-- 하단: 교환 이미지 (랜덤 1개, 엑셀 전체 공통) -->
<center>
  <img src="[하단 이미지 URL]" />
</center>
<br>

<!-- 하단 문구 -->
<center>[하단 문구]</center>
```

**설정 가능 항목**:
- 상단 이미지: 가로/세로 사이즈
- 상품명 표시: 텍스트, 컬러, 폰트 사이즈
- 필독 문구: 텍스트, 배경 컬러, 패딩
- 하단 이미지: URL 목록 (랜덤 선택)
- 하단 문구: HTML 형식, 템플릿 선택 가능

---

## 📊 5. 마켓별 매핑 요약표

| 마켓 | 이미지 매핑 | 배송비 처리 | 옵션금액 보정 | 상세정보 이미지 |
|------|------------|------------|--------------|----------------|
| **스스** | `사용URL` → `대표 이미지` | 배송비, 반품, 교환 모두 | ✅ | 원본 대표 이미지 |
| **지마켓** | `사용URL`/`목록이미지` → `목록 이미지` | 반품만 | ✅ | 원본 목록이미지 |
| **옥션** | `사용URL`/`목록이미지` → `목록 이미지` | 반품만 | ✅ | 원본 목록이미지 |
| **11번가** | `대표 이미지` → `대표 이미지` | 배송비, 반품, 교환 모두 | ✅ | 원본 대표 이미지 |
| **쿠팡** | `목록 이미지` → `목록 이미지` | 배송비, 반품, 교환 모두 | ✅ | 원본 목록 이미지 |
| **토스** | `사용URL`/`대표 이미지` → `대표 이미지` | 배송비, 반품, 교환 모두 | ✅ | 원본 대표 이미지 |
| **톡스토어** | `사용URL`/`대표 이미지` → `대표 이미지` | 배송비, 반품, 교환 모두 | ✅ | 원본 대표 이미지 |

---

## 🔄 6. 데이터 흐름도

```
[등록 솔루션 엑셀] + [가공된 엑셀]
         ↓
    [마켓 감지] (파일명 접두사)
         ↓
    [기본 매핑 적용]
         ├─ 상품코드 → 상품코드
         ├─ ST4_최종결과 → 상품명
         ├─ 사용URL → 대표 이미지
         └─ search_keywords → 키워드
         ↓
    [마켓별 매핑 적용]
         ├─ 마켓판매가격 → 가격 (공통)
         ├─ 판매자 부담 할인 → 판매자 부담 할인 (공통)
         ├─ 이미지 컬럼 (마켓별)
         └─ 배송비 컬럼 (마켓별)
         ↓
    [솔루션별 특화 규칙]
         ├─ 상품명 변환
         ├─ 이미지 매핑 (마켓별)
         ├─ 키워드 합치기 (중복 제거)
         ├─ 브랜드/제조사 설정
         ├─ 배송비 계산 (마켓별)
         ├─ 옵션금액 보정
         └─ 상세정보 HTML 생성
         ↓
    [기본값 적용]
         ↓
    [결과 저장] (원본 파일 덮어쓰기, 백업 자동 생성)
```

---

## 📝 7. 주요 특징

1. **마켓별 설정 분리**: 각 마켓마다 독립적인 매핑 설정 저장
2. **자동 마켓 감지**: 파일명 접두사로 마켓 자동 인식
3. **규칙 기반 처리**: 배송비, 옵션금액 등 자동 계산
4. **HTML 상세정보**: 이미지, 텍스트, 스타일 자동 생성
5. **백업 자동 생성**: 다팔자 원본 파일 저장 시 백업 생성
6. **마켓별 특화 처리**: 옥션/지마켓은 반품배송비만, 그 외는 배송비/반품/교환 모두 처리

---

## 🎯 8. 마켓별 차이점 요약

### 8.1 이미지 처리 차이
- **스스, 11번가, 토스, 톡스토어**: `대표 이미지` 사용
- **지마켓, 옥션**: `목록이미지` 또는 `목록 이미지` 사용
- **쿠팡**: `목록 이미지` 사용

### 8.2 배송비 처리 차이
- **옥션, 지마켓**: `반품배송비`만 처리 (배송비 계산 규칙 적용 안 함)
- **그 외 마켓**: `배송비`, `반품배송비`, `교환배송비` 모두 처리 (배송비 계산 규칙 적용)

### 8.3 상세정보 이미지 차이
- 모든 마켓: 상세정보 상단에는 **원본 등록 솔루션 엑셀**의 이미지 사용
- 마켓별로 우선순위가 다름 (대표 이미지 vs 목록 이미지)

---

## 📌 참고사항

- 마켓 접두사는 `config_manager.py`에서 기본값으로 설정되며, UI에서 수정 가능
- 배송비 계산 방식은 고급 설정에서 변경 가능 (형식 1 또는 형식 2)
- 옵션금액 보정 규칙은 고급 설정에서 비활성화 가능
- 상세정보 상단/하단 문구는 템플릿으로 관리 가능

---

# 이셀러스 솔루션 - 기본 구조

## 📋 개요

이셀러스 솔루션은 **2개의 시트 구조**를 가지고 있으며, 다팔자와 달리 시트별로 역할이 분리되어 있습니다.

**시트 구조**:
- **기본정보**: 상품의 기본 정보 및 공통 속성
- **확장정보**: 마켓별 특화 정보 및 속성

---

## 📊 1. 시트 구조

### 1.1 기본정보 시트

**시트명**: `기본정보`

**주요 컬럼 구조**:

#### 기본 정보
- `원본번호*` (필수)
- `판매자 관리코드`
- `폴더명`
- `카테고리 번호*` (필수)

#### 상품 정보
- `상품명*` (필수)
- `판매가*` (필수)
- `수량*` (필수)
- `최대구매수량`
- `최소구매수량`
- `원산지*` (필수)
- `G마켓,옥션 원산지 유형`
- `수입사`

#### 이미지 정보
- `목록 이미지*` (필수)
- `이미지1(대표/기본이미지)*` (필수)
- `이미지2`
- `이미지3`
- `이미지4`
- `이미지5`

#### 상세설명
- `상세설명*` (필수)
- `ESM 추가구성 상세설명`
- `ESM 광고홍보 상세설명`

#### 선택사항/옵션
- `선택사항 타입`
- `선택사항 옵션명`
- `선택사항 상세정보`
- `선택사항 재고 사용여부`
- `작성형 선택사항`
- `추가구성 옵션명`
- `추가구성 상세정보`

#### 상품 속성
- `브랜드`
- `모델명`
- `제조사`
- `과세여부`
- `나이제한`
- `제조일자`
- `유효일자`
- `홍보문구`
- `상품상태`

#### 가격 정보
- `원가`
- `공급가`
- `도서정가`
- `ISBN`
- `문화비 소득공제`

#### 검색/태그
- `검색어(태그)`
- `인증정보`

#### 요약정보
- `요약정보 상품군 코드*` (필수)
- `요약정보 전항목 상세설명 참조`
- `값1` ~ `값29` (값1 ~ 값29)

#### 오류 메시지
- `기본정보 오류메시지`

**전체 컬럼 목록** (순서대로):
```
원본번호*
판매자 관리코드
폴더명
카테고리 번호*
상품명*
판매가*
수량*
최대구매수량
최소구매수량
원산지*
G마켓,옥션 원산지 유형
수입사
목록 이미지*
이미지1(대표/기본이미지)*
이미지2
이미지3
이미지4
이미지5
상세설명*
ESM 추가구성 상세설명
ESM 광고홍보 상세설명
선택사항 타입
선택사항 옵션명
선택사항 상세정보
선택사항 재고 사용여부
작성형 선택사항
추가구성 옵션명
추가구성 상세정보
브랜드
모델명
제조사
과세여부
나이제한
제조일자
유효일자
홍보문구
상품상태
원가
공급가
도서정가
ISBN
문화비 소득공제
검색어(태그)
인증정보
요약정보 상품군 코드*
요약정보 전항목 상세설명 참조
값1
값2
값3
값4
값5
값6
값7
값8
값9
값10
값11
값12
값13
값14
값15
값16
값17
값18
값19
값20
값21
값22
값23
값24
값25
값26
값27
값28
값29
기본정보 오류메시지
```

---

### 1.2 확장정보 시트

**시트명**: `확장정보`

**주요 컬럼 구조**:

#### 기본 정보
- `원본번호*` (필수) - 기본정보 시트와 연결 키

#### 마켓별 카테고리
- `마켓 카테고리번호`

#### 마켓별 특화 정보

**위메프2.0**:
- `위메프2.0 담당MD`

**스마트스토어**:
- `스마트스토어 전용 상품명 사용 여부`
- `스마트스토어 전용 상품명`
- `스마트스토어 상품속성`

**병행수입/수입 관련**:
- `병행수입여부 및 수입신고필증`
- `롯데ON 수입형태`
- `인보이스`
- `기타 구비서류`

**쿠팡 특화 옵션**:
- `쿠팡 옵션 할인율기준가`
- `쿠팡 옵션 대표이미지`
- `쿠팡 옵션 상세설명`
- `쿠팡 옵션 바코드`
- `쿠팡 옵션 인증정보`
- `쿠팡 옵션 모델번호`
- `쿠팡 옵션 검색옵션명`
- `쿠팡 옵션 검색옵션값`

**11번가**:
- `11번가 상품속성`

**위메프2.0 추가**:
- `위메프2.0 상품속성 라벨`
- `위메프2.0 제휴채널 검색키워드`

**티몬**:
- `티몬 법적허가 및 신고대상 상품`

#### 오류 메시지
- `확장정보 오류메시지`

**전체 컬럼 목록** (순서대로):
```
원본번호*
마켓 카테고리번호
위메프2.0 담당MD
스마트스토어 전용 상품명 사용 여부
스마트스토어 전용 상품명
병행수입여부 및 수입신고필증
롯데ON 수입형태
인보이스
기타 구비서류
쿠팡 옵션 할인율기준가
쿠팡 옵션 대표이미지
쿠팡 옵션 상세설명
쿠팡 옵션 바코드
쿠팡 옵션 인증정보
쿠팡 옵션 모델번호
쿠팡 옵션 검색옵션명
쿠팡 옵션 검색옵션값
11번가 상품속성
스마트스토어 상품속성
위메프2.0 상품속성 라벨
위메프2.0 제휴채널 검색키워드
티몬 법적허가 및 신고대상 상품
확장정보 오류메시지
```

---

## 🔑 2. 주요 특징

### 2.1 시트 구조 차이점

| 구분 | 다팔자 | 이셀러스 |
|------|--------|----------|
| **시트 수** | 1개 (단일 시트) | 2개 (기본정보, 확장정보) |
| **연결 키** | `상품코드` | `원본번호*` |
| **마켓별 정보** | 컬럼으로 구분 | 확장정보 시트에 집중 |

### 2.2 이셀러스 구조의 장점

1. **기본정보와 확장정보 분리**: 공통 정보와 마켓별 특화 정보를 명확히 구분
2. **마켓별 특화 정보 집중**: 확장정보 시트에 마켓별 속성 및 옵션 정보 관리
3. **유연한 확장성**: 새로운 마켓 추가 시 확장정보 시트에 컬럼 추가만 하면 됨

### 2.3 필수 컬럼 (기본정보)

- `원본번호*` - 상품 식별자 (확장정보와 연결 키)
- `카테고리 번호*` - 카테고리 정보
- `상품명*` - 상품명
- `판매가*` - 판매 가격
- `수량*` - 재고 수량
- `원산지*` - 원산지 정보
- `목록 이미지*` - 목록용 이미지
- `이미지1(대표/기본이미지)*` - 대표 이미지
- `상세설명*` - 상세 설명
- `요약정보 상품군 코드*` - 요약정보 코드

### 2.4 마켓별 특화 컬럼 (확장정보)

**쿠팡**:
- 쿠팡 옵션 관련 컬럼 8개 (할인율기준가, 대표이미지, 상세설명, 바코드, 인증정보, 모델번호, 검색옵션명, 검색옵션값)

**스마트스토어**:
- 스마트스토어 전용 상품명 관련 컬럼 2개
- 스마트스토어 상품속성

**11번가**:
- 11번가 상품속성

**위메프2.0**:
- 위메프2.0 담당MD
- 위메프2.0 상품속성 라벨
- 위메프2.0 제휴채널 검색키워드

**티몬**:
- 티몬 법적허가 및 신고대상 상품

**롯데ON**:
- 롯데ON 수입형태

**공통 (수입 관련)**:
- 병행수입여부 및 수입신고필증
- 인보이스
- 기타 구비서류

---

## 🔄 3. 데이터 구조 비교

### 3.1 다팔자 vs 이셀러스

| 항목 | 다팔자 | 이셀러스 |
|------|--------|----------|
| **식별자** | `상품코드` | `원본번호*` |
| **상품명** | `상품명` | `상품명*` |
| **가격** | `가격` | `판매가*` |
| **대표 이미지** | `대표 이미지` | `이미지1(대표/기본이미지)*` |
| **목록 이미지** | `목록 이미지` (옵션) | `목록 이미지*` (필수) |
| **상세설명** | `상세정보` | `상세설명*` |
| **키워드** | `키워드` | `검색어(태그)` |
| **옵션** | `옵션` | `선택사항 옵션명`, `선택사항 상세정보` |
| **마켓별 정보** | 컬럼으로 구분 | 확장정보 시트에 집중 |

### 3.2 이미지 구조 차이

**다팔자**:
- `대표 이미지` (1개)
- `목록 이미지` (옵션, 일부 마켓만)

**이셀러스**:
- `목록 이미지*` (필수)
- `이미지1(대표/기본이미지)*` (필수)
- `이미지2` ~ `이미지5` (옵션, 최대 5개)

---

## 🔄 3.3 이셀러스 기본 매핑 규칙

### 3.3.1 데이터 시작 행

**중요**: 이셀러스 양식은 **2행이 설명탭**이며, **실질적인 데이터는 3행부터 시작**합니다.

---

### 3.3.2 기본정보 시트 매핑 규칙

**위치**: `solutions/esellers.py` - `get_default_mapping()` (구현 예정)

#### 식별자 매핑

| 이셀러스 컬럼 | 가공 엑셀 컬럼 | 비고 |
|--------------|---------------|------|
| `판매자 관리코드` | `상품코드` | **핵심 식별자** (가공 엑셀의 상품코드 = 이셀러스의 판매자 관리코드) |
| `원본번호*` | - | **미사용** (매핑하지 않음) |

#### 파일명 기반 매핑

| 이셀러스 컬럼 | 가공 엑셀 컬럼/값 | 비고 |
|--------------|------------------|------|
| `폴더명` | **엑셀 파일명** | 한글, 영문, 숫자만 (40byte 이내) |

#### 기본 정보 매핑

| 이셀러스 컬럼 | 가공 엑셀 컬럼 | 비고 |
|--------------|---------------|------|
| `상품명*` | `ST4_최종결과` | 필수 |
| `판매가*` | `마켓판매가격` | 필수 |

#### 이미지 매핑

| 이셀러스 컬럼 | 가공 엑셀 컬럼/값 | 비고 |
|--------------|------------------|------|
| `목록 이미지*` | `사용URL` | 필수 |
| `이미지1(대표/기본이미지)*` | `사용URL` | 필수, 목록 이미지와 동일 |
| `이미지2` | `목록 이미지` (기존값 재사용) | 목록 이미지 값을 재사용 |

**이미지 처리 로직**:
1. `목록 이미지*` = 가공 엑셀의 `사용URL`
2. `이미지1(대표/기본이미지)*` = 가공 엑셀의 `사용URL` (목록 이미지와 동일)
3. `이미지2` = 등록 솔루션 엑셀의 기존 `목록 이미지` 값 재사용

#### 상세설명 매핑

| 이셀러스 컬럼 | 가공 엑셀 컬럼/처리 | 비고 |
|--------------|-------------------|------|
| `상세설명*` | **다팔자와 동일한 로직** | 필수 |

**상세설명 생성 로직** (다팔자와 동일):
```html
<center>
  <!-- 상단: 기본 이미지 (원본 등록 솔루션 엑셀) -->
  <img src="[기본 이미지 URL]" style="width: 500px; height: 500px;" /><br>
  
  <!-- 상품명 표시 -->
  <span style="color: blue; font-size: 10px;">[상품명: {상품명}]</span><br>
  
  <!-- 필독 문구 -->
  <span style="background-color: yellow; padding: 2px 5px;">
    [필독] 제품명 및 상세설명에 기재된 '본품'만 발송됩니다.
  </span>
</center>
<br>

<!-- 원본 상세설명 -->
[원본 상세설명]
<br>

<!-- 하단: 호스팅 이미지 (랜덤 1개, 엑셀 전체 공통) -->
<center>
  <img src="[하단 이미지 URL]" />
</center>
<br>

<!-- 하단 문구 -->
<center>[하단 문구]</center>
```

#### 선택사항 매핑

| 이셀러스 컬럼 | 가공 엑셀 컬럼/처리 | 비고 |
|--------------|-------------------|------|
| `선택사항 상세정보` | **옵션가격조정 로직 적용** | 이셀러스 형식에 맞는 옵션금액 보정 규칙 |

**선택사항 상세정보 형식**:

**독립형 옵션**:
```
옵션명*옵션값**추가금액*수량*노출여부(Y/N)*이미지URL*판매자관리코드
```

**조합형 옵션**:
```
옵션명1의 옵션값*옵션명2의 옵션값**추가금액*수량*노출여부(Y/N)*이미지URL*판매자관리코드*용량
```

**옵션가격조정 로직**:
- 다팔자와 동일한 옵션금액 보정 규칙 적용
- `rules/option_price_correction.py`의 계산 로직 사용
- 최대 옵션추가금 계산 및 단위 내림 규칙 적용
- **추가금액은 정수로 저장** (소수점 제거, 예: 52000.0 → 52000)
- 이셀러스 형식 파싱: `**`로 분리하여 추가금액 부분 추출 및 보정

#### 상품 속성 매핑

| 이셀러스 컬럼 | 값/처리 | 비고 |
|--------------|---------|------|
| `브랜드` | **공란** | 빈 값으로 설정 |
| `모델명` | `"edit" + 판매자 관리코드` | 예: "editABC123" |
| `제조사` | `"onerclan OEM"` | 다팔자와 동일 |
| `홍보문구` | `"모든카드 무이자 3개월!"` | 고정값 |

#### 검색어/태그 매핑

| 이셀러스 컬럼 | 가공 엑셀 컬럼/처리 | 비고 |
|--------------|-------------------|------|
| `검색어(태그)` | **기존 태그 + search_keywords** | 다팔자와 동일한 로직 |

**검색어 처리 로직** (다팔자와 동일):

**위치**: `solutions/esellers.py` - `apply_solution_specific_rules()` (구현 예정)

**처리 단계**:
1. 가공 엑셀의 `search_keywords` 가져오기
2. 등록 솔루션 엑셀의 기존 `검색어(태그)` 가져오기
3. **키워드 정규화**: 각 키워드의 앞뒤 공백 제거 후 **내부 띄어쓰기 제거**
4. 쉼표로 분리하여 리스트로 변환
5. **순서**: 가공키워드 먼저, 그 다음 등록솔루션 키워드
6. 중복 제거 (순서 유지)
7. 쉼표로 다시 합치기

**키워드 정규화 함수**:
```python
def normalize_keyword(k):
    """키워드 정규화: 앞뒤 공백 제거 후 내부 띄어쓰기 제거"""
    return k.strip().replace(" ", "")
```

**예시**:
- 가공 엑셀: `"키워드1, 키워드 2, 키워드3"` → 정규화 후: `["키워드1", "키워드2", "키워드3"]`
- 등록 솔루션: `"키워드2, 키워드 4"` → 정규화 후: `["키워드2", "키워드4"]`
- 결과: `"키워드1,키워드2,키워드3,키워드4"` (중복 제거, 순서 유지, 띄어쓰기 제거)

#### 요약정보 매핑

| 이셀러스 컬럼 | 조건/값 | 비고 |
|--------------|---------|------|
| `요약정보 상품군 코드*` | **비어있는 경우**: `"35"` | 둘 중 하나라도 비어있으면 적용 |
| `요약정보 전항목 상세설명 참조` | **비어있는 경우**: `"Y"` | 둘 중 하나라도 비어있으면 적용 |
| `값1` ~ `값14` | `"상세설명별도표시"` | 고정값 |

**요약정보 처리 로직**:
```python
# 요약정보 상품군 코드* 또는 요약정보 전항목 상세설명 참조가 비어있는 경우
if (요약정보 상품군 코드* == "" or 요약정보 전항목 상세설명 참조 == ""):
    요약정보 상품군 코드* = "35"
    요약정보 전항목 상세설명 참조 = "Y"
    값1 = "상세설명별도표시"
    값2 = "상세설명별도표시"
    ...
    값14 = "상세설명별도표시"
```

---

### 3.3.3 기본 매핑 요약

**가공 엑셀 → 이셀러스 기본정보 시트**:

| 가공 엑셀 컬럼 | 이셀러스 컬럼 | 처리 방식 |
|---------------|--------------|----------|
| `상품코드` | `판매자 관리코드` | **핵심 식별자 매핑** |
| **파일명** | `폴더명` | 파일명 추출 (40byte 이내) |
| `ST4_최종결과` | `상품명*` | 직접 매핑 |
| `마켓판매가격` | `판매가*` | 직접 매핑 |
| `사용URL` | `목록 이미지*` | 직접 매핑 |
| `사용URL` | `이미지1(대표/기본이미지)*` | 직접 매핑 |
| (기존값) | `이미지2` | 목록 이미지 재사용 |
| (다팔자 로직) | `상세설명*` | HTML 생성 (상단 이미지+텍스트+하단 이미지) |
| (옵션가격조정) | `선택사항 상세정보` | 옵션금액 보정 후 형식 변환 |
| (공란) | `브랜드` | 빈 값 |
| `판매자 관리코드` | `모델명` | "edit" + 판매자 관리코드 |
| (고정값) | `제조사` | "onerclan OEM" |
| (고정값) | `홍보문구` | "모든카드 무이자 3개월!" |
| `search_keywords` + 기존값 | `검색어(태그)` | 합치기 + 중복 제거 |
| (조건부) | `요약정보 상품군 코드*` | 비어있으면 "35" |
| (조건부) | `요약정보 전항목 상세설명 참조` | 비어있으면 "Y" |
| (고정값) | `값1` ~ `값14` | "상세설명별도표시" |

---

### 3.3.4 다팔자와의 공통점

1. **상세설명 생성**: 동일한 HTML 생성 로직 (상단 이미지+텍스트+하단 이미지)
2. **옵션금액 보정**: 동일한 옵션가격조정 로직 적용 (`rules/option_price_correction.py`)
3. **검색어 처리**: 동일한 키워드 합치기 및 중복 제거 로직 (키워드 정규화 포함)
4. **제조사**: "onerclan OEM" 고정값
5. **상품명 매핑**: `ST4_최종결과` → `상품명*` (다팔자는 `상품명`)
6. **가격 매핑**: `마켓판매가격` → `판매가*` (다팔자는 `가격`)

---

### 3.3.5 이셀러스만의 특징

1. **2행 설명탭**: 데이터는 3행부터 시작
2. **폴더명 자동 입력**: 엑셀 파일명에서 추출 (40byte 이내, `_`와 `-` 문자 유지)
3. **이미지 구조**: 목록 이미지와 대표 이미지가 분리되어 있고, 이미지2는 목록 이미지 재사용
4. **모델명 자동 생성**: "edit" + 판매자 관리코드
5. **브랜드 공란 처리**: 브랜드를 빈 값으로 설정 (다팔자도 동일하지만 명시적)
6. **홍보문구 고정값**: "모든카드 무이자 3개월!"
7. **요약정보 자동 설정**: 비어있으면 기본값 자동 입력
8. **값1~값14 고정값**: "상세설명별도표시"
9. **옵션금액 보정**: 이셀러스 형식에 맞는 옵션금액 보정 (정수로 저장, 소수점 제거)
10. **2개 시트 저장**: 기본정보 시트와 확장정보 시트 모두 저장
11. **파일명 자동 생성**: "이셀완료" + 가공 엑셀 파일명
12. **마켓 감지**: 가공 엑셀 파일명에서 오픈마켓 자동 감지 (다팔자와 동일)

---

### 3.3.6 파일 저장 및 결과 처리

#### 파일 저장 규칙

**이셀러스 저장 방식**:
- **파일명**: `이셀완료` + 가공 엑셀 파일명
- **확장자**: 등록 솔루션 엑셀과 동일 (`.xls` 또는 `.xlsx`)
- **시트 구조**: 
  - `기본정보` 시트: 매핑된 결과 저장 (시트명 유지)
  - `확장정보` 시트: 원본 등록 솔루션 엑셀에서 가져와서 함께 저장
- **`.xls` 파일 처리**: `.xls` 형식은 `.xlsx`로 저장 (xlwt 복잡성으로 인해)

**예시**:
- 가공 엑셀: `20260113_스스A1-0_패션의류.xlsx`
- 등록 솔루션: `이셀러스양식.xls`
- 결과 파일: `이셀완료20260113_스스A1-0_패션의류.xlsx` (`.xls`는 `.xlsx`로 변환)

#### 매핑 결과 팝업

- 매핑 완료 후 결과 팝업 창 자동 표시
- 매핑 통계, 상품코드 매칭 통계, 컬럼별 매핑 결과 표시

---

### 3.3.7 마켓 감지 및 마켓별 처리

**마켓 감지**:
- 가공 엑셀 파일명에서 오픈마켓 자동 감지 (다팔자와 동일한 로직)
- 파일명 접두사 기반 감지 (스스, 쿠팡, 11번가, 옥션, 지마켓, 토스, 톡스토어 등)

**마켓별 확장정보 시트 처리**:

| 마켓 | 처리 방식 | 설명 |
|------|----------|------|
| **스스 (스마트스토어)** | `마켓 카테고리번호` 컬럼 필터링 | `스마트스토어*`로 시작하는 줄만 유지, 나머지 삭제 |
| **옥션** | 그대로 유지 | 변경 없음 |
| **지마켓** | 그대로 유지 | 변경 없음 |
| **쿠팡** | 그대로 유지 | 변경 없음 |
| **나머지 마켓** | 그대로 유지 | 변경 없음 |

**스마트스토어 처리 예시**:

**처리 전**:
```
스마트스토어*50003309
옥션*23240600
G마켓*300026939
```

**처리 후**:
```
스마트스토어*50003309
```

**옥션/지마켓 예시** (그대로 유지):
```
옥션*23240600
G마켓*300026939
ESM2.0*00370001000300030000*23240600
```

---

### 3.3.8 기본정보 시트 저장 형식

**행 구조**:
- **1행**: 헤더 (컬럼명)
- **2행**: 빈 행 (설명탭 역할)
- **3행부터**: 실제 데이터

**컬럼 처리**:
- **BY열 (Unnamed: 76)**: 빈 값으로 설정 (기본배송비값 컬럼 제거)

---

### 3.3.8 다팔자와 이셀러스 매핑 구조 차이점 비교

| 항목 | 다팔자 | 이셀러스 | 차이점 |
|------|--------|----------|--------|
| **식별자** | `상품코드` | `원본번호*` | 컬럼명 다름 |
| **상품명** | `상품명` | `상품명*` | 필수 표시(*) |
| **가격** | `가격` | `판매가*` | 컬럼명 다름, 필수 표시(*) |
| **대표 이미지** | `대표 이미지` (1개) | `이미지1(대표/기본이미지)*` (필수) | 컬럼명 다름, 필수 표시(*) |
| **목록 이미지** | `목록 이미지` (옵션, 일부 마켓만) | `목록 이미지*` (필수) | 필수 여부 다름 |
| **추가 이미지** | 없음 | `이미지2` ~ `이미지5` (옵션) | 이셀러스만 추가 이미지 지원 |
| **상세설명** | `상세정보` | `상세설명*` | 컬럼명 다름, 필수 표시(*) |
| **키워드/태그** | `키워드` | `검색어(태그)` | 컬럼명 다름 |
| **옵션** | `옵션` (단일 컬럼) | `선택사항 옵션명`, `선택사항 상세정보` (분리) | 이셀러스는 옵션이 분리됨 |
| **브랜드** | 빈 값으로 설정 | 빈 값으로 설정 | 동일 |
| **제조사** | "onerclan OEM" | "onerclan OEM" | 동일 |
| **모델명** | 없음 | "edit" + 판매자 관리코드 | 이셀러스만 자동 생성 |
| **홍보문구** | 없음 | "모든카드 무이자 3개월!" | 이셀러스만 고정값 |
| **요약정보** | 없음 | 조건부 자동 설정 | 이셀러스만 지원 |
| **값1~값14** | 없음 | "상세설명별도표시" | 이셀러스만 지원 |
| **폴더명** | 없음 | 파일명에서 추출 | 이셀러스만 지원 |
| **배송비 처리** | 마켓별 처리 (옥션/지마켓은 반품만) | 미정 (확장정보 시트에 있을 수 있음) | 이셀러스는 아직 미정 |
| **판매자 부담 할인** | 마켓별 매핑 지원 | 미정 | 이셀러스는 아직 미정 |

**주요 차이점 요약**:

1. **컬럼명 차이**: 이셀러스는 필수 컬럼에 `*` 표시, 컬럼명이 다름
2. **이미지 구조**: 이셀러스는 목록 이미지와 대표 이미지가 분리, 추가 이미지 지원
3. **옵션 구조**: 이셀러스는 옵션명과 상세정보가 분리된 컬럼
4. **추가 필드**: 이셀러스는 모델명, 홍보문구, 요약정보, 값1~값14 등 추가 필드 지원
5. **파일명 처리**: 이셀러스는 폴더명을 파일명에서 자동 추출
6. **시트 구조**: 이셀러스는 2개 시트 구조 (기본정보, 확장정보)

---

## 📝 4. 구현 시 고려사항

### 4.1 시트 처리

1. **기본정보 시트**: 메인 상품 정보 처리
2. **확장정보 시트**: 마켓별 특화 정보 처리
3. **연결 키**: `원본번호*`를 기준으로 두 시트 연결

### 4.2 마켓 감지

- 다팔자와 동일하게 파일명 접두사 기반 감지 가능
- 확장정보 시트의 마켓별 컬럼을 활용하여 마켓별 특화 처리

### 4.3 매핑 전략

1. **기본 매핑**: 가공 엑셀 → 기본정보 시트
2. **확장 매핑**: 가공 엑셀 → 확장정보 시트 (마켓별)
3. **연결**: `원본번호*` 기준으로 두 시트 동기화

---

## 🎯 5. 다음 단계

이셀러스 솔루션 구현 시 고려할 사항:

1. **BaseSolution 상속**: `solutions/base_solution.py` 기반으로 `solutions/esellers.py` 생성
2. **시트 처리 로직**: 기본정보와 확장정보 시트를 분리하여 처리
3. **마켓별 매핑 규칙**: 확장정보 시트의 마켓별 컬럼 활용
4. **연결 키 관리**: `원본번호*` 기준으로 두 시트 동기화
5. **이미지 처리**: 다팔자와 달리 목록 이미지가 필수, 대표 이미지와 추가 이미지 지원

---

## 📌 참고사항

- 이셀러스는 2개 시트 구조이므로 엑셀 파일 로드 시 두 시트를 모두 읽어야 함
- `원본번호*`는 기본정보와 확장정보를 연결하는 핵심 키
- 확장정보 시트의 마켓별 컬럼을 활용하여 마켓별 특화 처리 가능
- 기본정보 시트의 필수 컬럼(*)은 반드시 매핑되어야 함

