# prompts_stage1.py
"""
STAGE1 상품명 정제용 프롬프트 & 문자열 유틸

- 사용하는 엑셀 컬럼:
  - 카테고리명
  - 판매형태  (예: 단품형 / 옵션형)
  - 원본상품명

- 다른 파일에서는 다음 함수들만 import 해서 사용하면 됨:
  - from prompts_stage1 import STAGE1_PROMPT_TEMPLATE, safe_str, build_stage1_prompt
"""

from typing import Any
import pandas as pd


# =====================================
# STAGE1 프롬프트 템플릿 (사용자 확정 버전)
# =====================================
#기존 롱폼 버젼 251201
# STAGE1_PROMPT_TEMPLATE = """너는 전문 MD이자 온라인 쇼핑몰 *위탁판매*용 상품명 정제 전문가다.  
# 네 임무는 공급처에서 온 “원본 상품명”을 깔끔하고 정보 중심의 “정제된 상품명”으로 바꾸는 것이다.

# [메타 규칙 – 내부 점검]
# 1. 답변을 만들기 전에 스스로 다음 기준으로 결과물을 점검한다.
#    - 정보 정확성: 원본에 있는 정보만 사용하고, 추측 정보(브랜드/용량/재질/기능 등)를 새로 만들지 않는다.
#    - 구조: 가능한 한 다음 순서를 우선 고려한다.  
#      → 핵심 제품군/타입 > 핵심 기능·효과/사용상황 > 규격·용량/세트·수량 > 사용대상·스타일/핏 > 시즌·테마 > 색상/옵션(필요 시)
#    - 간결성: 최대 60자 이내, 의미 없는 수식어·중복 단어·광고 문구·불필요한 기호 제거.
#    - 일관성: 동일 유형의 정보는 유사한 표현과 순서를 유지한다(예: “크리스마스 파티 가랜드 레터 산타 장식 소품”처럼).
# 2. 위 기준에 스스로 “만점”이라 판단될 때까지 내부적으로만 여러 번 다듬은 뒤,
#    사용자에게는 최종 완성된 한 줄만 출력한다.
#    내부 검토 과정·초안·자기평가는 어떤 형식으로도 출력하지 않는다.

# [역할]
# - 너는 “상품명 정제”만 담당한다.
# - 원본 상품명과 카테고리명을 함께 참고하여, 온라인 위탁판매용으로 적합한 정보 중심 상품명을 만들어야 한다.
# - 이 단계의 상품명은 “최종 노출용”이 아니라, 이후 단계(Stage 2, 3)에서 참고할 **정제 버전**이라는 점을 기억한다.

# [위탁판매 특이 규칙]
# - 브랜드 경쟁력이 없으므로, 일반적인 브랜드명/샵명은 상품명에서 제거한다.
#   - 예: 나이키, 아디다스, ○○샵, ○○몰, 엘리스, ○○마켓 등은 모두 제거.
#   - 단, “피치기모, 쿠션폼, 수제, 핸드메이드, DIY”처럼 **기능·재질·특성을 나타내는 단어**는 브랜드가 아니라 속성으로 보고 유지한다.
# - “/”, “·”, “,” 같은 기호는 되도록 사용하지 말고, 띄어쓰기로 대체한다.
#   - 예: “텀블러/컵홀더” → “텀블러 컵홀더”

# [추가 메타 정보]
# - 이 상품의 판매형태는 "{sale_type}" 이다.
#   - "단품형"이면 옵션 없이 1개 구성,
#   - "옵션형"이면 색상/사이즈/타입 등 여러 옵션 중 선택하는 구조이다.
# - 이 정보는 참고용일 뿐, 상품명 안에 억지로 "단품형/옵션형" 같은 단어를 넣을 필요는 없다.

# [최종 목표]
# - 과장 표현 없이, 검색과 노출에 도움이 되는 “정보 위주 상품명”을 작성한다.
# - 브랜드·상점 정보와 광고 문구는 제거하고, 제품의 정체(무엇인지)와 기능·상황·스펙 중심으로 정리한다.
# - 최종 출력은 “정제된 상품명 한 줄”만 남도록 한다.

# [작업 순서]

# 1단계. 원본 이해
# - 아래에 주어진 "카테고리명"과 "원본 상품명"을 함께 보고 카테고리/제품군을 먼저 파악한다.
# - 다음 “핵심 정보”를 머릿속에 정리한다.
#   - 핵심 제품군/타입 (예: 러닝화, 가랜드, 나노블럭, 선물주머니, 방한모자, 스노우체인, 쿠션폼벽지 등)
#   - 핵심 기능·효과 또는 사용상황 (예: 방한, 단열, 곰팡이방지, 무소음, 안벗겨짐, 비상용, 캠핑용 등)
#   - 규격/사이즈/용량/수량 (예: 12L, 50cm x 2.5m, 100개입 등)
#   - 사용대상/핏/스타일 (예: 남성 세미일자, 여성 덧신, 수험생 시계, 캠핑용 하드쿨러 등)
#   - 필요한 경우 색상/옵션, 시즌·테마 (겨울용, 크리스마스, 수능 등)

# 2단계. 노이즈(광고/상점/브랜드 정보) 제거
# - 아래와 같은 광고성 표현 및 상점 관련 정보는 전부 제거한다.
#   - 예시 광고 문구:
#     “무료배송”, “당일배송”, “오늘출발”, “행사”, “인기”, “강력추천”, “최저가”, “빅세일”, “특가”, “인싸템”, “MD추천”, “한정수량”, “국민템”, “핫딜” 등
#   - 이모티콘/기호:
#     “♥”, “★”, “♬”, “※”, “!!”, “??” 등
#   - 상점·몰 이름:
#     “○○몰”, “○○샵”, “○○스토어”, “공식몰”, “전문몰”, “직영몰” 등
#   - 일반적인 브랜드명:
#     나이키, 아디다스, ○○마켓, ○○브랜드 등 위탁판매자가 경쟁 우위를 갖지 못하는 브랜드명
#   - 연락처·홍보:
#     전화번호, 카카오톡 ID, URL, SNS 아이디 등
# - 위 예시는 참고용이며, 이와 유사한 모든 광고성·홍보성·브랜드 문구도 함께 제거한다.

# 3단계. 괄호·기호 정리
# - 괄호는 필요한 최소 개수만 사용한다.
# - 의미 있는 정보는 살리고, 괄호 기호만 정리한다.
#   - 예: “(블루)” → “블루”, “(레터산타)” → “레터 산타”
# - 이중 괄호·불필요한 괄호·빈 괄호는 제거한다.
#   - 예: “(( ))”, “()” 등은 삭제.
# - “/”, “·”, “,” 등 기호는 되도록 사용하지 말고, 단순한 띄어쓰기로 바꾼다.

# 4단계. 핵심 정보 유지 & 구조화
# - 반드시 유지해야 할 정보:
#   - 핵심 제품군/타입 (예: 러닝화, 가랜드, 나노블럭, 선물주머니, 방한모자, 스노우체인, 쿠션폼벽지 등)
#   - 핵심 기능·효과/사용상황 (예: 방한용, 단열용, 곰팡이방지용, 무소음 시험용, 비상용, 캠핑용 등)
#   - 규격·용량/세트·수량 (예: 12L, 100개입, 50cm x 2.5m, 4P 세트 등)
#   - 사용대상·스타일/핏 (예: 남성 세미일자, 여성 페이크삭스, 수험생용, 캠핑·아웃도어용 등)
#   - 필요한 경우 색상·옵션, 시즌·테마
# - 의미 없는 중복 단어와 모호한 수식어는 줄인다.
# - 핵심 키워드 위주로 자연스럽고 일관된 순서로 재배치한다.
#   - 예:
#     원본: “크리스마스파티가랜드(레터산타) 파티용품 장식 소품”  
#     정제: “크리스마스 파티 가랜드 레터 산타 장식 소품”

# 5단계. 위험한 변조 금지
# - 실제 원본에 없는 정보를 새로 만들어내지 않는다.
#   - 재질, 용량, 기능, 인증 정보를 추측으로 추가하면 안 된다.
# - 숫자, 모델명, 용량, 사이즈는 원본에 있는 그대로 사용한다.
# - 한글/영문 표기는 원본을 존중하되, 불필요한 반복이나 어색한 표기는 정돈한다.
#   - 예: “X-mas”와 “크리스마스”가 함께 있으면, 상황에 맞게 한 형태로만 통일.

# 6단계. 길이 및 형식 제한
# - 정제된 상품명은 “최대 60자 이내”로 작성한다.
# - 60자를 초과하면, 중요도가 낮은 수식어부터 순서대로 제거해 60자 이내로 줄인다.
# - 문장이 아니라 “상품명 형태”로 작성한다.
#   - “~입니다”, “~해요”, “어떠세요?” 같은 문장형 표현은 사용하지 않는다.
# - 이모티콘, 과장된 느낌표, 의미 없는 기호는 모두 제거한다.

# 7단계. 입력 & 출력 형식
# - 아래 입력 정보를 참고해 상품명을 정제한다.
# - 출력 규칙:
#   - 오직 “정제된 상품명 한 줄”만 출력한다.
#   - 따옴표(“ ”, ' ')로 감싸지 않는다.
#   - “정제된 상품명: …” 같은 라벨·설명 문구를 붙이지 않는다.
#   - 단계 설명, 이유, 해설, 메모, 추가 문장은 절대 쓰지 않는다.

# [입력 정보]
# - 카테고리명: {category}
# - 판매형태: {sale_type}
# - 원본 상품명: {raw_name}

# 이제 위 규칙을 적용하여 아래 원본 상품명을 정제하라.
# 정제할 상품명 : "{raw_name}"
# """

# 신규 숏폼버전 251201
STAGE1_PROMPT_TEMPLATE = """
당신은 온라인 쇼핑몰 위탁판매용 상품명 정제 전문가입니다.
입력된 정보를 바탕으로 광고와 브랜드 거품을 제거하고, 검색에 강한 정보 중심 상품명 한 줄을 작성하십시오.
최종 출력 전에 아래 규칙을 모두 만족하는지 스스로 점검하되, 점검 과정이나 이유는 출력하지 마십시오.

[입력 정보]
- 카테고리명: {category}
- 판매형태: {sale_type}  (참고용 메타 정보이며, 결과 상품명에 그대로 쓰지 말 것)
- 원본 상품명: {raw_name}

[정제 규칙]

1. 구조 재배열 (우선순위)
- 권장 순서: [핵심 제품군] > [기능/사용상황] > [규격/수량] > [대상/스타일] > [시즌/테마] > [옵션/색상]
- 문장이 아닌 명사형 키워드 나열로 작성합니다.
- 전체 길이는 띄어쓰기 포함 최대 60자로 맞추고,
  초과 시 중요도가 낮은 수식어부터 제거하여 60자 이내로 줄입니다.

2. 노이즈 및 브랜드 제거
- 삭제 대상:
  · 광고·홍보 문구: 무료배송, 당일배송, 오늘출발, 특가, 행사, 인기, 추천,
    최저가, 빅세일, 주문폭주, 인싸템, 핫딜, MD추천, 한정수량, 국민템 등
  · 상점/몰/마켓명: ○○몰, ○○샵, ○○스토어, ○○마켓, 공식몰, 전문몰, 직영몰 등
  · 일반 브랜드명: 나이키, 아디다스 등 위탁판매자가 경쟁우위를 갖지 못하는 브랜드명
  · 이모티콘·과한 기호(♥, ★, !!, [], /, ·, , 등)
- 괄호는 꼭 필요한 규격/옵션 표기에만 최소한으로 사용하고,
  불필요한 괄호나 빈 괄호는 제거합니다.
- 유지 대상:
  피치기모, 쿠션폼, 수제, 핸드메이드, DIY, 호환용 등 재질·특성을 나타내는 단어는
  브랜드가 아니라 속성이므로 유지합니다.

3. 정보 정확성
- 원본에 없는 정보(재질, 기능, 용량, 인증, 브랜드 등)를 추측하여 만들지 않습니다.
- 숫자, 모델명, 사이즈, 용량 등은 원본에 나온 값만 사용하며,
  임의로 바꾸거나 새로 추가하지 않습니다.
- 한글/영문 표기는 원본을 존중하되,
  불필요한 반복이나 어색한 표기는 자연스럽게 정돈합니다.

4. 스타일 제약
- “~입니다”, “~해요”, “어떠세요?” 같은 문장형 표현을 사용하지 않습니다.
- “상품명:”, “정제된 상품명:” 같은 라벨이나 설명 문구를 붙이지 않습니다.
- 이모티콘, 과장된 느낌표, 의미 없는 기호는 모두 제거합니다.

[출력 형식]
위 규칙을 엄수하여, 정제된 상품명 텍스트 **한 줄만** 출력하십시오.
"""
# =====================================
# 유틸 함수
# =====================================

def safe_str(v: Any) -> str:
    """
    NaN / None 안전하게 문자열로 변환 + strip
    """
    if v is None:
        return ""
    try:
        if pd.isna(v):
            return ""
    except Exception:
        pass
    return str(v).strip()


def build_stage1_prompt(category: str, sale_type: str, raw_name: str) -> str:
    """
    엑셀에서 읽어온 카테고리명 / 판매형태 / 원본상품명으로
    최종 STAGE1 프롬프트 한 덩어리를 만들어 반환.
    """
    return STAGE1_PROMPT_TEMPLATE.format(
        category=safe_str(category) or "(카테고리 없음)",
        sale_type=safe_str(sale_type) or "(판매형태 미지정)",
        raw_name=safe_str(raw_name) or "(원본 상품명 없음)",
    )
