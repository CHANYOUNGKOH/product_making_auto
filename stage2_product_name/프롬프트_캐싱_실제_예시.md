# Stage2 프롬프트 캐싱 실제 예시

## 실제 배치 Output 결과 분석

### 요청 1: row-347 (캐싱 없음)

**Output 결과:**
```json
{
  "custom_id": "row-347",
  "response": {
    "body": {
      "usage": {
        "input_tokens": 6246,
        "input_tokens_details": {
          "cached_tokens": 0  // ❌ 캐싱 없음
        }
      }
    }
  }
}
```

**실제 요청 구조 (재구성):**

```json
{
  "model": "gpt-5-mini-2025-08-07",
  "input": [
    {
      "role": "system",
      "content": [
        {
          "type": "input_text",
          "text": "당신은 온라인 쇼핑몰 *위탁판매* 상품을 위한\n\"Stage 2: 상세정보·키워드·네이밍 재료 추출기\"입니다.\n입력 텍스트와 상세이미지 정보를 분석해, Stage 3에서 최종 상품명을 만들 때 사용할 구조화 JSON을 생성하십시오.\n\n[역할 및 제약]\n1) 이 단계에서는 **최종 상품명/제목/타이틀을 절대 생성하지 않는다.**\n   - \"상품명:\", \"추천 제목:\" 같은 필드는 만들지 말 것.\n   - 오직 **정보 추출 + 검색 키워드 + 네이밍 재료**만 생성한다.\n2) 위탁판매 특성\n   - 브랜드명, 쇼핑몰명, 제조사명, 로고/워터마크에 보이는 이름은 모두 무시한다.\n3) meta Passthrough\n   - 출력 JSON의 meta는 user가 제공한 meta(JSON)의 키/값을 **완전히 동일하게** 그대로 복사한다(공백/특수문자 포함, 수정 금지).\n   - meta 필드의 값은 절대 변경, 해석, 정규화하지 말고 입력값 그대로 출력해야 한다.\n4) 사실 기반 추출\n   - 상세설명 텍스트와 이미지에 **명시된 재질·사이즈·구성·기능**만 쓴다.\n   - 보이지 않는 정보는 **추측하지 않는다**.\n     · 숫자 필드: 정보 없으면 null\n     · 문자열 필드: 정보 없으면 \"\" (빈 문자열)\n5) JSON 출력 규칙\n   - 아래 스키마를 따른 **단일 JSON 객체 한 개만** 출력한다.\n   - JSON 앞뒤에 설명, 자연어 문장, 마크다운 코드블록(````json 등)은 붙이지 않는다.\n\n[출력 스키마]\n\n{\n  \"meta\": {\n    \"기본상품명\": \"\",\n    \"판매형태\": \"\",\n    \"옵션_원본\": \"\",\n    \"카테고리_경로\": \"\"\n  },\n  \"core_attributes\": {\n    \"상품타입\": \"이 상품을 한 줄로 정의하는 핵심 타입. 예: 데일리 곱창 헤어밴드, 아크릴 탁상 사진 액자, 캠핑용 하드쿨러 아이스박스\",\n    \"상위카테고리\": \"카테고리_경로를 1~2단어로 축약. 예: 헤어악세사리, 인테리어소품, 캠핑용품\",\n    ... (스키마 전체)\n  }\n}\n\n반드시 위 JSON 스키마를 따르는 **단일 JSON 객체만** 응답하십시오."
        }
      ]
    },
    {
      "role": "user",
      "content": [
        {
          "type": "input_text",
          "text": "[입력 데이터]\n\n1) meta 정보 (JSON)\n{\"기본상품명\": \"아동 캐주얼 티셔츠\", \"판매형태\": \"옵션형\", \"옵션_원본\": \"블랙_5호,화이트_7호\", \"카테고리_경로\": \"출산/육아>유아동의류>티셔츠\"}\n\n2) 참고 텍스트\n   - 원본 상품명: 아동 캐주얼 티셔츠\n   - Stage1 정제상품명: 아동 반팔 티셔츠\n   - 키워드: 없음\n\n※ 상세이미지는 첨부된 이미지를 참고하세요."
        },
        {
          "type": "input_image",
          "image_url": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ..."
        },
        {
          "type": "input_image",
          "image_url": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ..."
        }
      ]
    }
  ],
  "prompt_cache_key": "stage2_v2_b26"
}
```

**토큰 분해 (추정):**
```
System 프롬프트:  ~1,200 토큰 (이전 버전, 1024 미만 가능성)
User 텍스트:     ~200 토큰
이미지 1:        ~2,400 토큰
이미지 2:        ~2,446 토큰
────────────────────────────
총합:           6,246 토큰
캐시:           0 토큰 (캐싱 안 됨)
```

---

### 요청 2: row-348 (캐싱 발생!)

**Output 결과:**
```json
{
  "custom_id": "row-348",
  "response": {
    "body": {
      "usage": {
        "input_tokens": 4668,
        "input_tokens_details": {
          "cached_tokens": 1536  // ✅ 캐싱 발생!
        }
      }
    }
  }
}
```

**실제 요청 구조 (재구성):**

```json
{
  "model": "gpt-5-mini-2025-08-07",
  "input": [
    {
      "role": "system",
      "content": [
        {
          "type": "input_text",
          "text": "[동일한 System 프롬프트 - 요청 1과 완전히 동일]"
        }
      ]
    },
    {
      "role": "user",
      "content": [
        {
          "type": "input_text",
          "text": "[입력 데이터]\n\n1) meta 정보 (JSON)\n{\"기본상품명\": \"트랜스로보카(3개)\", \"판매형태\": \"단품형\", \"옵션_원본\": \"\", \"카테고리_경로\": \"출산/육아>완구/매트>작동완구>로봇\"}\n\n2) 참고 텍스트\n   - 원본 상품명: 트랜스로보카(3개)\n   - Stage1 정제상품명: 트랜스로보카 3개\n   - 키워드: 없음\n\n※ 상세이미지는 첨부된 이미지를 참고하세요."
        },
        {
          "type": "input_image",
          "image_url": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ..."  // 다른 이미지
        },
        {
          "type": "input_image",
          "image_url": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ..."  // 다른 이미지
        }
      ]
    }
  ],
  "prompt_cache_key": "stage2_v2_b23"  // 다른 버킷
}
```

**토큰 분해 (추정):**
```
System 프롬프트:  ~1,536 토큰 (✅ 캐시에서 가져옴, 비용 0)
User 텍스트:     ~200 토큰
이미지 1:        ~1,466 토큰
이미지 2:        ~1,466 토큰
────────────────────────────
총합:           4,668 토큰
캐시:           1,536 토큰 (System 프롬프트)
실제 과금:      3,132 토큰만 과금
```

**비용 절감:**
- System 프롬프트 1,536 토큰이 캐시에서 가져와서 **비용이 0**
- 실제 과금: 3,132 토큰만 과금 (33% 절감)

---

## 이전 vs 현재 비교

### 이전 버전 (캐싱 제한적)

**System 프롬프트 예시 (간략화):**
```
당신은 온라인 쇼핑몰 *위탁판매* 상품을 위한
"Stage 2: 상세정보·키워드·네이밍 재료 추출기"입니다.

[역할 및 제약]
1) 이 단계에서는 **최종 상품명/제목/타이틀을 절대 생성하지 않는다.**
2) 위탁판매 특성
3) meta Passthrough
4) 사실 기반 추출
5) JSON 출력 규칙

[출력 스키마]
{...}

반드시 위 JSON 스키마를 따르는 **단일 JSON 객체만** 응답하십시오.
```

**토큰 수:** 약 1,000-1,200 토큰 (1024 미만 가능성)

**캐싱 결과:**
- 95개 요청 중 3개만 캐싱 (3.2%)
- 대부분 `cached_tokens: 0`

---

### 현재 버전 (캐싱 최적화)

**System 프롬프트 예시 (간략화):**
```
당신은 온라인 쇼핑몰 *위탁판매* 상품을 위한
"Stage 2: 상세정보·키워드·네이밍 재료 추출기"입니다.

[역할 및 제약]
1) 이 단계에서는 **최종 상품명/제목/타이틀을 절대 생성하지 않는다.**
   - "상품명:", "추천 제목:", "제목:", "타이틀:" 같은 필드는 만들지 말 것.
   - 오직 **정보 추출 + 검색 키워드 + 네이밍 재료**만 생성한다.
   - Stage 3에서 이 정보를 바탕으로 최종 상품명을 만들 것이므로, 여기서는 재료만 준비한다.
2) 위탁판매 특성
   - 브랜드명, 쇼핑몰명, 제조사명, 로고/워터마크에 보이는 이름은 모두 무시한다.
   - 예: "나이키", "아디다스", "○○몰", "○○샵", "○○스토어" 등은 추출하지 않는다.
   - 위탁판매자는 브랜드명으로 경쟁우위를 갖지 못하므로 브랜드 정보는 불필요하다.
3) meta Passthrough (중요: 완전 동일 복사)
   - 출력 JSON의 meta는 user가 제공한 meta(JSON)의 키/값을 **완전히 동일하게** 그대로 복사한다.
   - 공백, 특수문자, 대소문자, 줄바꿈 등 모든 것을 수정하지 말고 입력값 그대로 출력해야 한다.
   - 예: 입력이 "블랙_5호"이면 "블랙 5호"로 바꾸지 말고 "블랙_5호" 그대로 출력.
   - 예: 입력이 "옵션형  " (뒤에 공백)이면 공백까지 그대로 유지.
4) 사실 기반 추출 (추측 금지)
   - 상세설명 텍스트와 이미지에 **명시된 재질·사이즈·구성·기능**만 쓴다.
   - 보이지 않는 정보는 **추측하지 않는다**.
   - 텍스트나 이미지에 나오지 않은 정보는 생성하지 않는다.
   - 숫자 필드: 정보 없으면 null (0이나 빈 문자열이 아님)
   - 문자열 필드: 정보 없으면 "" (빈 문자열, null이 아님)
   - 배열 필드: 정보 없으면 [] (빈 배열)
5) JSON 출력 규칙
   - 아래 스키마를 따른 **단일 JSON 객체 한 개만** 출력한다.
   - JSON 앞뒤에 설명, 자연어 문장, 마크다운 코드블록(````json 등)은 붙이지 않는다.
   - JSON만 출력하고, "다음은 JSON입니다" 같은 설명 문구는 절대 추가하지 않는다.

[출력 스키마 상세 설명]
{...}

[출력 예시 형식 (학습용)]

올바른 출력 예시:
{
  "meta": {
    "기본상품명": "아동 캐주얼 티셔츠",
    "판매형태": "옵션형",
    "옵션_원본": "블랙_5호,화이트_7호",
    "카테고리_경로": "출산/육아>유아동의류>티셔츠"
  },
  "core_attributes": {
    "상품타입": "어린이 데일리 반팔 티셔츠",
    ...
  },
  ...
}

잘못된 출력 예시 (피해야 할 것):
- "상품명: 어린이 티셔츠" 같은 필드 추가 (X)
- meta 값을 "옵션형" → "옵션 형"으로 정리 (X)
- 이미지에 없는 재질을 추측하여 추가 (X)
- JSON 외에 설명 문구 추가 (X)

반드시 위 JSON 스키마를 따르는 **단일 JSON 객체만** 응답하십시오.
```

**토큰 수:** 약 1,500-1,800 토큰 (1024 이상 확보)

**예상 캐싱 결과:**
- 대부분의 요청에서 캐싱 발생 예상
- `cached_tokens` 값이 1,500-1,800 범위로 나타날 것

---

## 시각적 비교

### 이전 버전 요청 구조

```
┌─────────────────────────────────────────┐
│ System 프롬프트 (약 1,200 토큰)          │
│ - 역할 및 제약: 200 토큰                 │
│ - 출력 스키마: 600 토큰                  │
│ - 기타 설명: 200-400 토큰                │
│ ❌ 1024 미만 가능성 → 캐싱 안 됨        │
└─────────────────────────────────────────┘
           ↓
┌─────────────────────────────────────────┐
│ User 프롬프트 (동적)                    │
│ - meta JSON: 50 토큰                    │
│ - 참고 텍스트: 150 토큰                  │
│ - 이미지 1: ~2,400 토큰                 │
│ - 이미지 2: ~2,446 토큰                 │
│ ❌ 캐싱 불가                             │
└─────────────────────────────────────────┘
총합: 6,246 토큰
캐시: 0 토큰
```

### 현재 버전 요청 구조

```
┌─────────────────────────────────────────┐
│ System 프롬프트 (약 1,600 토큰)          │
│ - 역할 및 제약: 300 토큰 (상세화)        │
│ - 출력 스키마: 800 토큰 (예시 추가)      │
│ - 출력 예시 형식: 500 토큰 (신규)        │
│ ✅ 1024 이상 → 캐싱 가능                 │
└─────────────────────────────────────────┘
           ↓
┌─────────────────────────────────────────┐
│ User 프롬프트 (동적)                    │
│ - meta JSON: 50 토큰                    │
│ - 참고 텍스트: 150 토큰                  │
│ - 이미지 1: ~1,466 토큰                  │
│ - 이미지 2: ~1,466 토큰                 │
│ ❌ 캐싱 불가                             │
└─────────────────────────────────────────┘
총합: 4,668 토큰
캐시: 1,536 토큰 (System 프롬프트)
실제 과금: 3,132 토큰
```

---

## 핵심 포인트

1. **System 프롬프트 = 정적, 캐싱 가능**
   - 모든 요청에서 동일
   - 1024 토큰 이상이어야 캐싱 활성화
   - 캐시에서 가져오면 비용 0

2. **User 프롬프트 = 동적, 캐싱 불가**
   - 각 상품마다 다른 데이터
   - 이미지 데이터 포함
   - 항상 새로 처리됨

3. **캐싱 효과**
   - System 프롬프트가 캐시되면 비용 절감
   - 예: 1,536 토큰 캐싱 → 33% 비용 절감

4. **현재 개선사항**
   - System 프롬프트를 1024 토큰 이상으로 확장
   - 예시와 가이드 추가로 품질 향상
   - 캐싱 비율 향상으로 비용 절감 기대
