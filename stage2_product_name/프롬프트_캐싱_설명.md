# Stage2 배치 API 프롬프트 캐싱 작동 원리

## 📋 목차
1. [프롬프트 구조 (System/User 분리)](#1-프롬프트-구조-systemuser-분리)
2. [실제 배치 Output 결과 분석](#2-실제-배치-output-결과-분석)
3. [이전 vs 현재 비교](#3-이전-vs-현재-비교)
4. [프롬프트 캐싱이 작동하는 조건](#4-프롬프트-캐싱이-작동하는-조건)

---

## 1. 프롬프트 구조 (System/User 분리)

### 1.1 전체 요청 구조

```json
{
  "model": "gpt-5-mini-2025-08-07",
  "input": [
    {
      "role": "system",
      "content": [
        {
          "type": "input_text",
          "text": "[SYSTEM_PROMPT - 모든 요청에서 동일]"
        }
      ]
    },
    {
      "role": "user",
      "content": [
        {
          "type": "input_text",
          "text": "[USER_PROMPT - 각 상품마다 다름]"
        },
        {
          "type": "input_image",
          "image_url": "data:image/jpeg;base64,..."
        },
        {
          "type": "input_image",
          "image_url": "data:image/jpeg;base64,..."
        }
      ]
    }
  ],
  "prompt_cache_key": "stage2_v2_b26"
}
```

### 1.2 System 프롬프트 (정적, 캐싱 대상)

**특징:**
- ✅ **모든 요청에서 완전히 동일**
- ✅ **1024 토큰 이상이어야 캐싱 활성화**
- ✅ **역할 정의, 제약사항, 출력 스키마 포함**

**예시 (간략화):**
```
당신은 온라인 쇼핑몰 *위탁판매* 상품을 위한
"Stage 2: 상세정보·키워드·네이밍 재료 추출기"입니다.

[역할 및 제약]
1) 이 단계에서는 **최종 상품명/제목/타이틀을 절대 생성하지 않는다.**
2) 위탁판매 특성: 브랜드명, 쇼핑몰명 무시
3) meta Passthrough: user가 제공한 meta를 완전히 동일하게 복사
4) 사실 기반 추출: 추측 금지
5) JSON 출력 규칙

[출력 스키마]
{
  "meta": {...},
  "core_attributes": {...},
  "usage_scenarios": [...],
  "search_keywords": [...],
  "naming_seeds": {...}
}

[출력 예시 형식]
...
```

**토큰 수:**
- 이전 버전: 약 1,000-1,200 토큰 (1024 미만 가능성)
- 현재 버전: 약 1,500-1,800 토큰 (1024 이상 확보)

### 1.3 User 프롬프트 (동적, 캐싱 불가)

**특징:**
- ❌ **각 상품마다 내용이 다름**
- ❌ **이미지 데이터 포함 (매번 다름)**
- ❌ **캐싱되지 않음**

**예시 (상품 A):**
```
[입력 데이터]

1) meta 정보 (JSON)
{
  "기본상품명": "아동 캐주얼 티셔츠",
  "판매형태": "옵션형",
  "옵션_원본": "블랙_5호,화이트_7호",
  "카테고리_경로": "출산/육아>유아동의류>티셔츠"
}

2) 참고 텍스트
   - 원본 상품명: 아동 캐주얼 티셔츠
   - Stage1 정제상품명: 아동 반팔 티셔츠
   - 키워드: 없음

※ 상세이미지는 첨부된 이미지를 참고하세요.
```

**예시 (상품 B - 다른 상품):**
```
[입력 데이터]

1) meta 정보 (JSON)
{
  "기본상품명": "트랜스로보카(3개)",
  "판매형태": "단품형",
  "옵션_원본": "",
  "카테고리_경로": "출산/육아>완구/매트>작동완구>로봇"
}

2) 참고 텍스트
   - 원본 상품명: 트랜스로보카(3개)
   - Stage1 정제상품명: 트랜스로보카 3개
   - 키워드: 없음

※ 상세이미지는 첨부된 이미지를 참고하세요.
```

---

## 2. 실제 배치 Output 결과 분석

### 2.1 요청 1 (캐싱 없음)

```json
{
  "custom_id": "row-347",
  "response": {
    "body": {
      "usage": {
        "input_tokens": 6246,
        "input_tokens_details": {
          "cached_tokens": 0  // ❌ 캐싱 없음
        },
        "output_tokens": 3467
      }
    }
  }
}
```

**분해:**
- **System 프롬프트**: 약 1,200 토큰 (이전 버전, 1024 미만 가능성)
- **User 프롬프트**: 약 200 토큰
- **이미지 데이터**: 약 4,846 토큰 (이미지는 캐싱 안 됨)
- **총합**: 6,246 토큰

**왜 캐싱이 안 되었나?**
- System 프롬프트가 1024 토큰 미만이었을 가능성
- 또는 첫 요청이라 캐시가 아직 생성되지 않음

### 2.2 요청 2 (캐싱 발생!)

```json
{
  "custom_id": "row-348",
  "response": {
    "body": {
      "usage": {
        "input_tokens": 4668,
        "input_tokens_details": {
          "cached_tokens": 1536  // ✅ 캐싱 발생!
        },
        "output_tokens": 3629
      }
    }
  }
}
```

**분해:**
- **System 프롬프트**: 약 1,536 토큰 (캐시에서 가져옴, 비용 0)
- **User 프롬프트**: 약 200 토큰
- **이미지 데이터**: 약 2,932 토큰
- **총합**: 4,668 토큰

**왜 캐싱이 되었나?**
- System 프롬프트가 1024 토큰 이상
- 이전 요청과 동일한 System 프롬프트 사용
- OpenAI가 System 프롬프트를 캐시에 저장하고 재사용

**비용 절감:**
- System 프롬프트 1,536 토큰이 캐시에서 가져와서 **비용이 0**
- 실제 과금: User 프롬프트(200) + 이미지(2,932) = 3,132 토큰만 과금

---

## 3. 이전 vs 현재 비교

### 3.1 이전 버전 (캐싱 제한적)

**System 프롬프트 길이:**
```
약 1,000-1,200 토큰
- 역할 및 제약: 200 토큰
- 출력 스키마: 600 토큰
- 기타 설명: 200-400 토큰
```

**문제점:**
- ❌ 1024 토큰 기준을 충족하지 못할 수 있음
- ❌ 예시가 부족하여 모델이 헷갈릴 수 있음
- ❌ meta Passthrough 규칙이 명확하지 않음

**캐싱 결과:**
- 95개 요청 중 3개만 캐싱 발생 (3.2%)
- 대부분 `cached_tokens: 0`

### 3.2 현재 버전 (캐싱 최적화)

**System 프롬프트 길이:**
```
약 1,500-1,800 토큰
- 역할 및 제약: 300 토큰 (상세화)
- 출력 스키마: 800 토큰 (예시 추가)
- 출력 예시 형식: 400-700 토큰 (신규 추가)
```

**개선사항:**
- ✅ 1024 토큰 기준 확실히 충족
- ✅ 올바른/잘못된 출력 예시 추가
- ✅ meta Passthrough 규칙 강화
- ✅ 각 필드별 상세 설명 추가

**예상 캐싱 결과:**
- 대부분의 요청에서 캐싱 발생 예상
- `cached_tokens` 값이 1,500-1,800 범위로 나타날 것

---

## 4. 프롬프트 캐싱이 작동하는 조건

### 4.1 필수 조건

1. **System 프롬프트가 1024 토큰 이상**
   ```
   ✅ 현재: 약 1,500-1,800 토큰
   ```

2. **System 프롬프트가 모든 요청에서 동일**
   ```
   ✅ 현재: STAGE2_SYSTEM_PROMPT로 고정
   ```

3. **prompt_cache_key가 동일**
   ```
   ✅ 현재: "stage2_v2_b{버킷번호}" 형식
   - 같은 버킷 내에서는 동일한 키 사용
   ```

4. **모델이 프롬프트 캐싱 지원**
   ```
   ✅ gpt-5-mini: 지원
   ```

### 4.2 캐싱이 안 되는 부분

1. **User 프롬프트**
   - 각 상품마다 다른 데이터 (meta, 상품명 등)
   - 항상 새로 처리됨

2. **이미지 데이터**
   - 각 상품마다 다른 이미지
   - 항상 새로 처리됨

### 4.3 실제 비용 절감 효과

**예시: 100개 요청 처리 시**

**이전 (캐싱 3%):**
```
- System 프롬프트: 1,200 토큰 × 100 = 120,000 토큰 (전체 과금)
- User + 이미지: 평균 3,000 토큰 × 100 = 300,000 토큰
- 총합: 420,000 토큰 과금
```

**현재 (캐싱 90% 가정):**
```
- System 프롬프트: 1,600 토큰 × 10 = 16,000 토큰 (10%만 과금)
- User + 이미지: 평균 3,000 토큰 × 100 = 300,000 토큰
- 총합: 316,000 토큰 과금
- 절감: 104,000 토큰 (약 25% 절감)
```

---

## 5. 요약

### 5.1 프롬프트 구조

```
┌─────────────────────────────────────┐
│  System 프롬프트 (정적)              │
│  - 모든 요청에서 동일                │
│  - 1024 토큰 이상                    │
│  - ✅ 캐싱 가능                      │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  User 프롬프트 (동적)                │
│  - 각 상품마다 다름                  │
│  - 이미지 데이터 포함                │
│  - ❌ 캐싱 불가                      │
└─────────────────────────────────────┘
```

### 5.2 캐싱 작동 원리

1. **첫 요청**: System 프롬프트를 처리하고 캐시에 저장
2. **두 번째 요청**: System 프롬프트가 동일하면 캐시에서 가져옴
3. **비용**: 캐시된 토큰은 과금되지 않음

### 5.3 현재 개선사항

- ✅ System 프롬프트를 1024 토큰 이상으로 확장
- ✅ 예시와 가이드 추가로 품질 향상
- ✅ 캐싱 비율 향상으로 비용 절감 기대

---

**참고:** 
- 이미지가 포함된 요청에서는 이미지 데이터가 input_tokens에 포함되지만, System 프롬프트 부분만 캐싱됩니다.
- `cached_tokens` 값은 캐시에서 가져온 System 프롬프트 토큰 수를 나타냅니다.
