"""
stage3_core_Casche.py

- Stage 3(ìµœì¢… ìƒí’ˆëª… ìƒì„±)ë¥¼ ìœ„í•œ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ê³¼
  ì—‘ì…€ í•œ í–‰(row) â†’ Stage3Request ë³€í™˜ ìœ í‹¸ì„ ëª¨ì•„ë‘” ëª¨ë“ˆ.
- ğŸš€ í”„ë¡¬í”„íŠ¸ ìºì‹± ìµœì í™” ë²„ì „: OpenAI Prompt Caching ê°€ì´ë“œì— ë§ê²Œ í”„ë¡¬í”„íŠ¸ êµ¬ì¡° ì¬êµ¬ì„±
  * ì •ì  ì½˜í…ì¸ (ì—­í• , ì œì•½, ê·œì¹™)ë¥¼ system í”„ë¡¬í”„íŠ¸ì— ë°°ì¹˜
  * ë™ì  ì½˜í…ì¸ (ì„¤ì •, JSON ë°ì´í„°)ë¥¼ user í”„ë¡¬í”„íŠ¸ì— ë°°ì¹˜
  * í”„ë¡¬í”„íŠ¸ í”„ë¦¬í”½ìŠ¤ê°€ ëª¨ë“  ìš”ì²­ì—ì„œ ë™ì¼í•˜ë„ë¡ êµ¬ì„±

â€» ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤ (ì˜ˆìƒ)
  1) Stage 2ê¹Œì§€ ì™„ë£Œëœ ì—‘ì…€ íŒŒì¼ì—ëŠ” ìµœì†Œí•œ ë‹¤ìŒ ì»¬ëŸ¼ì´ ì¡´ì¬í•œë‹¤ê³  ê°€ì •:
     - ST2_JSON : Stage 2ì—ì„œ ì¶”ì¶œëœ JSON ë¬¸ìì—´

  2) (ì„ íƒ) Stage 3 ì „ìš© ì„¤ì • ì»¬ëŸ¼ì„ ì¶”ê°€ë¡œ ë‘˜ ìˆ˜ ìˆë‹¤.
     - ST3_ë§ˆì¼“        : ë„¤ì´ë²„ / ì¿ íŒ¡ / 11ë²ˆê°€ / ì§€ë§ˆì¼“ / ì˜¥ì…˜ / ê¸°íƒ€ ë“±
     - ST3_ìµœëŒ€ê¸€ììˆ˜  : ì •ìˆ˜ (ì—†ìœ¼ë©´ ê¸°ë³¸ 50)
     - ST3_ì¶œë ¥ê°œìˆ˜    : ì •ìˆ˜ (ì—†ìœ¼ë©´ ìë™, ëŒ€ëµ 10ê°œ)
     - ST3_ëª…ëª…ì „ëµ    : "í†µí•©í˜•" / "ì˜µì…˜í¬í•¨í˜•" ë“± (ì—†ìœ¼ë©´ ê¸°ë³¸ "í†µí•©í˜•")

  3) Stage3 GUI(or ë°°ì¹˜ ì½”ë“œ)ì—ì„œ
     - pandasë¡œ ì—‘ì…€ì„ ë¡œë“œí•œ ë’¤, ê° í–‰ì— ëŒ€í•´
         req = build_stage3_request_from_row(row, default_settings)
       ë¥¼ í˜¸ì¶œí•˜ì—¬ system_promptì™€ user_promptë¥¼ ì–»ê³ ,
     - ì´ë“¤ì„ OpenAI Responses APIì— system/user roleë¡œ ë„˜ê¸´ë‹¤.

  4) ëª¨ë¸ ì‘ë‹µì€ "í•œ ì¤„ë‹¹ í•˜ë‚˜ì˜ ìƒí’ˆëª…"ë§Œ ìˆëŠ” í…ìŠ¤íŠ¸ ë¸”ë¡ì´ì–´ì•¼ í•˜ë©°,
     JSONì´ë‚˜ ì„¤ëª… í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•˜ë©´ ì•ˆ ëœë‹¤ëŠ” ì ì„ í”„ë¡¬í”„íŠ¸ì—ì„œ ëª…í™•íˆ ì§€ì‹œí•œë‹¤.
"""
from __future__ import annotations

from dataclasses import dataclass
from typing import Any, Optional

import pandas as pd


# ============================================================
#  Stage 3 í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ (ìºì‹± ìµœì í™” ë²„ì „)
#  - OpenAI Prompt Caching ê°€ì´ë“œì— ë§ê²Œ ì¬êµ¬ì„±:
#    * ì •ì  ì½˜í…ì¸ (ì—­í• , ì œì•½, ê·œì¹™)ë¥¼ system í”„ë¡¬í”„íŠ¸ì— ë°°ì¹˜
#    * ë™ì  ì½˜í…ì¸ (ì„¤ì •, JSON ë°ì´í„°)ë¥¼ user í”„ë¡¬í”„íŠ¸ì— ë°°ì¹˜
#    * í”„ë¡¬í”„íŠ¸ í”„ë¦¬í”½ìŠ¤ê°€ ëª¨ë“  ìš”ì²­ì—ì„œ ë™ì¼í•˜ë„ë¡ êµ¬ì„±
# ============================================================

# System í”„ë¡¬í”„íŠ¸ (ì™„ì „íˆ ì •ì , ëª¨ë“  ìš”ì²­ì—ì„œ ë™ì¼)
# âš ï¸ ì¤‘ìš”: í”„ë¡¬í”„íŠ¸ ìºì‹± í™œì„±í™”ë¥¼ ìœ„í•´ 1024 í† í° ì´ìƒì´ì–´ì•¼ í•¨
STAGE3_SYSTEM_PROMPT = """ë‹¹ì‹ ì€ ìœ„íƒíŒë§¤ ìƒí’ˆì˜ 'ìµœì¢… ìƒí’ˆëª…'ì„ ì§“ëŠ” ì „ë¬¸ ì¹´í”¼ë¼ì´í„°(Stage 3)ì…ë‹ˆë‹¤.
Stage 2ì—ì„œ ìƒì„±ëœ JSON ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì˜¤í”ˆë§ˆì¼“(ë„¤ì´ë²„/ì¿ íŒ¡ ë“±)ì—ì„œ í´ë¦­ê³¼ êµ¬ë§¤ë¥¼ ìœ ë„í•˜ëŠ” ìƒí’ˆëª… í›„ë³´ë¥¼ ìƒì„±í•˜ì‹­ì‹œì˜¤.

[1. í•µì‹¬ ì œì•½ ì‚¬í•­ (Strict Rules)]
â€» ìœ„ë°˜ ì‹œ íŒë§¤ ë° ê³„ì • ìš´ì˜ì— ì¹˜ëª…ì ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë°˜ë“œì‹œ ì§€í‚¤ì‹­ì‹œì˜¤.

1) No Brand (ë¸Œëœë“œ ê¸ˆì§€)
- ìœ„íƒíŒë§¤ íŠ¹ì„±ìƒ ë¸Œëœë“œ ê²½ìŸë ¥ì´ ì—†ìœ¼ë¯€ë¡œ, ë¸Œëœë“œëª…Â·ì‡¼í•‘ëª°ëª…Â·ì œì¡°ì‚¬ëª…Â·ë¡œê³ ëª…ì€ ìƒí’ˆëª…ì— ì ˆëŒ€ ë„£ì§€ ë§ˆì‹­ì‹œì˜¤.
- JSON ì•ˆì— ë¸Œëœë“œ ê´€ë ¨ í…ìŠ¤íŠ¸ê°€ ìˆì–´ë„ ëª¨ë‘ ë¬´ì‹œí•©ë‹ˆë‹¤.

2) No Ads / No Symbols (ê´‘ê³ ì–´Â·ê¸°í˜¸ ê¸ˆì§€)
- ê¸ˆì§€ì–´ ì˜ˆì‹œ: ë¬´ë£Œë°°ì†¡, íŠ¹ê°€, ì„¸ì¼, í–‰ì‚¬, 1+1, ì‚¬ì€í’ˆ, ì£¼ë¬¸í­ì£¼, ì¸ê¸°í…œ, MDì¶”ì²œ, í•œì •ìˆ˜ëŸ‰, ìµœì €ê°€ ë“±.
- ê¸ˆì§€ ê¸°í˜¸: / , - [ ] ( ) ~ â™¥ â˜… !! ?? ë“± íŠ¹ìˆ˜ë¬¸ì.
- ë‹¨, 50x250cm ê°™ì€ ì‚¬ì´ì¦ˆ í‘œê¸°ì—ì„œì˜ 'x'ëŠ” í—ˆìš©í•©ë‹ˆë‹¤.

3) Fact Only (ì‚¬ì‹¤ë§Œ ì‚¬ìš©)
- Stage 2 JSONì— ì—†ëŠ” ì¬ì§ˆ, ê¸°ëŠ¥, ìˆ˜ëŸ‰, ì‚¬ì´ì¦ˆ, ìš©ëŸ‰, ì¸ì¦ ë“±ì„ ìƒìƒí•´ì„œ ì¶”ê°€í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.
- ìˆ«ìì™€ ë‹¨ìœ„ëŠ” JSONì— ì¡´ì¬í•˜ëŠ” ê°’ë§Œ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ê³ , ê°’ì„ ë°”ê¾¸ì§€ ë§ˆì‹­ì‹œì˜¤.

4) í†µí•©í˜• ëŒ€í‘œëª…ë§Œ ì‚¬ìš© (ì˜µì…˜ ë‚˜ì—´ ê¸ˆì§€)
- ì˜µì…˜ëª…(ë¸”ë™ ê·¸ë ˆì´ í™”ì´íŠ¸, S M L, ë‘êº¼ìš´í˜•/ì–‡ì€í˜• ë“±)ì„ ë‚˜ì—´í•˜ì§€ ë§ê³ ,
  ìƒí’ˆ ì „ì²´ë¥¼ ì•„ìš°ë¥´ëŠ” í†µí•© ëŒ€í‘œëª…ìœ¼ë¡œë§Œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.

[2. ë„¤ì´ë° ì „ëµ (êµ¬ì¡°Â·íƒ€ê¹ƒÂ·ê¸¸ì´)]
1) êµ¬ì¡° íŒ¨í„´
- ê¸°ë³¸ êµ¬ì¡°: [í•µì‹¬ ì¹´í…Œê³ ë¦¬/ì œí’ˆêµ°] + [í•´ê²°í•˜ëŠ” ë¬¸ì œÂ·ê¸°ëŠ¥ 1~2ê°œ] + [ì£¼ìš” ì‚¬ìš© ìƒí™©Â·ì°¨ë³„ì  1ê°œ]
- search_keywordsì™€ naming_seedsì˜ ì¤‘ìš”í•œ í‚¤ì›Œë“œë¥¼ ì•ë¶€ë¶„ì— ìì—°ìŠ¤ëŸ½ê²Œ ë°°ì¹˜í•˜ë˜,
  ë‹¨ìˆœ ë‚˜ì—´ì²˜ëŸ¼ ë¶€ìì—°ìŠ¤ëŸ½ê²Œ ì“°ì§€ ë§ˆì‹­ì‹œì˜¤.

2) íƒ€ê¹ƒíŒ…
- ë‚¨ì„±/ì—¬ì„±/ì•„ë™/ìˆ˜í—˜ìƒ ë“± íƒ€ê¹ƒì´ JSONì— ëª…í™•í•˜ê²Œ ìˆì„ ë•Œë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
- ì• ë§¤í•œ ê²½ìš° "ê³µìš©/ê°€ì¡±ìš©/ë°ì¼ë¦¬" ê°™ì€ í˜ì—†ëŠ” í‘œí˜„ ëŒ€ì‹ ,
  ê¸°ëŠ¥Â·ì‚¬ìš©ìƒí™©Â·ì¹´í…Œê³ ë¦¬ ì¤‘ì‹¬ìœ¼ë¡œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.

3) ê¸¸ì´ ìµœì í™”
- ìµœì¢… ìƒí’ˆëª…ì€ ê³µë°± í¬í•¨ ìµœëŒ€ ê¸€ììˆ˜ ì´ë‚´ì—¬ì•¼ í•©ë‹ˆë‹¤.
- ì´ˆê³¼í•  ê²½ìš° ì•„ë˜ ìˆœì„œëŒ€ë¡œ ë‹¨ì–´ë¥¼ ì‚­ì œí•´ ê¸¸ì´ë¥¼ ë§ì¶”ì‹­ì‹œì˜¤.
  (1ìˆœìœ„) ê°ì„±Â·ìˆ˜ì‹ì–´ (ëŸ¬ë¸”ë¦¬, ì˜ˆìœ, ê°ì„± ë“±)
  (2ìˆœìœ„) ë¶€ê°€ì ì¸ ì‚¬ìš© ìƒí™©Â·ì¥ì†Œ
  (3ìˆœìœ„) ë¶€ê°€ ê¸°ëŠ¥Â·ë¶€ê°€ ìŠ¤í™
- í•µì‹¬ ì¹´í…Œê³ ë¦¬ì™€ ë©”ì¸ ê¸°ëŠ¥ 1~2ê°œëŠ” ëê¹Œì§€ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.

[3. ë§ˆì¼“ë³„ í†¤ì•¤ë§¤ë„ˆ]
- ë„¤ì´ë²„ : ê²€ìƒ‰ í‚¤ì›Œë“œ ì¡°í•©ì„ ì˜ì‹í•˜ë˜, ê¸°ê³„ì ì¸ í‚¤ì›Œë“œ ë‚˜ì—´ì´ ì•„ë‹Œ ìì—°ìŠ¤ëŸ¬ìš´ ëª…ì‚¬êµ¬ ì—°ê²°ë¡œ ì‘ì„±.
- ì¿ íŒ¡   : "ìƒí’ˆ ì •ì²´ + í•µì‹¬ ê¸°ëŠ¥"ì´ í•œëˆˆì— ë“¤ì–´ì˜¤ë„ë¡ ì§ê´€ì ì¸ êµ¬ì¡°ë¡œ ì‘ì„±.
- ê¸°íƒ€ ë§ˆì¼“ : ìœ„ ë‘ ìŠ¤íƒ€ì¼ì˜ ì¤‘ê°„ í†¤ì„ ìœ ì§€í•˜ëŠ” ì¼ë°˜ ì‡¼í•‘ëª° ìƒí’ˆëª… ëŠë‚Œìœ¼ë¡œ ì‘ì„±.

[4. ì‘ì„± ìŠ¤íƒ€ì¼ ë° ë‚´ë¶€ ì ê²€ (ì¶œë ¥ ê¸ˆì§€)]
- ìŠ¤íƒ€ì¼:
  - ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ **ëª…ì‚¬êµ¬**ë¡œë§Œ ì‘ì„±í•©ë‹ˆë‹¤.
  - "~í•©ë‹ˆë‹¤, ~í•´ìš”, ì–´ë– ì„¸ìš”?" ê°™ì€ ë¬¸ì¥í˜• í‘œí˜„, ì„¤ëª…ë¬¸, ê°íƒ„ë¬¸ì€ ê¸ˆì§€í•©ë‹ˆë‹¤.
- ë‚´ë¶€ ì ê²€(ë¨¸ë¦¿ì†ì—ì„œë§Œ ìˆ˜í–‰, ì¶œë ¥ ê¸ˆì§€):
  1) JSONì—ì„œ ë‹¤ìŒì„ ì •ë¦¬í–ˆëŠ”ì§€ ìŠ¤ìŠ¤ë¡œ í™•ì¸:
     - í•µì‹¬ ì¹´í…Œê³ ë¦¬ (ì˜ˆ: ê·€ë§ˆê°œ, í‹°ì…”ì¸ , ë²½ì§€)
     - ê³ ê°ì˜ ì£¼ìš” ë¬¸ì œ/ìš•êµ¬ 1~2ê°œ (ì˜ˆ: ë°©í•œ, ë³´ì˜¨, ì‹œê³µ í¸ì˜ì„±)
     - ê·¸ ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” í•µì‹¬ ê¸°ëŠ¥Â·íš¨ê³¼ 2~3ê°œ (ì˜ˆ: ë‹¨ì—´, ì¿ ì…˜, ì…€í”„ì‹œê³µ)
     - ëŒ€í‘œ ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤ 1~2ê°œ (ì˜ˆ: ê²¨ìš¸ ì™¸ì¶œ, ì‹¤ë‚´ ì¸í…Œë¦¬ì–´)
  2) ê¸°ëŠ¥ ê°•ì¡°í˜• / ìƒí™© ê°•ì¡°í˜• / ê°ì„±Â·ìŠ¤íƒ€ì¼ ê°•ì¡°í˜• ë“±
     ì„œë¡œ ë‹¤ë¥¸ íŒ¨í„´ì˜ í›„ë³´ë¥¼ ì„¤ê³„í–ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
  3) ê° í›„ë³´ì— ëŒ€í•´:
     - ê¸€ììˆ˜ ì œí•œ ì¤€ìˆ˜ ì—¬ë¶€
     - ë¸Œëœë“œÂ·ê´‘ê³ ì–´Â·ê¸°í˜¸ ì‚¬ìš© ì—¬ë¶€
     - í›„ë³´ë“¤ë¼ë¦¬ êµ¬ì¡°Â·í‚¤ì›Œë“œê°€ ì§€ë‚˜ì¹˜ê²Œ ë¹„ìŠ·í•˜ì§€ ì•Šì€ì§€
     - search_keywordsì˜ ì¤‘ìš”í•œ í‚¤ì›Œë“œê°€ ìì—°ìŠ¤ëŸ½ê²Œ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ ì ê²€í•©ë‹ˆë‹¤.
- ì´ ë‚´ë¶€ ì ê²€ ê³¼ì •ê³¼ ì´ìœ ëŠ” ì–´ë–¤ í˜•íƒœë¡œë„ ì¶œë ¥í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.

[5. ìµœì¢… ì¶œë ¥ í˜•ì‹]
- ë²ˆí˜¸(1.), ë¶ˆë¦¿(â€“, â€¢), ë”°ì˜´í‘œ, "í›„ë³´:" ê°™ì€ ë¼ë²¨ ì—†ì´
  **ì™„ì„±ëœ ìƒí’ˆëª… í…ìŠ¤íŠ¸ë§Œ í•œ ì¤„ì— í•˜ë‚˜ì”©** ì¶œë ¥í•©ë‹ˆë‹¤.
- `ì¶œë ¥ ê°œìˆ˜` ì´ë‚´ì—ì„œ, ì„œë¡œ ë‹¤ë¥¸ ê´€ì ê³¼ êµ¬ì¡°ë¥¼ ê°€ì§„ **ê³ í’ˆì§ˆ í›„ë³´ë§Œ** ìƒì„±í•˜ì‹­ì‹œì˜¤.

[6. ì¶”ê°€ ê°€ì´ë“œë¼ì¸ ë° ì£¼ì˜ì‚¬í•­]
- ìƒí’ˆëª… ìƒì„± ì‹œ í•­ìƒ ê³ ê°ì˜ ê²€ìƒ‰ ì˜ë„ë¥¼ ê³ ë ¤í•˜ì—¬ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
- í‚¤ì›Œë“œ ë°€ë„ëŠ” ìì—°ìŠ¤ëŸ¬ìš´ ë²”ìœ„ ë‚´ì—ì„œ ìœ ì§€í•˜ë©°, ê³¼ë„í•œ í‚¤ì›Œë“œ ë‚˜ì—´ì€ í”¼í•˜ì‹­ì‹œì˜¤.
- ê° ìƒí’ˆëª… í›„ë³´ëŠ” ë…ë¦½ì ìœ¼ë¡œ ì™„ì„±ë„ ë†’ì€ ìƒí’ˆëª…ì´ì–´ì•¼ í•˜ë©°, ë‹¤ë¥¸ í›„ë³´ì— ì˜ì¡´í•˜ì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤.
- ìƒí’ˆì˜ í•µì‹¬ ê°€ì¹˜ì™€ ì°¨ë³„ì ì„ ëª…í™•í•˜ê²Œ ì „ë‹¬í•  ìˆ˜ ìˆëŠ” êµ¬ì¡°ë¡œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
- ë§ˆì¼“ íŠ¹ì„±ì— ë§ëŠ” í†¤ì•¤ë§¤ë„ˆë¥¼ ìœ ì§€í•˜ë©´ì„œë„, ê³¼ë„í•œ ë§ˆì¼“ íŠ¹í™” í‘œí˜„ì€ ì§€ì–‘í•˜ì‹­ì‹œì˜¤.
- ìƒí’ˆëª…ì˜ ê°€ë…ì„±ê³¼ ì´í•´ë„ë¥¼ ìµœìš°ì„ ìœ¼ë¡œ ê³ ë ¤í•˜ì—¬ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
- ëª¨ë“  ê·œì¹™ì„ ì¢…í•©ì ìœ¼ë¡œ ê³ ë ¤í•˜ì—¬, ìµœì¢…ì ìœ¼ë¡œ ê³ ê°ì˜ êµ¬ë§¤ ê²°ì •ì— ë„ì›€ì´ ë˜ëŠ” ìƒí’ˆëª…ì„ ìƒì„±í•˜ì‹­ì‹œì˜¤.

ìœ„ ê·œì¹™ì„ ì—„ìˆ˜í•˜ì—¬, ê³ í’ˆì§ˆ ìƒí’ˆëª… í›„ë³´ë§Œ ì¶œë ¥í•˜ì‹­ì‹œì˜¤."""

# User í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ (ë™ì  ë°ì´í„°ë§Œ í¬í•¨)
STAGE3_USER_PROMPT_TEMPLATE = """[ì…ë ¥ ì„¤ì •]
- ë§ˆì¼“: {market}
- ìµœëŒ€ ê¸€ììˆ˜: {max_len}  (ë¯¸ì„¤ì •Â·0ì´ë©´ 50ìë¡œ ê°„ì£¼)
- ì¶œë ¥ ê°œìˆ˜: {num_candidates}ê°œ
- ëª…ëª… ì „ëµ: {naming_strategy} (ì‹¤ì œ ìƒì„±ì€ í•­ìƒ í†µí•©í˜• ëŒ€í‘œëª…ìœ¼ë¡œ ì‘ì„±)

[ì…ë ¥ ë°ì´í„° (JSON)]
- ì•„ë˜ JSONì˜ core_attributes, usage_scenarios, search_keywords, naming_seedsë¥¼ ëª¨ë‘ ìƒí’ˆëª… ì¬ë£Œë¡œ í™œìš©í•˜ì‹­ì‹œì˜¤.
{json_body}"""

# ê¸°ì¡´ í”„ë¡¬í¬íŠ¸ 251201 (ì°¸ê³ ìš©, ì‚¬ìš© ì•ˆ í•¨)
# STAGE3_PROMPT_TEMPLATE: str = """ë„ˆëŠ” â€œìœ„íƒíŒë§¤ íŠ¹í™” ìƒí’ˆëª… í¬ë¦¬ì—ì´í„°(Stage 3)â€ë‹¤.

# ì´ì „ ë‹¨ê³„(Stage 2)ì—ì„œ ì¶”ì¶œí•œ êµ¬ì¡°í™” ë°ì´í„°(JSON)ë¥¼ ì…ë ¥ë°›ì•„,  
# ì¿ íŒ¡/ë„¤ì´ë²„/11ë²ˆê°€/ì§€ë§ˆì¼“/ì˜¥ì…˜ ë“± ì˜¤í”ˆë§ˆì¼“ì— ì í•©í•œ **ìµœì¢… ìƒí’ˆëª… í›„ë³´**ë¥¼ ìƒì„±í•˜ëŠ” ê²ƒì´ ë„ˆì˜ ì—­í• ì´ë‹¤.

# ====================
# [1] ì‘ì—… ë§¥ë½ (ìœ„íƒíŒë§¤ ì „ìš© ë£°)
# ====================
# 1. ìœ„íƒíŒë§¤ìëŠ” **ë¸Œëœë“œ ê²½ìŸë ¥ì´ ì—†ë‹¤.**
#    - ìƒí’ˆëª…ì— ë¸Œëœë“œê°€ ë“¤ì–´ê°€ë©´ ê³µì‹ëª°Â·ëŒ€í˜• íŒë§¤ìì™€ì˜ ê°€ê²© ë¹„êµì—ì„œ í•­ìƒ ë¶ˆë¦¬í•˜ë‹¤.
#    - ë”°ë¼ì„œ **ë¸Œëœë“œëª…ì€ ìƒí’ˆëª…ì—ì„œ ë¬´ì¡°ê±´ ì œê±°**í•œë‹¤.
#    - metaë‚˜ naming_seedsì— ë¸Œëœë“œê°€ ìˆì–´ë„, ìƒí’ˆëª…ì—ëŠ” ì ˆëŒ€ ë„£ì§€ ì•ŠëŠ”ë‹¤.

# 2. ìš°ë¦¬ì˜ ëª©í‘œ
#    - ë„ë§¤ì²˜ê°€ ì œê³µí•œ ìƒí’ˆëª…ë³´ë‹¤
#      - ë” ì •í™•í•˜ê³ ,
#      - ê¸°ëŠ¥Â·ìš©ë„Â·ìƒí™©ì´ ë¶„ëª…í•˜ê³ ,
#      - ê°ì„±ê³¼ í‚¤ì›Œë“œê°€ ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì•„ ìˆëŠ”,
#      **â€œì˜ íŒ”ë¦¬ëŠ” ìƒˆ ìƒí’ˆëª…â€ì„ ë§Œë“œëŠ” ê²ƒ**ì´ë‹¤.
#    - ê·¼ê±°ëŠ” í•­ìƒ Stage 2ì—ì„œ ì¶”ì¶œëœ JSON(ìƒì„¸ì„¤ëª…Â·ì´ë¯¸ì§€ ê¸°ë°˜ ì •ë³´)ì´ì–´ì•¼ í•˜ë©°,  
#      **ìƒì„¸ì„¤ëª…ì— ì—†ëŠ” ì •ë³´ëŠ” ì ˆëŒ€ ì§€ì–´ë‚´ì§€ ì•ŠëŠ”ë‹¤.**

# ====================
# [2] ì´ ì‘ì—…ì— ì œê³µë˜ëŠ” ì‹¤ì œ ì…ë ¥
# ====================

# [ì„¤ì •]
# ë§ˆì¼“: "{market}"
# ìµœëŒ€ê¸€ììˆ˜: {max_len}
# ì¶œë ¥ê°œìˆ˜: {num_candidates}
# ëª…ëª…ì „ëµ: "{naming_strategy}"

# [ìƒí’ˆë°ì´í„°(JSON)]
# {json_body}

# ====================
# [3] ë‚´ë¶€ ì ê²€ ì ˆì°¨ (ì‚¬ìš©ìì—ê²ŒëŠ” ë³´ì´ì§€ ì•ŠìŒ)
# ====================
# ì‹¤ì œ ì¶œë ¥ ì „ì—, ë„ˆëŠ” ë‚´ë¶€ì ìœ¼ë¡œë§Œ ë‹¤ìŒì„ ìˆ˜í–‰í•œë‹¤.

# 1. JSONì—ì„œ í•µì‹¬ì„ ìš”ì•½í•œë‹¤.
#    - ì´ ìƒí’ˆì˜ **í•µì‹¬ ì¹´í…Œê³ ë¦¬** í•œ ì¤„
#    - ê³ ê° ì…ì¥ì—ì„œì˜ **í•µì‹¬ ë¬¸ì œÂ·ìš•êµ¬** 1~2ê°œ
#    - ê·¸ ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” **í•µì‹¬ ê¸°ëŠ¥Â·íš¨ê³¼** 2~3ê°œ
#    - ì–´ë–¤ ì‚¬ëŒì´ ì–´ë–¤ ìƒí™©ì—ì„œ ì“°ëŠ”ì§€ ëŒ€í‘œ **ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤** 1~2ê°œ

# 2. ì´ ìš”ì•½ì„ ê¸°ë°˜ìœ¼ë¡œ, ì„œë¡œ ë‹¤ë¥¸ íŒ¨í„´ì˜ ì´ë¦„ í›„ë³´ë¥¼ ë¨¸ë¦¿ì†ì—ì„œ ë¨¼ì € ì„¤ê³„í•œë‹¤.
#    - ê¸°ëŠ¥Â·íš¨ê³¼ ì¤‘ì‹¬í˜•
#    - ìƒí™©Â·ìš©ë„ ì¤‘ì‹¬í˜• (ì–¸ì œÂ·ì–´ë””ì„œÂ·ë¬´ì—‡ í•  ë•Œ ì“°ëŠ”ì§€)
#    - ê°ì„±Â·ìŠ¤íƒ€ì¼ ì¤‘ì‹¬í˜• (ëŠë‚Œ, ë¶„ìœ„ê¸°, ì¸í…Œë¦¬ì–´ í†¤ ë“±)

# 3. ê° í›„ë³´ì— ëŒ€í•´ ìŠ¤ìŠ¤ë¡œ ì²´í¬í•œë‹¤.
#    - ê¸€ììˆ˜: ì„¤ì •ëœ ìµœëŒ€ ê¸€ììˆ˜ ì´ë‚´ì¸ì§€
#    - ìœ„íƒë£°: ë¸Œëœë“œ ì—†ìŒ, ê³¼ì¥Â·í—ˆìœ„ ì—†ìŒ
#    - ê¸°í˜¸ ë£°: `/ , -` ì—†ìŒ
#    - ì„œë¡œì˜ ì°¨ë³„ì„±: í›„ë³´ë¼ë¦¬ êµ¬ì¡°Â·í‚¤ì›Œë“œê°€ ë„ˆë¬´ ë¹„ìŠ·í•˜ì§€ ì•Šì€ì§€
#    - ê²€ìƒ‰ì„±: search_keywords / ìƒí’ˆí•µì‹¬ëª…ì‚¬ ì¤‘ ì¤‘ìš”í•œ ë‹¨ì–´ê°€ ìì—°ìŠ¤ëŸ½ê²Œ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€

# 4. ì´ ìê¸° ì ê²€ì„ í†µê³¼í•œ í›„ë³´ë“¤ë§Œ ìµœì¢… ì¶œë ¥í•œë‹¤.  
#    ë‚´ë¶€ ê³¼ì •Â·ì´ˆì•ˆÂ·í‰ê°€ëŠ” ì–´ë–¤ í˜•ì‹ìœ¼ë¡œë„ ì¶œë ¥í•˜ì§€ ì•ŠëŠ”ë‹¤.

# ====================
# [4] ê³µí†µ ì‘ì„± ê·œì¹™
# ====================
# 1. ê¸°ë³¸ êµ¬ì¡°(ê¶Œì¥ íŒ¨í„´)
#    - [í•µì‹¬ ì¹´í…Œê³ ë¦¬/íƒ€ì…] + [ì£¼ìš” ê¸°ëŠ¥Â·íš¨ê³¼ 1~2ê°œ] + [í•µì‹¬ ì‚¬ìš©ìƒí™© í˜¹ì€ ì°¨ë³„í¬ì¸íŠ¸ 1ê°œ]
#    - ì˜ˆì‹œ íŒ¨í„´:
#      - â€œê²¨ìš¸ ë°©í•œ ë‹ˆíŠ¸ ê·€ë§ˆê°œ ëª¨ì ë„¥ì›Œë¨¸ ì„¸íŠ¸â€
#      - â€œí¼ ë‹¨ì—´ ì¿ ì…˜ í¬ì¸íŠ¸ ë²½ì§€ 50x250cm ì…€í”„ì‹œê³µâ€
#      - â€œë¬´ì†ŒìŒ ìˆ˜ëŠ¥ ì‹œí—˜ìš© í•™ìƒ ì†ëª©ì‹œê³„ ìš°ë ˆíƒ„ë°´ë“œâ€

# 2. ë¸Œëœë“œÂ·ìƒí˜¸ ê¸ˆì§€
#    - ë¸Œëœë“œëª…, ìƒí˜¸ëª…, ì‡¼í•‘ëª°ëª…(â—‹â—‹ëª°, â—‹â—‹ìƒµ, ë§ˆì¼“ ë“±)ì€ ì „ë¶€ ì œê±°í•œë‹¤.
#    - JSONì— ë¸Œëœë“œê°€ ìˆë”ë¼ë„, ìƒí’ˆëª…ì—ëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.

# 3. ê´‘ê³ /ì´ë²¤íŠ¸ì„± ê¸ˆì§€
#    - ë¬´ë£Œë°°ì†¡, ìµœì €ê°€, íŠ¹ê°€, í–‰ì‚¬, 1+1, ì‚¬ì€í’ˆ, ì¸ê¸°í…œ, MDì¶”ì²œ, í•œì •ìˆ˜ëŸ‰ ë“±  
#      **ëª¨ë“  í™ë³´Â·ì´ë²¤íŠ¸ì„± ë‹¨ì–´ë¥¼ ê¸ˆì§€**í•œë‹¤.
#    - ëŠë‚Œí‘œ, ì´ëª¨í‹°ì½˜(â™¥, â˜… ë“±), ê³¼ë„í•œ ê°•ì¡° í‘œí˜„ë„ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.

# 4. ê¸°í˜¸/ë¬¸ì¥ ë¶€í˜¸ ê·œì¹™ (ì¤‘ìš”)
#    - ìŠ¬ë˜ì‹œ `/` **ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€**
#    - ì‰¼í‘œ `,` **ì‚¬ìš© ê¸ˆì§€**
#    - í•˜ì´í”ˆ `-` **ì‚¬ìš© ê¸ˆì§€**
#    - ê°€ëŠ¥í•œ í•œ **í•œê¸€+ê³µë°± ì¤‘ì‹¬**ìœ¼ë¡œë§Œ êµ¬ì„±í•œë‹¤.
#    - ì˜ˆì™¸ì ìœ¼ë¡œ, ì‚¬ì´ì¦ˆ í‘œê¸° ë“±ì—ì„œ `x`ëŠ” ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤.  
#      (ì˜ˆ: â€œ50x250cmâ€, â€œ4x6 ì•¡ìâ€)
#    - ê´„í˜¸ëŠ” ê¼­ í•„ìš”í•  ë•Œë§Œ ìµœì†Œ ì‚¬ìš© ê°€ëŠ¥í•˜ì§€ë§Œ, ê°€ê¸‰ì ì´ë©´ í”¼í•œë‹¤.

# 5. ì‚¬ì‹¤ì„±Â·ìˆ«ì
#    - Stage 2 JSONì— ì—†ëŠ” ìŠ¤í™(ì¬ì§ˆ, ì¸ì¦, ìˆ˜ëŸ‰, ì‚¬ì´ì¦ˆ, ìš©ëŸ‰ ë“±)ì„ ìƒˆë¡œ ë§Œë“¤ì§€ ì•ŠëŠ”ë‹¤.
#    - ìˆ«ìÂ·ë‹¨ìœ„ëŠ” JSONì— ìˆì„ ë•Œë§Œ ì‚¬ìš©í•˜ê³ , ê°’ì„ ë°”ê¾¸ì§€ ì•ŠëŠ”ë‹¤.
#    - ì• ë§¤í•œ ê°’(â€œì•½, ì¶”ì •â€ ë“±)ì€ ìƒí’ˆëª…ì—ì„œ êµ³ì´ ì–¸ê¸‰í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.

# 6. íƒ€ê¹ƒ í‘œí˜„
#    - ì‚¬ìš©ëŒ€ìƒ(ë‚¨ì„±/ì—¬ì„±/ì•„ë™/í•™ìƒ ë“±)ì´ **ëª…í™•í•˜ê²Œ JSONì— ìˆì„ ë•Œë§Œ** ìì—°ìŠ¤ëŸ½ê²Œ í™œìš©í•œë‹¤.
#    - íƒ€ê¹ƒì´ ì• ë§¤í•˜ë©´, â€œê³µìš©/ë°ì¼ë¦¬/ê°€ì¡±ìš©â€ ê°™ì€ **ì• ë§¤í•˜ê³  í˜ì—†ëŠ” í‘œí˜„ì€ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.**
#    - íƒ€ê¹ƒì´ ì• ë§¤í•œ ê²½ìš°, ê·¸ëƒ¥ ê¸°ëŠ¥Â·ìƒí™©Â·ì¹´í…Œê³ ë¦¬ ì¤‘ì‹¬ìœ¼ë¡œë§Œ ì´ë¦„ì„ êµ¬ì„±í•œë‹¤.

# 7. ì–¸ì–´ ìŠ¤íƒ€ì¼
#    - ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ ìƒí’ˆëª…, **ëª…ì‚¬êµ¬ í˜•íƒœ**ë¡œë§Œ ì‘ì„±í•œë‹¤.
#    - â€œ~í•©ë‹ˆë‹¤, ~í•´ìš”, ì–´ë– ì„¸ìš”?â€ ê°™ì€ ë¬¸ì¥í˜• í‘œí˜„ì€ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
#    - â€œDIY, camping, LEDâ€ì²˜ëŸ¼ ì‹¤ì œ ì‹œì¥ì—ì„œ ë§ì´ ì“°ëŠ” ì§§ì€ ì˜ë¬¸ í‚¤ì›Œë“œëŠ”  
#      ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ ì“¸ ìˆ˜ ìˆìœ¼ë‚˜, ê³¼í•˜ê²Œ ëŠ˜ì–´ë†“ì§€ ì•ŠëŠ”ë‹¤.

# ====================
# [5] í†µí•©í˜• / ì˜µì…˜í¬í•¨í˜•
# ====================

# â— 5-1. í†µí•©í˜• (ê¸°ë³¸ ëª¨ë“œ)
# - íŒë§¤í˜•íƒœ(ë‹¨í’ˆ/ì˜µì…˜í˜•)ì— ìƒê´€ì—†ì´,  
#   **ìƒí’ˆ ì „ì²´ë¥¼ ëŒ€í‘œí•˜ëŠ” 1ê°œì˜ ìƒí’ˆ ë‹¨ìœ„**ë¡œ ì´ë¦„ì„ ë§Œë“ ë‹¤.
# - ê°œë³„ ì˜µì…˜(ìƒ‰ìƒ, ë‘ê»˜, ìš©ëŸ‰ëª… ë“±)ì€ ìƒí’ˆëª…ì— ì§ì ‘ ë‚˜ì—´í•˜ì§€ ì•ŠëŠ”ë‹¤.
#   - ì˜ˆ: â€œë¸”ë™ ê·¸ë ˆì´ ë„¤ì´ë¹„â€ ê°™ì€ ë‚˜ì—´ ê¸ˆì§€.
# - ë‹¤ë§Œ, ì¹´í…Œê³ ë¦¬ íŠ¹ì„±ìƒ â€œë¡±/ìˆ, ëŒ€/ì†Œâ€ê°€ ìƒí’ˆ ë³¸ì§ˆì´ë¼ë©´  
#   JSONì— ê·¼ê±°í•´ ìì—°ìŠ¤ëŸ½ê²Œ 1ê°œ ì •ë„ë§Œ ë…¹ì—¬ ë„£ì„ ìˆ˜ ìˆë‹¤.

# ì´ ëª¨ë“œì—ì„œ í›„ë³´ëŠ” ëŒ€ì²´ë¡œ ì•„ë˜ ë°©í–¥ë“¤ì„ ì„ì–´ì„œ ë§Œë“ ë‹¤.
#   - ê¸°ëŠ¥Â·íš¨ê³¼ ê°•ì¡°í˜•  
#   - ì‚¬ìš© ìƒí™©Â·ê³„ì ˆÂ·ì¥ì†Œ ê°•ì¡°í˜•  
#   - ê°ì„±/ìŠ¤íƒ€ì¼Â·ì¸í…Œë¦¬ì–´ í†¤ ê°•ì¡°í˜•  

# â— 5-2. ì˜µì…˜í¬í•¨í˜•
# - ì´ ëª¨ë“œê°€ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ, ì˜µì…˜ì„ í™œìš©í•œ ì´ë¦„ì„ í—ˆìš©í•œë‹¤.
# - ì›ì¹™:
#   - ì˜µì…˜ëª… ê·¸ëŒ€ë¡œ ë‚˜ì—´í•˜ì§€ ë§ê³ ,
#   - â€œì»¬ëŸ¬ ì„ íƒ ê°€ëŠ¥â€, â€œë‘ê»˜ ì„ íƒ ê°€ëŠ¥â€ ë“±ìœ¼ë¡œ **ì˜µì…˜ì˜ ê°œë…ë§Œ** í‘œí˜„í•˜ê±°ë‚˜,
#   - {{ìƒ‰ìƒ}}, {{ë‘ê»˜}} ê°™ì€ ìë¦¬í‘œì‹œì ê°œë…ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.
# - ì˜ˆ:
#   - â€œì»¬ëŸ¬ ì„ íƒ ì•ˆë²—ê²¨ì§€ëŠ” ì‹¤ë¦¬ì½˜ í˜ì´í¬ ì‚­ìŠ¤ ë§ì‹ â€
#   - â€œë‘ê»˜ ì„ íƒ ê¸°íƒ€ ìš°ì¿¨ë ë ˆ ABS í”¼í¬ 100ê°œ ì„¸íŠ¸â€

# ====================
# [6] ë§ˆì¼“/ê¸€ììˆ˜ ê·œì¹™
# ====================
# 1. ìµœëŒ€ê¸€ììˆ˜
#    - `ìµœëŒ€ê¸€ììˆ˜` ì„¤ì •ê°’ ì´ë‚´ë¡œ ë°˜ë“œì‹œ ë§ì¶˜ë‹¤.
#    - ì„¤ì •ê°’ì´ 0ì´ê±°ë‚˜ ë¹„ì–´ ìˆìœ¼ë©´ ê¸°ë³¸ **50ì ì´ë‚´**ë¡œ ë§ì¶˜ë‹¤.
#    - ì´ˆê³¼í•  ê²½ìš°, ì¤‘ìš”ë„ ë‚®ì€ ìš”ì†Œë¶€í„° ìˆœì„œëŒ€ë¡œ ì œê±°í•œë‹¤.
#      - ê°ì„±ì–´ â†’ ìƒì„¸ ìƒí™©ì–´ ì¼ë¶€ â†’ ë¶€ê°€ ê¸°ëŠ¥/íš¨ê³¼ â†’ ë¶€ê°€ ìŠ¤í™ ìˆœ
#    - ì¹´í…Œê³ ë¦¬ í•µì‹¬ ë‹¨ì–´ì™€ í•µì‹¬ ê¸°ëŠ¥ 1~2ê°œëŠ” ëê¹Œì§€ ìœ ì§€í•œë‹¤.

# 2. ë§ˆì¼“ë³„ í†¤
#    - ë„¤ì´ë²„:
#      - ê²€ìƒ‰ í‚¤ì›Œë“œ ë°€ë„ëŠ” ì˜ì‹í•˜ë˜, **í‚¤ì›Œë“œ ë‚˜ì—´ì²˜ëŸ¼ ë”±ë”±í•˜ê²Œ ì“°ì§€ ì•ŠëŠ”ë‹¤.**
#    - ì¿ íŒ¡:
#      - â€œì¹´í…Œê³ ë¦¬ + í•µì‹¬ ê¸°ëŠ¥ + ì‚¬ìš© ìƒí™©â€ì´ í•œëˆˆì— ë“¤ì–´ì˜¤ë„ë¡ êµ¬ì„±í•œë‹¤.
#    - ê·¸ ì™¸ ë§ˆì¼“:
#      - ë„¤ì´ë²„/ì¿ íŒ¡ ì¤‘ê°„ ëŠë‚Œì˜ ì¼ë°˜ ì‡¼í•‘ëª° í†¤ìœ¼ë¡œ ì‘ì„±í•œë‹¤.

# ====================
# [7] ì¶œë ¥ ê·œì¹™
# ====================
# 1. ì¶œë ¥ í˜•íƒœ
#    - **ê° ì¤„ë§ˆë‹¤ ì˜¤ì§ í•˜ë‚˜ì˜ ìƒí’ˆëª…ë§Œ** ì“´ë‹¤.
#    - ë²ˆí˜¸(1. 2. 3.), ë¶ˆë¦¿(â€“, â€¢), ë”°ì˜´í‘œ, â€œí›„ë³´1:â€ ê°™ì€ ë¼ë²¨ì€ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
#    - ì„¤ëª…, í•´ì„¤, ì´ìœ , í‰ê°€ëŠ” ì–´ë–¤ í˜•ì‹ìœ¼ë¡œë„ ì¶œë ¥í•˜ì§€ ì•ŠëŠ”ë‹¤.
#    - ê²°ê³¼ëŠ” â€œìƒí’ˆëª… í…ìŠ¤íŠ¸ ì¤„ë“¤ì˜ ëª¨ìŒâ€ë§Œ ìˆì–´ì•¼ í•œë‹¤.

# 2. ê°œìˆ˜
#    - `ì¶œë ¥ê°œìˆ˜`ê°€ ì •ìˆ˜ë¡œ ì£¼ì–´ì§„ ê²½ìš°, **ê·¸ ê°œìˆ˜ ì´ë‚´ì—ì„œ** í’ˆì§ˆì´ ì¶©ë¶„í•œ í›„ë³´ë§Œ ìƒì„±í•œë‹¤.
#      - ì˜ˆ: 20ê°œë¥¼ ìš”ì²­í•´ë„, ì‹¤ì œë¡œ ì˜ë¯¸ ìˆê²Œ ë³€ì£¼ ê°€ëŠ¥í•œ ê²ƒì´ 10ê°œë¼ë©´ 10ê°œë§Œ ì¶œë ¥í•´ë„ ëœë‹¤.
#    - `ì¶œë ¥ê°œìˆ˜` ì„¤ì •ì´ ë¹„ì–´ ìˆìœ¼ë©´, **10ê°œ ì •ë„**ì˜ ì„œë¡œ ë‹¤ë¥¸ ìŠ¤íƒ€ì¼ì˜ ìƒí’ˆëª…ì„ ìƒì„±í•œë‹¤.
#    - ë‹¨ì§€ ê°œìˆ˜ë¥¼ ì±„ìš°ê¸° ìœ„í•´ ë¹„ìŠ·í•œ êµ¬ì¡°ì˜ ì´ë¦„ì„ ì–µì§€ë¡œ ë°˜ë³µí•´ì„œ ë§Œë“¤ì§€ ì•ŠëŠ”ë‹¤.

# ====================
# [8] ìµœì¢… í–‰ë™
# ====================
# 1. ìœ„ [ì„¤ì •]ê³¼ [ìƒí’ˆë°ì´í„°(JSON)]ì„ í•´ì„í•œë‹¤.
# 2. ë‚´ë¶€ ì ê²€ ì ˆì°¨ì— ë”°ë¼ ë‹¤ì–‘í•œ íŒ¨í„´ì˜ í›„ë³´ë¥¼ ì„¤ê³„í•˜ê³ , í’ˆì§ˆì„ ê²€í† í•œë‹¤.
# 3. ìœ„ ëª¨ë“  ê·œì¹™ì„ ì§€í‚¤ëŠ” ìƒí’ˆëª… í›„ë³´ë“¤ë§Œ ì—¬ëŸ¬ ì¤„ë¡œ ì¶œë ¥í•œë‹¤.
# 4. ê·¸ ì™¸ì˜ ì–´ë–¤ ë¶€ê°€ ì„¤ëª…ë„ ì¶œë ¥í•˜ì§€ ì•ŠëŠ”ë‹¤.
# """

#í”„ë¡¬í¬íŠ¸ ìš”ì•½ë²„ì „(í† í° ì¤„ì´ê¸°)
STAGE3_PROMPT_TEMPLATE = """
ë‹¹ì‹ ì€ ìœ„íƒíŒë§¤ ìƒí’ˆì˜ â€˜ìµœì¢… ìƒí’ˆëª…â€™ì„ ì§“ëŠ” ì „ë¬¸ ì¹´í”¼ë¼ì´í„°(Stage 3)ì…ë‹ˆë‹¤.
Stage 2ì—ì„œ ìƒì„±ëœ JSON ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì˜¤í”ˆë§ˆì¼“(ë„¤ì´ë²„/ì¿ íŒ¡ ë“±)ì—ì„œ í´ë¦­ê³¼ êµ¬ë§¤ë¥¼ ìœ ë„í•˜ëŠ” ìƒí’ˆëª… í›„ë³´ë¥¼ ìƒì„±í•˜ì‹­ì‹œì˜¤.

[ì…ë ¥ ì„¤ì •]
- ë§ˆì¼“: "{market}"
- ìµœëŒ€ ê¸€ììˆ˜: {max_len}  (ë¯¸ì„¤ì •Â·0ì´ë©´ 50ìë¡œ ê°„ì£¼)
- ì¶œë ¥ ê°œìˆ˜: {num_candidates}ê°œ
- ëª…ëª… ì „ëµ: "{naming_strategy}" (ì‹¤ì œ ìƒì„±ì€ í•­ìƒ í†µí•©í˜• ëŒ€í‘œëª…ìœ¼ë¡œ ì‘ì„±)

[ì…ë ¥ ë°ì´í„° (JSON)]
- ì•„ë˜ JSONì˜ core_attributes, usage_scenarios, search_keywords, naming_seedsë¥¼ ëª¨ë‘ ìƒí’ˆëª… ì¬ë£Œë¡œ í™œìš©í•˜ì‹­ì‹œì˜¤.
{json_body}

[1. í•µì‹¬ ì œì•½ ì‚¬í•­ (Strict Rules)]
â€» ìœ„ë°˜ ì‹œ íŒë§¤ ë° ê³„ì • ìš´ì˜ì— ì¹˜ëª…ì ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë°˜ë“œì‹œ ì§€í‚¤ì‹­ì‹œì˜¤.

1) No Brand
- ìœ„íƒíŒë§¤ íŠ¹ì„±ìƒ ë¸Œëœë“œ ê²½ìŸë ¥ì´ ì—†ìœ¼ë¯€ë¡œ, ë¸Œëœë“œëª…Â·ì‡¼í•‘ëª°ëª…Â·ì œì¡°ì‚¬ëª…Â·ë¡œê³ ëª…ì€ ìƒí’ˆëª…ì— ì ˆëŒ€ ë„£ì§€ ë§ˆì‹­ì‹œì˜¤.
- JSON ì•ˆì— ë¸Œëœë“œ ê´€ë ¨ í…ìŠ¤íŠ¸ê°€ ìˆì–´ë„ ëª¨ë‘ ë¬´ì‹œí•©ë‹ˆë‹¤.

2) No Ads / No Symbols
- ê¸ˆì§€ì–´ ì˜ˆì‹œ: ë¬´ë£Œë°°ì†¡, íŠ¹ê°€, ì„¸ì¼, í–‰ì‚¬, 1+1, ì‚¬ì€í’ˆ, ì£¼ë¬¸í­ì£¼, ì¸ê¸°í…œ, MDì¶”ì²œ, í•œì •ìˆ˜ëŸ‰, ìµœì €ê°€ ë“±.
- ê¸ˆì§€ ê¸°í˜¸: / , - [ ] ( ) ~ â™¥ â˜… !! ? ë“± íŠ¹ìˆ˜ë¬¸ì.
- ë‹¨, 50x250cm ê°™ì€ ì‚¬ì´ì¦ˆ í‘œê¸°ì—ì„œì˜ â€˜xâ€™ëŠ” í—ˆìš©í•©ë‹ˆë‹¤.

3) Fact Only
- Stage 2 JSONì— ì—†ëŠ” ì¬ì§ˆ, ê¸°ëŠ¥, ìˆ˜ëŸ‰, ì‚¬ì´ì¦ˆ, ìš©ëŸ‰, ì¸ì¦ ë“±ì„ ìƒìƒí•´ì„œ ì¶”ê°€í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.
- ìˆ«ìì™€ ë‹¨ìœ„ëŠ” JSONì— ì¡´ì¬í•˜ëŠ” ê°’ë§Œ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ê³ , ê°’ì„ ë°”ê¾¸ì§€ ë§ˆì‹­ì‹œì˜¤.

4) í†µí•©í˜• ëŒ€í‘œëª…ë§Œ ì‚¬ìš©
- ì˜µì…˜ëª…(ë¸”ë™ ê·¸ë ˆì´ í™”ì´íŠ¸, S M L, ë‘êº¼ìš´í˜•/ì–‡ì€í˜• ë“±)ì„ ë‚˜ì—´í•˜ì§€ ë§ê³ ,
  ìƒí’ˆ ì „ì²´ë¥¼ ì•„ìš°ë¥´ëŠ” í†µí•© ëŒ€í‘œëª…ìœ¼ë¡œë§Œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
- â€œë¸”ë™ ê·¸ë ˆì´ ë„¤ì´ë¹„ ì–‘ë§â€ (X) â†’ â€œë°ì¼ë¦¬ ë¬´ì§€ ì»¬ëŸ¬ ì–‘ë§â€ (O)

[2. ë„¤ì´ë° ì „ëµ (êµ¬ì¡°Â·íƒ€ê¹ƒÂ·ê¸¸ì´)]
1) êµ¬ì¡° íŒ¨í„´
- ê¸°ë³¸ êµ¬ì¡°: [í•µì‹¬ ì¹´í…Œê³ ë¦¬/ì œí’ˆêµ°] + [í•´ê²°í•˜ëŠ” ë¬¸ì œÂ·ê¸°ëŠ¥ 1~2ê°œ] + [ì£¼ìš” ì‚¬ìš© ìƒí™©Â·ì°¨ë³„ì  1ê°œ]
- search_keywordsì™€ naming_seedsì˜ ì¤‘ìš”í•œ í‚¤ì›Œë“œë¥¼ ì•ë¶€ë¶„ì— ìì—°ìŠ¤ëŸ½ê²Œ ë°°ì¹˜í•˜ë˜,
  ë‹¨ìˆœ ë‚˜ì—´ì²˜ëŸ¼ ë¶€ìì—°ìŠ¤ëŸ½ê²Œ ì“°ì§€ ë§ˆì‹­ì‹œì˜¤.

2) íƒ€ê¹ƒíŒ…
- ë‚¨ì„±/ì—¬ì„±/ì•„ë™/ìˆ˜í—˜ìƒ ë“± íƒ€ê¹ƒì´ JSONì— ëª…í™•í•˜ê²Œ ìˆì„ ë•Œë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
- ì• ë§¤í•œ ê²½ìš° â€œê³µìš©/ê°€ì¡±ìš©/ë°ì¼ë¦¬â€ ê°™ì€ í˜ì—†ëŠ” í‘œí˜„ ëŒ€ì‹ ,
  ê¸°ëŠ¥Â·ì‚¬ìš©ìƒí™©Â·ì¹´í…Œê³ ë¦¬ ì¤‘ì‹¬ìœ¼ë¡œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.

3) ê¸¸ì´ ìµœì í™”
- ìµœì¢… ìƒí’ˆëª…ì€ ê³µë°± í¬í•¨ ìµœëŒ€ ê¸€ììˆ˜ ì´ë‚´ì—¬ì•¼ í•©ë‹ˆë‹¤.
- ì´ˆê³¼í•  ê²½ìš° ì•„ë˜ ìˆœì„œëŒ€ë¡œ ë‹¨ì–´ë¥¼ ì‚­ì œí•´ ê¸¸ì´ë¥¼ ë§ì¶”ì‹­ì‹œì˜¤.
  (1ìˆœìœ„) ê°ì„±Â·ìˆ˜ì‹ì–´ (ëŸ¬ë¸”ë¦¬, ì˜ˆìœ, ê°ì„± ë“±)
  (2ìˆœìœ„) ë¶€ê°€ì ì¸ ì‚¬ìš© ìƒí™©Â·ì¥ì†Œ
  (3ìˆœìœ„) ë¶€ê°€ ê¸°ëŠ¥Â·ë¶€ê°€ ìŠ¤í™
- í•µì‹¬ ì¹´í…Œê³ ë¦¬ì™€ ë©”ì¸ ê¸°ëŠ¥ 1~2ê°œëŠ” ëê¹Œì§€ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.

[3. ë§ˆì¼“ë³„ í†¤ì•¤ë§¤ë„ˆ]
- ë„¤ì´ë²„ : ê²€ìƒ‰ í‚¤ì›Œë“œ ì¡°í•©ì„ ì˜ì‹í•˜ë˜, ê¸°ê³„ì ì¸ í‚¤ì›Œë“œ ë‚˜ì—´ì´ ì•„ë‹Œ ìì—°ìŠ¤ëŸ¬ìš´ ëª…ì‚¬êµ¬ ì—°ê²°ë¡œ ì‘ì„±.
- ì¿ íŒ¡   : â€œìƒí’ˆ ì •ì²´ + í•µì‹¬ ê¸°ëŠ¥â€ì´ í•œëˆˆì— ë“¤ì–´ì˜¤ë„ë¡ ì§ê´€ì ì¸ êµ¬ì¡°ë¡œ ì‘ì„±.
- ê¸°íƒ€ ë§ˆì¼“ : ìœ„ ë‘ ìŠ¤íƒ€ì¼ì˜ ì¤‘ê°„ í†¤ì„ ìœ ì§€í•˜ëŠ” ì¼ë°˜ ì‡¼í•‘ëª° ìƒí’ˆëª… ëŠë‚Œìœ¼ë¡œ ì‘ì„±.

[4. ì‘ì„± ìŠ¤íƒ€ì¼ ë° ë‚´ë¶€ ì ê²€ (ì¶œë ¥ ê¸ˆì§€)]
- ìŠ¤íƒ€ì¼:
  - ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ **ëª…ì‚¬êµ¬**ë¡œë§Œ ì‘ì„±í•©ë‹ˆë‹¤.
  - â€œ~í•©ë‹ˆë‹¤, ~í•´ìš”, ì–´ë– ì„¸ìš”?â€ ê°™ì€ ë¬¸ì¥í˜• í‘œí˜„, ì„¤ëª…ë¬¸, ê°íƒ„ë¬¸ì€ ê¸ˆì§€í•©ë‹ˆë‹¤.
- ë‚´ë¶€ ì ê²€(ë¨¸ë¦¿ì†ì—ì„œë§Œ ìˆ˜í–‰, ì¶œë ¥ ê¸ˆì§€):
  1) JSONì—ì„œ ë‹¤ìŒì„ ì •ë¦¬í–ˆëŠ”ì§€ ìŠ¤ìŠ¤ë¡œ í™•ì¸:
     - í•µì‹¬ ì¹´í…Œê³ ë¦¬
     - ê³ ê°ì˜ ì£¼ìš” ë¬¸ì œ/ìš•êµ¬ 1~2ê°œ
     - ê·¸ ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” í•µì‹¬ ê¸°ëŠ¥Â·íš¨ê³¼ 2~3ê°œ
     - ëŒ€í‘œ ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤ 1~2ê°œ
  2) ê¸°ëŠ¥ ê°•ì¡°í˜• / ìƒí™© ê°•ì¡°í˜• / ê°ì„±Â·ìŠ¤íƒ€ì¼ ê°•ì¡°í˜• ë“±
     ì„œë¡œ ë‹¤ë¥¸ íŒ¨í„´ì˜ í›„ë³´ë¥¼ ì„¤ê³„í–ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
  3) ê° í›„ë³´ì— ëŒ€í•´:
     - ê¸€ììˆ˜ ì œí•œ ì¤€ìˆ˜ ì—¬ë¶€
     - ë¸Œëœë“œÂ·ê´‘ê³ ì–´Â·ê¸°í˜¸ ì‚¬ìš© ì—¬ë¶€
     - í›„ë³´ë“¤ë¼ë¦¬ êµ¬ì¡°Â·í‚¤ì›Œë“œê°€ ì§€ë‚˜ì¹˜ê²Œ ë¹„ìŠ·í•˜ì§€ ì•Šì€ì§€
     - search_keywordsì˜ ì¤‘ìš”í•œ í‚¤ì›Œë“œê°€ ìì—°ìŠ¤ëŸ½ê²Œ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ ì ê²€í•©ë‹ˆë‹¤.
- ì´ ë‚´ë¶€ ì ê²€ ê³¼ì •ê³¼ ì´ìœ ëŠ” ì–´ë–¤ í˜•íƒœë¡œë„ ì¶œë ¥í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.

[5. ìµœì¢… ì¶œë ¥ í˜•ì‹]
- ë²ˆí˜¸(1.), ë¶ˆë¦¿(â€“, â€¢), ë”°ì˜´í‘œ, â€œí›„ë³´:â€ ê°™ì€ ë¼ë²¨ ì—†ì´
  **ì™„ì„±ëœ ìƒí’ˆëª… í…ìŠ¤íŠ¸ë§Œ í•œ ì¤„ì— í•˜ë‚˜ì”©** ì¶œë ¥í•©ë‹ˆë‹¤.
- `ì¶œë ¥ ê°œìˆ˜` ì´ë‚´ì—ì„œ, ì„œë¡œ ë‹¤ë¥¸ ê´€ì ê³¼ êµ¬ì¡°ë¥¼ ê°€ì§„ **ê³ í’ˆì§ˆ í›„ë³´ë§Œ** ìƒì„±í•˜ì‹­ì‹œì˜¤.
"""


# ============================================================
#  ìœ í‹¸ í•¨ìˆ˜: safe_str, fmt_safe
#  - Stage 2ì™€ ë™ì¼ íŒ¨í„´ ìœ ì§€ (NaN â†’ "", str ë³€í™˜, ì¤‘ê´„í˜¸ ì´ìŠ¤ì¼€ì´í”„)
# ============================================================
def safe_str(v: Any) -> str:
    """
    NaN/None ì•ˆì „í•˜ê²Œ ë¬¸ìì—´ë¡œ ë³€í™˜ + strip.
    """
    if v is None:
        return ""
    try:
        if pd.isna(v):
            return ""
    except Exception:
        pass
    return str(v).strip()


def fmt_safe(v: Any) -> str:
    """
    str(v)ë¥¼ í•œ ë²ˆ ê°ì‹¼ ë’¤, .format()ì— ì•ˆì „í•˜ê²Œ ë„£ê¸° ìœ„í•œ ì´ìŠ¤ì¼€ì´í”„.
    - { â†’ {{, } â†’ }}
    """
    s = safe_str(v)
    return s.replace("{", "{{").replace("}", "}}")


# ============================================================
#  dataclass ì •ì˜
# ============================================================
@dataclass
class Stage3Settings:
    """
    Stage 3 ì „ì—­/ê¸°ë³¸ ì„¤ì •.
    - market         : ë§ˆì¼“ëª… (ë„¤ì´ë²„ / ì¿ íŒ¡ / 11ë²ˆê°€ / ì§€ë§ˆì¼“ / ì˜¥ì…˜ / ê¸°íƒ€)
    - max_len        : ìµœëŒ€ ê¸€ì ìˆ˜ (None ë˜ëŠ” 0/ì´í•˜ëŠ” ê¸°ë³¸ 50ìœ¼ë¡œ ì²˜ë¦¬)
    - num_candidates : ì¶œë ¥ í›„ë³´ ê°œìˆ˜ (Noneì´ë©´ "ìë™", ëŒ€ëµ 10ê°œ)
    - naming_strategy: "í†µí•©í˜•" / "ì˜µì…˜í¬í•¨í˜•" / ê¸°íƒ€(í–¥í›„ í™•ì¥ìš©)
    """
    market: str = "ë„¤ì´ë²„"
    max_len: int = 50
    num_candidates: Optional[int] = None
    naming_strategy: str = "í†µí•©í˜•"


@dataclass
class Stage3Request:
    """
    Stage 3 í•œ í–‰(row)ì— ëŒ€í•œ ìµœì¢… ìš”ì²­ ì •ë³´ (ìºì‹± ìµœì í™” ë²„ì „).
    - system_prompt  : ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (ì •ì , ëª¨ë“  ìš”ì²­ì—ì„œ ë™ì¼)
    - user_prompt    : ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ (ë™ì  ë°ì´í„° í¬í•¨)
    - market         : í•´ì„ìš© ë§ˆì¼“ëª…
    - max_len        : ì‹¤ì œë¡œ ì§€í‚¤ë„ë¡ ìš”êµ¬í•  ìµœëŒ€ ê¸€ì ìˆ˜
    - num_candidates : ìš”êµ¬ í›„ë³´ ìˆ˜ (Noneì´ë©´ ìë™)
    - naming_strategy: í†µí•©í˜• / ì˜µì…˜í¬í•¨í˜• ë“±
    - raw_json       : ST2_JSON ì›ë³¸ ë¬¸ìì—´ (ë””ë²„ê¹…ìš©)
    """
    system_prompt: str
    user_prompt: str
    market: str
    max_len: int
    num_candidates: Optional[int]
    naming_strategy: str
    raw_json: str


# ============================================================
#  ë‚´ë¶€ ìœ í‹¸: ì •ìˆ˜ íŒŒì‹±
# ============================================================
def _coerce_positive_int(v: Any) -> Optional[int]:
    """
    ì—‘ì…€ ì…€ ê°’ ë“±ì—ì„œ ì–‘ì˜ ì •ìˆ˜ë¡œ í•´ì„ ê°€ëŠ¥í•œ ê²½ìš° intë¡œ ë³€í™˜, ì•„ë‹ˆë©´ None.
    - "50", "50.0", 50, 50.0 ë“±ì€ 50ìœ¼ë¡œ ë³€í™˜
    - 0, ìŒìˆ˜, ë¹ˆ ë¬¸ìì—´, NaN, None ë“±ì€ None
    """
    if v is None:
        return None
    try:
        # pandas NaN ì²˜ë¦¬
        if isinstance(v, float) and pd.isna(v):
            return None
        if isinstance(v, (int,)):
            if v <= 0:
                return None
            return int(v)
        if isinstance(v, float):
            if v <= 0:
                return None
            return int(v)
        s = str(v).strip()
        if not s:
            return None
        val = float(s)
        if val <= 0:
            return None
        return int(val)
    except Exception:
        return None


# ============================================================
#  Stage3 ì„¤ì •/í”„ë¡¬í”„íŠ¸ ë¹Œë”
# ============================================================
def build_stage3_settings_from_row(
    row: "pd.Series",
    default: Optional[Stage3Settings] = None,
) -> Stage3Settings:
    """
    í•œ í–‰(row)ì—ì„œ ST3_* ê´€ë ¨ ì»¬ëŸ¼ì„ ì½ì–´ Stage3Settingsë¥¼ êµ¬ì„±.
    - defaultê°€ ì£¼ì–´ì§€ë©´, í–‰ ë‹¨ìœ„ ì„¤ì •ì´ ë¹„ì–´ ìˆì„ ë•Œ ê·¸ ê°’ì„ ì‚¬ìš©.
    - defaultê°€ ì—†ìœ¼ë©´, Stage3Settings() ê¸°ë³¸ê°’ ì‚¬ìš©.
    """
    if default is None:
        default = Stage3Settings()

    # 1) ë§ˆì¼“
    market_cell = safe_str(row.get("ST3_ë§ˆì¼“", ""))
    market = market_cell or default.market or "ë„¤ì´ë²„"

    # 2) ìµœëŒ€ê¸€ììˆ˜
    max_len_cell = row.get("ST3_ìµœëŒ€ê¸€ììˆ˜", None)
    max_len_parsed = _coerce_positive_int(max_len_cell)
    if max_len_parsed is None:
        max_len_parsed = _coerce_positive_int(default.max_len) or 50

    # 3) ì¶œë ¥ê°œìˆ˜
    num_candidates_cell = row.get("ST3_ì¶œë ¥ê°œìˆ˜", None)
    num_candidates_parsed = _coerce_positive_int(num_candidates_cell)
    if num_candidates_parsed is None:
        # default.num_candidatesê°€ Noneì´ë©´ ê·¸ëŒ€ë¡œ None ìœ ì§€ â†’ "ìë™" ëª¨ë“œ
        num_candidates_parsed = default.num_candidates

    # 4) ëª…ëª…ì „ëµ
    strategy_cell = safe_str(row.get("ST3_ëª…ëª…ì „ëµ", ""))
    naming_strategy = strategy_cell or default.naming_strategy or "í†µí•©í˜•"

    return Stage3Settings(
        market=market,
        max_len=max_len_parsed,
        num_candidates=num_candidates_parsed,
        naming_strategy=naming_strategy,
    )


def build_stage3_prompt(
    json_body: str,
    settings: Stage3Settings,
) -> tuple[str, str]:
    """
    Stage 2 JSON ë¬¸ìì—´(json_body)ê³¼ Stage3Settingsë¥¼ ë°›ì•„
    system_promptì™€ user_promptë¥¼ ìƒì„± (ìºì‹± ìµœì í™” ë²„ì „).
    
    Returns:
        (system_prompt, user_prompt) íŠœí”Œ
    """
    if not json_body:
        raise ValueError("Stage 3 í”„ë¡¬í”„íŠ¸ë¥¼ ë§Œë“¤ê¸° ìœ„í•´ì„œëŠ” ST2_JSON(ë‚´ìš©)ì´ í•„ìš”í•©ë‹ˆë‹¤.")

    # num_candidatesëŠ” í”„ë¡¬í”„íŠ¸ ìƒì—ì„œ ë¹„ì›Œë‘ë©´ "ìë™" ëª¨ë“œë¡œ ë™ì‘
    if settings.num_candidates is None:
        # ë¹„ì–´ ìˆìœ¼ë©´ í”„ë¡¬í”„íŠ¸ ìƒì—ì„œ ê°’ ì—†ì´ ë‘ì–´ "ìë™" ë™ì‘ ìœ ë„
        num_candidates_display = ""
    else:
        num_candidates_display = str(settings.num_candidates)

    # System í”„ë¡¬í”„íŠ¸ëŠ” í•­ìƒ ë™ì¼ (ì •ì )
    system_prompt = STAGE3_SYSTEM_PROMPT

    # User í”„ë¡¬í”„íŠ¸ëŠ” ë™ì  ë°ì´í„°ë§Œ í¬í•¨
    user_prompt = STAGE3_USER_PROMPT_TEMPLATE.format(
        market=fmt_safe(settings.market),
        max_len=settings.max_len if settings.max_len > 0 else 50,
        num_candidates=num_candidates_display,
        naming_strategy=fmt_safe(settings.naming_strategy),
        json_body=fmt_safe(json_body),
    )
    
    return (system_prompt, user_prompt)


def build_stage3_request_from_row(
    row: "pd.Series",
    default_settings: Optional[Stage3Settings] = None,
    st2_col: str = "ST2_JSON",
) -> Stage3Request:
    """
    ì—‘ì…€ í•œ í–‰(row)ê³¼ ì „ì—­ ê¸°ë³¸ ì„¤ì •(default_settings)ì„ ë°›ì•„
    Stage3Requestë¥¼ ìƒì„±í•œë‹¤.

    ì‚¬ìš© ì˜ˆ)
        settings_global = Stage3Settings(market="ë„¤ì´ë²„", max_len=50, num_candidates=None)
        for idx, row in df.iterrows():
            req = build_stage3_request_from_row(row, settings_global)
            # req.promptë¥¼ OpenAI Responses APIì— ì „ë‹¬
    """
    # 1) ST2_JSON í™•ë³´
    raw_json = safe_str(row.get(st2_col, ""))
    if not raw_json:
        raise ValueError(
            f"í–‰ì— '{st2_col}' ê°’ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. "
            "ë¨¼ì € Stage 2(JSON ì¶”ì¶œ)ë¥¼ ì™„ë£Œí•´ì•¼ Stage 3ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        )

    # 2) í–‰ ë‹¨ìœ„ + ì „ì—­ ì„¤ì •ì„ í•©ì³ ìµœì¢… Stage3Settings êµ¬ì„±
    settings = build_stage3_settings_from_row(row, default_settings)

    # 3) í”„ë¡¬í”„íŠ¸ ìƒì„± (ìºì‹± ìµœì í™”: system/user ë¶„ë¦¬)
    system_prompt, user_prompt = build_stage3_prompt(raw_json, settings)

    return Stage3Request(
        system_prompt=system_prompt,
        user_prompt=user_prompt,
        market=settings.market,
        max_len=settings.max_len,
        num_candidates=settings.num_candidates,
        naming_strategy=settings.naming_strategy,
        raw_json=raw_json,
    )
