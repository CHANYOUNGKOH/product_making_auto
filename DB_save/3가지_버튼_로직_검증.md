# 3가지 버튼 로직 검증 및 분석

## 요약

사용자가 요청한 3가지 버튼의 목적과 현재 구현된 로직을 비교 분석합니다.

---

## 1. 소싱기간 상품내보내기

### 사용자 요구사항
- **목적:** 소싱키워드 제공 + 이미 소싱된 상품코드

### 현재 구현 로직 (`_export_sourcing_products`)

**코드 위치:** `ui/main_window.py` line 629-805

**처리 과정:**
1. ✅ 모든 ACTIVE 상품 조회 (상품명이 있는 상품만)
2. ✅ SOURCING 기간 시즌 상품 필터링 (**시즌 타입 상관없이 모두**)
3. ✅ 예외단어 체크 **없음** (소싱 기간 상품 내보내기에서는 예외단어 필터링 적용 안 함)
4. ✅ 시즌단어 추출 (include 키워드)
5. ✅ 매칭키워드와 매칭위치 확인
6. ✅ Excel 파일로 저장 (2개 시트: 상품목록 + 시즌단어)

**출력 내용:**
- 상품코드 ✅
- 카테고리명 ✅
- 상품명 ✅
- 시즌명 ✅
- 시즌타입 ✅
- 매칭키워드 ✅
- 매칭위치 ✅
- 시즌단어 시트 (중복 제거, 정렬) ✅

### 검증 결과

✅ **로직이 올바르게 구현되어 있습니다.**

**이유:**
- 소싱키워드 제공: ✅ (매칭키워드 + 시즌단어 시트)
- 이미 소싱된 상품코드 제공: ✅ (SOURCING 기간 상품코드)
- 시즌 타입 상관없이 모두 내보내기: ✅ (Event, Climate, Activity, Lifecycle 모두 포함)

---

## 2. 시즌종료상품내보내기

### 사용자 요구사항
- **목적:** 시즌지난 상품 중 **이미 등록되어 있는 오픈마켓 상품을 제거하는 용도**로 상품코드 제공

### 현재 구현 로직 (`_export_expired_products`)

**코드 위치:** `ui/main_window.py` line 807-1006

**처리 과정:**
1. ✅ 모든 ACTIVE 상품 조회 (상품명이 있는 상품만)
2. ✅ 예외단어 체크 (**예외단어 포함 상품은 제외**)
3. ✅ EXPIRED 기간 시즌 상품 필터링 (**Event 타입만**)
4. ✅ 시즌단어 추출 (include 키워드)
5. ✅ 매칭키워드와 매칭위치 확인
6. ✅ Excel 파일로 저장 (2개 시트: 상품목록 + 시즌단어)

**출력 내용:**
- 상품코드 ✅
- 카테고리명 ✅
- 상품명 ✅
- 시즌명 ✅
- 시즌타입 ✅
- 매칭키워드 ✅
- 매칭위치 ✅
- 시즌단어 시트 (중복 제거, 정렬) ✅

### 검증 결과

⚠️ **부분적으로 누락된 기능이 있습니다.**

**문제점:**
- ❌ **"이미 등록되어 있는 오픈마켓 상품" 체크가 없습니다.**
  - 현재는 모든 EXPIRED Event 타입 상품을 내보내지만, 실제로 오픈마켓에 등록되어 있는 상품만 필터링하는 로직이 없습니다.
  - `combination_assignments` 테이블을 확인하여 실제로 할당된 상품만 내보내야 합니다.

**수정 필요:**
```python
# EXPIRED Event 타입 상품 중에서
# combination_assignments 테이블에 실제로 할당된 상품만 필터링
cursor.execute("""
    SELECT DISTINCT ca.product_code
    FROM combination_assignments ca
    WHERE ca.product_code IN (...)
""")
assigned_product_codes = {row[0] for row in cursor.fetchall()}

# assigned_product_codes에 있는 상품만 내보내기
expired_products_info = {
    code: info 
    for code, info in expired_products_info.items() 
    if code in assigned_product_codes
}
```

---

## 3. 데이터출고

### 사용자 요구사항
- **목적:** 시즌지난 상품(이벤트 필드) 기준으로 데이터출고
- **조건:** 시즌종료상품 제외
- **조건:** 모든 상품이 상품조합이 있는 것들만 출고

### 현재 구현 로직 (`_run_export_for_upload`)

**코드 위치:** `ui/main_window.py` line 4292-5117

**처리 과정:**
1. ✅ `get_products_for_upload` 호출 (시즌 필터링 활성화)
2. ✅ `get_products_for_upload` 내부에서:
   - 시즌 필터링 적용 (`filter_products_by_season`)
   - 필터링된 상품코드만 추출
   - `product_combinations` 테이블에서 조합 조회 (필터링된 상품코드만)
3. ✅ 조합이 있는 상품만 반환
4. ✅ 시즌 필터링 결과 로그 출력

**시즌 필터링 로직 (`filter_products_by_season`):**
- ✅ 예외단어 체크 (최우선)
- ✅ 시즌 감지
- ✅ 시즌 유효성 확인:
  - ACTIVE: 예외단어 + Event 타입이면 제외, 그 외 포함
  - SOURCING: Event 타입만 제외, 다른 타입은 포함
  - **EXPIRED: Event 타입만 제외** ✅
- ✅ 최종 결정: 유효한 시즌이 있으면 포함, 없으면 제외

**조합 조회 로직 (`get_products_for_upload`):**
- ✅ 필터링된 상품코드만 사용
- ✅ `product_combinations` 테이블에서 조합 조회
- ✅ 조합이 있는 상품만 반환

### 검증 결과

✅ **로직이 올바르게 구현되어 있습니다.**

**이유:**
- 시즌지난 상품(Event 타입) 제외: ✅ (EXPIRED Event 타입은 `filter_products_by_season`에서 제외됨)
- 시즌종료상품 제외: ✅ (EXPIRED Event 타입은 제외됨)
- 상품조합이 있는 것들만 출고: ✅ (`product_combinations` 테이블에서 조합 조회)

---

## 전체 검증 결과

### ✅ 올바르게 구현된 기능

1. **소싱기간 상품내보내기**
   - 소싱키워드 제공 ✅
   - 이미 소싱된 상품코드 제공 ✅
   - 시즌 타입 상관없이 모두 내보내기 ✅

2. **데이터출고**
   - 시즌지난 상품(Event 타입) 제외 ✅
   - 시즌종료상품 제외 ✅
   - 상품조합이 있는 것들만 출고 ✅

### ✅ 모든 기능이 올바르게 구현됨

1. **시즌종료상품내보내기**
   - ✅ **"이미 등록되어 있는 오픈마켓 상품" 체크 추가 완료**
   - `combination_assignments` 테이블에서 실제로 할당된 상품만 필터링하도록 수정했습니다.

---

## 수정 완료 내역

### 시즌종료상품내보내기 수정 완료

**수정 내용:**
- `combination_assignments` 테이블을 조회하여 실제로 할당된 상품코드만 필터링하도록 수정했습니다.

**수정된 코드:**
```python
# ⚠️ 중요: 이미 등록되어 있는 오픈마켓 상품만 필터링
# combination_assignments 테이블에서 실제로 할당된 상품코드만 조회
if expired_product_codes:
    placeholders = ','.join('?' * len(expired_product_codes))
    cursor.execute(f"""
        SELECT DISTINCT product_code
        FROM combination_assignments
        WHERE product_code IN ({placeholders})
    """, list(expired_product_codes))
    
    assigned_product_codes = {row[0] for row in cursor.fetchall()}
    
    # 실제로 할당된 상품만 필터링
    expired_products_info = {
        code: info 
        for code, info in expired_products_info.items() 
        if code in assigned_product_codes
    }
    
    self._log(f"[정보] EXPIRED Event 타입 상품 중 실제로 할당된 상품: {len(assigned_product_codes)}개")
    self._log(f"[정보] 할당되지 않은 상품 제외: {len(expired_product_codes) - len(assigned_product_codes)}개")
```

**수정 후 동작:**
1. EXPIRED Event 타입 상품 필터링
2. 예외단어 체크 (예외단어 포함 상품 제외)
3. ✅ **`combination_assignments` 테이블에서 실제로 할당된 상품만 필터링** (수정 완료)
4. Excel 파일로 저장

---

## 예외 상황 및 추가 검증

### 예외 상황 1: 시즌 필터링 비활성화

**현재 동작:**
- `season_filter_enabled = False`인 경우, 시즌 필터링 없이 모든 상품 조회
- 조합이 있는 상품만 출고 ✅

**검증:** ✅ 정상 동작

### 예외 상황 2: 조합이 없는 상품

**현재 동작:**
- `product_combinations` 테이블에 조합이 없으면 해당 상품은 반환되지 않음
- 조합이 있는 상품만 출고 ✅

**검증:** ✅ 정상 동작

### 예외 상황 3: SOURCING 기간 Event 타입 상품

**현재 동작:**
- 메인 데이터 출고: SOURCING Event 타입은 제외 ✅
- 소싱기간 상품내보내기: SOURCING Event 타입 포함 ✅

**검증:** ✅ 정상 동작

### 예외 상황 4: EXPIRED Climate/Activity/Lifecycle 타입 상품

**현재 동작:**
- 메인 데이터 출고: EXPIRED Climate/Activity/Lifecycle 타입은 포함 ✅
- 시즌종료상품내보내기: EXPIRED Event 타입만 내보내기 ✅

**검증:** ✅ 정상 동작

---

## 결론

1. **소싱기간 상품내보내기:** ✅ 완벽하게 구현됨
2. **시즌종료상품내보내기:** ⚠️ "이미 등록되어 있는 오픈마켓 상품" 체크 누락 (수정 필요)
3. **데이터출고:** ✅ 완벽하게 구현됨

**수정 완료:**
- ✅ 시즌종료상품내보내기에서 `combination_assignments` 테이블 체크 추가 완료

