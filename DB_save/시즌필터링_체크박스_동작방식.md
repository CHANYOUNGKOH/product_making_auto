# 시즌 필터링 활성화 체크박스 동작 방식 (단계별 설명)

## 개요

시즌 필터링 활성화 체크박스는 데이터 출고 시 **현재 날짜 기준으로 시즌이 지난 상품을 자동으로 제외**할지 여부를 결정하는 옵션입니다.

**위치:** 메인 화면 → "마켓 업로드용" 모드 → "🗓️ 시즌 필터링 활성화" 체크박스

**기본값:** ✅ 체크됨 (활성화)

---

## 단계별 동작 과정

### 단계 1: 체크박스 생성 및 초기화

**코드 위치:** `ui/main_window.py` line 417-428

```python
# 시즌 필터링 옵션 (마켓 업로드용일 때만 표시)
self.season_filter_var = tk.BooleanVar(value=True)  # 기본값: True (활성화)
self.season_filter_checkbox = ttk.Checkbutton(
    self.btn_frame_action,
    text="🗓️ 시즌 필터링 활성화 (현재 시즌이 지난 상품 자동 제외)",
    variable=self.season_filter_var
)
```

**동작:**
- 애플리케이션 시작 시 체크박스가 생성됨
- 기본값은 **True (체크됨)** - 시즌 필터링이 활성화된 상태
- "마켓 업로드용" 모드일 때만 표시됨
- "미완료 DB" 모드일 때는 숨겨짐

---

### 단계 2: 사용자가 체크박스 상태 변경

**사용자 액션:**
- ✅ **체크됨 (활성화):** 시즌 필터링 적용
- ❌ **체크 해제 (비활성화):** 시즌 필터링 미적용

**예시:**
```
사용자가 체크박스를 클릭하여 상태 변경:
- 체크됨 → 체크 해제: season_filter_var.get() = False
- 체크 해제 → 체크됨: season_filter_var.get() = True
```

---

### 단계 3: 데이터 출고 시작 시 체크박스 상태 확인

**코드 위치:** `ui/main_window.py` line 4478-4483

```python
# 시즌 필터링 활성화 여부 가져오기
season_filter_enabled = getattr(self, 'season_filter_var', tk.BooleanVar(value=True)).get() if mode == "upload" else False

products = db_handler.get_products_for_upload(
    category, sheet_name, business_number, 
    exclude_assigned=exclude_assigned,
    season_filter_enabled=season_filter_enabled  # ← 체크박스 상태가 여기로 전달됨
)
```

**동작:**
1. 데이터 출고 버튼 클릭 시
2. 각 카테고리별로 상품 조회 전에 체크박스 상태 확인
3. `season_filter_var.get()` 값을 `season_filter_enabled` 변수에 저장
4. `get_products_for_upload()` 함수에 `season_filter_enabled` 파라미터로 전달

---

### 단계 4: 상품 조회 및 시즌 필터링 적용 여부 결정

**코드 위치:** `database/db_handler.py` line 592-667

```python
# 5. 시즌 필터링 적용 (활성화되어 있고 함수가 사용 가능한 경우)
self._last_season_filter_info = None  # 초기화

if season_filter_enabled and SEASON_FILTER_AVAILABLE:
    # 시즌 필터링 적용
    season_config = load_season_config(excel_path, json_path)
    if season_config:
        filtered_products, excluded_count, excluded_seasons, included_seasons, season_stats = filter_products_by_season(
            products_with_info, season_config
        )
        # 필터링된 상품코드만 사용
        filtered_product_codes = {p.get("상품코드") for p in filtered_products}
        products_with_info = [p for p in products_with_info if p.get("상품코드") in filtered_product_codes]
else:
    # 시즌 필터링 미적용 - 모든 상품 포함
    pass
```

**동작:**
- **체크됨 (season_filter_enabled = True):**
  1. 시즌 설정 파일 로드
  2. `filter_products_by_season()` 함수 호출
  3. 현재 날짜 기준으로 시즌 필터링 적용
  4. 필터링된 상품만 사용

- **체크 해제 (season_filter_enabled = False):**
  1. 시즌 필터링 로직 건너뜀
  2. 모든 상품 포함 (시즌과 무관)

---

### 단계 5: 필터링 결과 로그 출력

**코드 위치:** `ui/main_window.py` line 4486-4527

```python
# 시즌 필터링 결과 로그 출력
if season_filter_enabled:
    if hasattr(db_handler, '_last_season_filter_info') and db_handler._last_season_filter_info:
        season_info = db_handler._last_season_filter_info
        stats = season_info.get('season_stats', {})
        
        self._log(f"    📊 카테고리 '{category}' 시즌 필터링 결과:")
        self._log(f"      - 전체 상품: {total_before}개")
        self._log(f"      - 일반 상품: {stats.get('non_season', 0)}개")
        self._log(f"      - 시즌 상품 (포함): {stats.get('season_valid', 0)}개")
        self._log(f"      - 시즌 지난 상품 (제외): {stats.get('season_invalid', 0)}개")
        self._log(f"      - 최종 사용 가능: {total_after}개")
```

**동작:**
- **체크됨:** 상세한 시즌 필터링 통계 로그 출력
- **체크 해제:** 시즌 필터링 관련 로그 없음

---

## 실제 예시 시나리오

### 시나리오 1: 체크박스 활성화 (기본값)

**현재 날짜:** 2026-01-02

**상황:**
- 할로윈 시즌: 2026-10-01 ~ 2026-10-31 (EXPIRED)
- 크리스마스 시즌: 2026-11-10 ~ 2026-12-25 (EXPIRED)
- 한파 시즌: 2025-11-01 ~ 2026-02-15 (ACTIVE)

**체크박스 상태:** ✅ 체크됨

**처리 과정:**
1. 상품 조회: 1,000개 상품
2. 시즌 필터링 적용:
   - 할로윈 상품 50개 → 제외 (EXPIRED Event 타입)
   - 크리스마스 상품 30개 → 제외 (EXPIRED Event 타입)
   - 한파 상품 200개 → 포함 (ACTIVE)
   - 일반 상품 720개 → 포함
3. 최종 결과: 920개 상품 출고

**로그 출력:**
```
📊 카테고리 '가전/디지털' 시즌 필터링 결과:
  - 전체 상품: 1,000개
  - 일반 상품: 720개
  - 시즌 상품 (포함): 200개
  - 시즌 지난 상품 (제외): 80개
  - 최종 사용 가능: 920개
```

---

### 시나리오 2: 체크박스 비활성화

**현재 날짜:** 2026-01-02

**상황:**
- 할로윈 시즌: 2026-10-01 ~ 2026-10-31 (EXPIRED)
- 크리스마스 시즌: 2026-11-10 ~ 2026-12-25 (EXPIRED)
- 한파 시즌: 2025-11-01 ~ 2026-02-15 (ACTIVE)

**체크박스 상태:** ❌ 체크 해제

**처리 과정:**
1. 상품 조회: 1,000개 상품
2. 시즌 필터링 미적용:
   - 할로윈 상품 50개 → 포함
   - 크리스마스 상품 30개 → 포함
   - 한파 상품 200개 → 포함
   - 일반 상품 720개 → 포함
3. 최종 결과: 1,000개 상품 모두 출고

**로그 출력:**
```
(시즌 필터링 관련 로그 없음)
```

---

### 시나리오 3: 특정 시즌 상품만 필요할 때

**현재 날짜:** 2026-01-02

**상황:**
- 사용자가 할로윈 상품도 포함하여 출고하고 싶음
- 하지만 현재 날짜 기준으로는 할로윈 시즌이 지남 (EXPIRED)

**체크박스 상태:** ❌ 체크 해제

**처리 과정:**
1. 체크박스를 해제하여 시즌 필터링 비활성화
2. 모든 상품 (할로윈 포함) 출고 가능
3. 시즌이 지난 상품도 포함하여 출고

**사용 사례:**
- 특정 시즌 상품을 수동으로 선택하여 출고하고 싶을 때
- 시즌 필터링 설정이 잘못되어 모든 상품을 확인하고 싶을 때
- 테스트 목적으로 모든 상품을 출고하고 싶을 때

---

## 체크박스 상태별 비교표

| 체크박스 상태 | 시즌 필터링 적용 | EXPIRED Event 상품 | ACTIVE 시즌 상품 | 일반 상품 | 로그 출력 |
|------------|--------------|------------------|---------------|---------|---------|
| ✅ 체크됨 | ✅ 적용 | ❌ 제외 | ✅ 포함 | ✅ 포함 | ✅ 상세 통계 |
| ❌ 체크 해제 | ❌ 미적용 | ✅ 포함 | ✅ 포함 | ✅ 포함 | ❌ 없음 |

---

## 주의사항

### 1. 기본값이 활성화되어 있음
- 애플리케이션 시작 시 기본적으로 체크됨
- 시즌이 지난 상품이 자동으로 제외됨
- 의도치 않게 제외되는 것을 방지하려면 체크 해제 필요

### 2. 마켓 업로드용 모드에서만 표시
- "마켓 업로드용" 모드일 때만 체크박스 표시
- "미완료 DB" 모드일 때는 숨겨짐 (시즌 필터링 미지원)

### 3. 시즌 설정 파일 필요
- 시즌 필터링이 활성화되어 있으면 `Season_Filter_Seasons_Keywords.xlsx` 파일이 필요
- 파일이 없으면 경고 로그 출력 후 필터링 없이 진행

---

## 코드 참조

- **체크박스 생성:** `ui/main_window.py` line 417-428
- **체크박스 상태 확인:** `ui/main_window.py` line 4478
- **시즌 필터링 적용:** `database/db_handler.py` line 592-667
- **필터링 결과 로그:** `ui/main_window.py` line 4486-4527

---

## 요약

**시즌 필터링 활성화 체크박스는:**
1. ✅ **체크됨:** 현재 날짜 기준으로 시즌이 지난 상품(EXPIRED Event 타입)을 자동으로 제외
2. ❌ **체크 해제:** 시즌과 무관하게 모든 상품을 포함하여 출고

**기본값:** ✅ 체크됨 (시즌 필터링 활성화)

**사용 시점:** 데이터 출고 버튼 클릭 시 체크박스 상태를 확인하여 시즌 필터링 적용 여부 결정

