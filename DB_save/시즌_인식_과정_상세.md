# 시즌 인식 과정 상세 설명

## 📋 전체 프로세스

### 단계별 흐름
```
상품 입력
    ↓
1. 상품명 추출 (소문자 변환)
    ↓
2. 시즌 감지 (_detect_seasons_from_product)
   - exclude 키워드 확인
   - allowed 키워드 확인
   - include 키워드 확인
   - 점수 계산
    ↓
3. 시즌 유효성 확인 (_check_season_validity)
   - 날짜 파싱
   - 연도넘김 처리
   - 포함 기간 계산
    ↓
4. 최종 판정
   - validity == "INCLUDE" AND score >= score_min → 포함
   - 그 외 → 제외
```

---

## 🔍 1단계: 상품명 추출

```python
product_name = str(product.get('상품명', product.get('product_name', ''))).lower()
```

**동작**:
- 상품 딕셔너리에서 '상품명' 또는 'product_name' 키로 상품명 가져오기
- 대소문자 구분 설정이 False면 소문자로 변환
- 상품명이 없으면 시즌 감지 없이 통과

---

## 🔍 2단계: 시즌 감지 (_detect_seasons_from_product)

### 처리 순서

#### 1) exclude 키워드 확인
```python
if "일반용" in product_name:  # exclude 키워드
    score = 0
    has_exclude = True
```

**예시**:
- 상품명: "할로윈 호박 (일반용)"
- exclude 키워드: "일반용"
- 결과: `score = 0`, `has_exclude = True`

#### 2) allowed 키워드 확인 (exclude 예외 허용)
```python
if "장식용" in product_name:  # allowed 키워드
    has_allowed = True
    score = 0  # exclude를 무시하고 점수 초기화
```

**예시**:
- 상품명: "할로윈 호박 장식품 (일반용)"
- exclude: "일반용" → `score = 0`
- allowed: "장식용" → `has_allowed = True`, `score = 0` (초기화)

**중요**: allowed가 있으면 exclude를 무시합니다!

#### 3) include 키워드 확인 (점수 추가)
```python
if not has_exclude or has_allowed:  # exclude가 없거나 allowed로 예외 허용된 경우
    if "할로윈" in product_name:
        score += 2.0  # 가중치만큼 점수 추가
    if "호박" in product_name:
        score += 1.0
```

**예시**:
- 상품명: "할로윈 호박 장식품 (일반용)"
- exclude: "일반용" → `score = 0`
- allowed: "장식용" → `score = 0` (초기화)
- include: "할로윈" (가중치 2.0) → `score = 2.0`
- include: "호박" (가중치 1.0) → `score = 3.0`

**최종 결과**: `score = 3.0` → 할로윈 시즌으로 감지

### 점수 계산 예시

**시나리오 1: 일반 상품**
- 상품명: "기본 티셔츠"
- exclude: 없음
- allowed: 없음
- include: 없음
- 결과: `score = 0` → 시즌 감지 안 됨 → 통과

**시나리오 2: 시즌 상품 (exclude 없음)**
- 상품명: "할로윈 호박 장식품"
- exclude: 없음
- allowed: 없음
- include: "할로윈" (2.0), "호박" (1.0)
- 결과: `score = 3.0` → 할로윈 시즌 감지

**시나리오 3: exclude로 차단**
- 상품명: "할로윈 호박 (일반용)"
- exclude: "일반용"
- allowed: 없음
- include: "할로윈" (2.0), "호박" (1.0)
- 결과: `score = 0` (exclude가 있어서 include 점수 추가 안 됨) → 시즌 감지 안 됨

**시나리오 4: allowed로 예외 허용**
- 상품명: "할로윈 호박 장식품 (일반용)"
- exclude: "일반용"
- allowed: "장식용"
- include: "할로윈" (2.0), "호박" (1.0)
- 결과: `score = 3.0` (allowed로 예외 허용) → 할로윈 시즌 감지

---

## 🔍 3단계: 시즌 유효성 확인 (_check_season_validity)

### 날짜 파싱

**지원 형식**:
1. `"2024-12-01"` → `datetime(2024, 12, 1)`
2. `"2024/12/01"` → `datetime(2024, 12, 1)`
3. `"12-01"` → `datetime(현재연도, 12, 1)` (MM-DD 형식)
4. `"12/01"` → `datetime(현재연도, 12, 1)` (MM/DD 형식)

### 연도넘김 처리

**케이스 1: 일반 시즌 (연도넘김 없음)**
- 시작일: 06-01, 종료일: 08-31
- cross_year: False
- 결과: 현재 연도 06-01 ~ 현재 연도 08-31

**케이스 2: 겨울 시즌 (연도넘김 있음)**
- 시작일: 12-01, 종료일: 02-28
- cross_year: True
- 현재 날짜: 2025년 11월 15일
- 결과:
  - start_date: 2024-12-01 (이전 연도)
  - end_date: 2025-02-28 (현재 연도)

- 현재 날짜: 2025년 1월 15일
- 결과:
  - start_date: 2024-12-01 (이전 연도)
  - end_date: 2025-02-28 (현재 연도)

- 현재 날짜: 2025년 3월 15일
- 결과:
  - start_date: 2025-12-01 (현재 연도)
  - end_date: 2026-02-28 (다음 연도)

### 포함 기간 계산

```
포함 시작일 = 시즌시작일 - 소싱시작일수
포함 종료일 = 시즌종료일 - 가공완료마감일수

현재 날짜가 포함 시작일 ~ 포함 종료일 사이에 있으면 "INCLUDE"
그 외는 "EXCLUDE"
```

**예시**:
- 시즌 시작일: 2024-12-01
- 시즌 종료일: 2024-12-31
- 소싱시작일수: 30일
- 가공완료마감일수: 21일

**계산**:
- 포함 시작일: 2024-12-01 - 30일 = 2024-11-01
- 포함 종료일: 2024-12-31 - 21일 = 2024-12-10

**결과**:
- 현재 날짜가 2024-11-01 ~ 2024-12-10 사이: "INCLUDE"
- 그 외: "EXCLUDE"

---

## 🔍 4단계: 최종 판정

### 판정 조건

```python
if validity == "INCLUDE" and score >= score_min:
    # 상품 포함 (통과)
else:
    # 상품 제외
```

**예시 1: 포함**
- 감지된 시즌: 할로윈 (score=3.0)
- validity: "INCLUDE" (현재 날짜가 포함 기간 내)
- score_min: 2.0
- 결과: `3.0 >= 2.0` → 포함 ✅

**예시 2: 제외 (점수 부족)**
- 감지된 시즌: 할로윈 (score=1.0)
- validity: "INCLUDE"
- score_min: 2.0
- 결과: `1.0 < 2.0` → 제외 ❌

**예시 3: 제외 (기간 지남)**
- 감지된 시즌: 할로윈 (score=3.0)
- validity: "EXCLUDE" (현재 날짜가 포함 기간 밖)
- score_min: 2.0
- 결과: validity가 "EXCLUDE" → 제외 ❌

---

## 📊 전체 예시

### 예시: 할로윈 시즌 상품 (2024년 10월 15일)

**상품 정보**:
- 상품명: "할로윈 호박 장식품 (장식용)"

**시즌 설정**:
- 시즌 ID: halloween
- 시작일: 10-01
- 종료일: 10-31
- 소싱시작일수: 30일
- 가공완료마감일수: 21일
- score_min: 2.0

**키워드**:
- exclude: ["일반용"]
- allowed: ["장식용"]
- include: ["할로윈" (가중치 2.0), "호박" (가중치 1.0)]

**처리 과정**:

1. **상품명 추출**: "할로윈 호박 장식품 (장식용)" → 소문자 변환

2. **시즌 감지**:
   - exclude 확인: "일반용" 없음 → `has_exclude = False`
   - allowed 확인: "장식용" 있음 → `has_allowed = True`
   - include 확인: 
     - "할로윈" 있음 → `score += 2.0` → `score = 2.0`
     - "호박" 있음 → `score += 1.0` → `score = 3.0`
   - 결과: `(halloween, 3.0)` 감지됨

3. **유효성 확인**:
   - 날짜 파싱: `start_date = 2024-10-01`, `end_date = 2024-10-31`
   - 포함 시작일: 2024-10-01 - 30일 = 2024-09-01
   - 포함 종료일: 2024-10-31 - 21일 = 2024-10-10
   - 현재 날짜: 2024-10-15
   - 결과: `2024-09-01 <= 2024-10-15 <= 2024-10-10` → False ❌
   - validity: "EXCLUDE" (기간 지남)

4. **최종 판정**:
   - validity: "EXCLUDE"
   - 결과: 제외 ❌

**참고**: 10월 15일은 포함 종료일(10월 10일)을 지났으므로 제외됩니다.

---

## 🔧 주요 수정 사항

### 1. allowed 키워드 처리 추가 ✅
- exclude가 있어도 allowed가 있으면 예외 허용
- 예: "일반용"이 exclude여도 "장식용"이 allowed면 허용

### 2. 날짜 형식 "MM-DD" 지원 ✅
- Excel에서 "12-01" 형식으로 저장해도 파싱 가능
- 현재 연도를 자동으로 붙여서 처리

### 3. 연도넘김 로직 개선 ✅
- 겨울 시즌 (12-01 ~ 02-28) 처리가 올바르게 작동
- 시작일과 종료일의 연도를 올바르게 계산

---

## ⚠️ 주의사항

1. **exclude와 allowed의 우선순위**
   - exclude가 있어도 allowed가 있으면 allowed가 우선
   - allowed는 exclude의 예외를 허용하는 키워드

2. **날짜 형식**
   - "MM-DD" 형식은 현재 연도를 사용
   - 연도넘김 시즌은 연도 자동 조정

3. **포함 기간 계산**
   - 포함 종료일 = 시즌종료일 - 가공완료마감일수
   - 시즌 종료일 전에 이미 포함 종료일이 지날 수 있음
   - 예: 종료일 10-31, 가공완료마감 21일 → 포함 종료일 10-10

4. **점수 계산**
   - score_min보다 낮으면 제외됨
   - 여러 시즌이 감지되면 점수가 높은 시즌 우선

