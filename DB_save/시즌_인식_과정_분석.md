# 시즌 인식 과정 분석 및 수정 사항

## 📋 현재 시즌 인식 과정

### 1단계: 상품명 추출
```
상품 딕셔너리에서 '상품명' 또는 'product_name' 키로 상품명 가져오기
→ 소문자로 변환 (대소문자 구분 안 함)
```

### 2단계: 시즌 감지 (`_detect_seasons_from_product`)
```
각 시즌에 대해:
1. exclude 키워드 확인
   - 매칭되면 score = 0 설정하고 break
   
2. include 키워드 확인
   - 매칭되면 가중치만큼 score 추가
   
3. score > 0이면 감지된 시즌으로 기록
```

### 3단계: 시즌 유효성 확인 (`_check_season_validity`)
```
1. 시즌 시작일/종료일 파싱
2. 연도넘김 처리 (cross_year가 True인 경우)
3. 포함 기간 계산:
   - 시작: 시즌시작일 - 소싱시작일수
   - 종료: 시즌종료일 - 가공완료마감일수
4. 현재 날짜가 포함 기간 내에 있으면 "INCLUDE", 아니면 "EXCLUDE"
```

### 4단계: 최종 판정
```
감지된 시즌 중에서:
- validity == "INCLUDE"이고
- score >= score_min이면
→ 상품 포함 (통과)
→ 아니면 제외
```

---

## ❌ 발견된 문제점

### 문제 1: allowed 키워드 처리 누락 ⚠️
**현재 상태**: `_detect_seasons_from_product()` 함수에 `allowed` 키워드 처리 로직이 없음

**문제**: 
- exclude 키워드가 있어도 allowed 키워드가 있으면 허용해야 하는데
- 현재는 exclude가 있으면 무조건 0점으로 처리됨

**예시**:
- exclude: `일반용`
- allowed: `장식용`
- 상품명: "할로윈 호박 장식품 (일반용)"
- 현재: 제외됨 (exclude만 확인)
- 예상: 포함되어야 함 (allowed 키워드로 예외 허용)

### 문제 2: 날짜 형식 지원 부족
**현재 상태**: "%Y-%m-%d", "%Y/%m/%d" 형식만 지원

**문제**: Excel에서 "MM-DD" 형식으로 저장되는데, 이를 파싱하지 못함

**예시**:
- Excel: `10-01` (10월 1일)
- 현재: 파싱 실패 → 제외 처리

### 문제 3: exclude 키워드 후 include 체크 로직 문제
**현재 코드** (3057-3058줄):
```python
# include 키워드 매칭
if score > 0 or not keywords.get("exclude"):
```

**문제**: 
- exclude 키워드가 있어도 include를 체크함
- exclude가 매칭되면 score = 0이므로 의미 없음
- 하지만 allowed가 있어도 체크하지 않음

### 문제 4: 연도넘김 처리 로직
**현재 로직** (3118-3121줄):
```python
if cross_year and current_date.month < start_date.month:
    start_date = start_date.replace(year=current_date.year - 1)
    end_date = end_date.replace(year=current_date.year - 1)
```

**문제**:
- 종료일도 이전 연도로 조정하는데, 이게 항상 맞는지 확인 필요
- 예: 겨울 시즌 (12-01 ~ 02-28)
  - 현재가 1월 15일이면:
    - start_date: 2024-12-01 (이전 연도)
    - end_date: 2024-02-28 (이전 연도) ❌ 잘못됨!
    - 올바른 값: end_date는 현재 연도 또는 다음 연도여야 함

---

## ✅ 수정 완료

### 수정 1: allowed 키워드 처리 추가 ✅
```
1. exclude 키워드 확인 → score = 0 설정
2. allowed 키워드 확인 → exclude를 무시하고 score 복구
3. include 키워드 확인 → 점수 추가
```

**수정 내용**:
- `_detect_seasons_from_product()` 함수에 allowed 키워드 처리 로직 추가
- exclude가 있어도 allowed가 있으면 예외 허용

### 수정 2: 날짜 형식 "MM-DD" 지원 ✅
```
"MM-DD", "MM/DD" 형식도 파싱하도록 추가
현재 연도를 자동으로 붙여서 처리
```

**수정 내용**:
- `_parse_date_string()` 함수 추가
- "%Y-%m-%d", "%Y/%m/%d", "%m-%d", "%m/%d" 형식 모두 지원

### 수정 3: 연도넘김 로직 개선 ✅
```
종료일은 연도를 올바르게 처리:
- 겨울 시즌 (12-01 ~ 02-28)의 경우:
  - 11월: start_date = 이전 연도 12-01, end_date = 현재 연도 02-28
  - 12월~2월: start_date = 현재 연도 12-01, end_date = 다음 연도 02-28
  - 3월 이후: start_date = 현재 연도 12-01, end_date = 다음 연도 02-28
```

**수정 내용**:
- `_check_season_validity()` 함수의 연도넘김 로직 개선
- 시작일과 종료일의 연도를 올바르게 계산

---

## 🔍 상세 로직 흐름

### 현재 로직 (문제 있음)
```
1. 상품명: "할로윈 호박 장식품 (일반용)"
2. 시즌 감지:
   - exclude: "일반용" → 매칭 → score = 0
   - allowed: "장식용" → 체크 안 함 ❌
   - include: "할로윈", "호박" → 체크하지만 score가 0이라 의미 없음
3. 결과: score = 0 → 시즌 감지 안 됨 → 통과 (일반 상품으로 처리)
```

### 수정 후 로직
```
1. 상품명: "할로윈 호박 장식품 (일반용)"
2. 시즌 감지:
   - exclude: "일반용" → 매칭 → score = 0, has_exclude = True
   - allowed: "장식용" → 매칭 → has_allowed = True, score 복구
   - include: "할로윈" → 매칭 → score += 2.0
   - include: "호박" → 매칭 → score += 1.0
3. 결과: score = 3.0 → 할로윈 시즌으로 감지
4. 유효성 확인 → 기간 내이면 포함
```

---

## 📝 수정 작업 예정

1. `_detect_seasons_from_product()` 함수 수정
   - allowed 키워드 처리 추가
   - exclude/allowed/include 우선순위 로직 개선

2. `_check_season_validity()` 함수 수정
   - "MM-DD" 날짜 형식 지원
   - 연도넘김 로직 개선

3. 날짜 파싱 유틸리티 함수 추가
   - 다양한 형식 지원
   - 현재 연도 자동 추가

