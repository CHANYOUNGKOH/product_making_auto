# 시즌 필터 & 데이터 내보내기 실사용 가이드

## 📋 목차
1. [개요](#개요)
2. [시작하기](#시작하기)
3. [시즌 필터 설정 (초기 설정)](#시즌-필터-설정-초기-설정)
4. [데이터 내보내기 실전 사용법](#데이터-내보내기-실전-사용법)
5. [시나리오별 사용법](#시나리오별-사용법)
6. [주요 기능 설명](#주요-기능-설명)
7. [문제 해결](#문제-해결)

---

## 개요

### 시스템 구성
```
1. 시즌 필터 관리 도구 (season_filter_manager_gui.py)
   - 시즌 및 키워드 설정 관리
   - Excel 파일로 시즌 정보 저장

2. 데이터 내보내기 도구 (data_export.py)
   - DB에서 상품 데이터 추출
   - 마켓별/스토어별 데이터 출고
   - 시즌 필터 자동 적용
```

### 주요 기능
- ✅ **시즌 필터링**: 현재 시즌이 지난 상품 자동 제외
- ✅ **키워드 기반 감지**: 상품명에서 시즌 키워드 자동 감지
- ✅ **마켓별 출고**: 오픈마켓별로 독립적으로 상품 할당
- ✅ **중복 방지**: 이미 사용한 상품 조합 자동 제외
- ✅ **수량 제한**: 스토어별 상품 수량 제한 가능

---

## 시작하기

### 1. 프로그램 실행
```bash
# 데이터 내보내기 도구 실행
python data_export.py
```

### 2. 초기 화면 구성
```
┌─────────────────────────────────────────────────────────┐
│ 상품 업로드 관리 시스템                                   │
├─────────────────────────────────────────────────────────┤
│ 📋 마켓 계정 엑셀 파일  │ 💾 데이터베이스 파일          │
│ [엑셀 선택] [🔄]        │ [DB 선택] [💾]                │
├─────────────────────────────────────────────────────────┤
│ 📂 카테고리 선택         │ 🏪 마켓/스토어 선택           │
│ [트리뷰]                 │ [트리뷰]                      │
│ [전체 선택] [전체 해제]  │ [전체 선택] [전체 해제]      │
├─────────────────────────────────────────────────────────┤
│ 출력 모드: ○ 마켓 업로드용  ○ 미완료 DB                │
│ [🗓️ 시즌 필터 설정]                                     │
│ ☑ 🗓️ 시즌 필터링 활성화                                 │
│ ☑ 새로운 DB만 출력 (중복 제외)                           │
│ [▶ 데이터 출고]                                         │
├─────────────────────────────────────────────────────────┤
│ 로그 출력 창                                             │
└─────────────────────────────────────────────────────────┘
```

---

## 시즌 필터 설정 (초기 설정)

### ⚠️ 중요: 처음 사용 시 필수 작업

데이터 내보내기 전에 **반드시** 시즌 필터를 설정해야 합니다.

### 1단계: 시즌 필터 관리 창 열기

1. 데이터 내보내기 화면에서 **"🗓️ 시즌 필터 설정"** 버튼 클릭
2. 시즌 필터 관리 GUI 창이 열립니다

```
┌─────────────────────────────────────────────────────────┐
│ 시즌 필터링 설정 관리                                    │
├─────────────────────────────────────────────────────────┤
│ Excel 파일: [Season_Filter_Seasons_Keywords.xlsx]       │
│ [📂 파일 선택] [🔄 다시 로드]                            │
├─────────────────────────────────────────────────────────┤
│ 왼쪽 패널: 시즌 목록       │ 오른쪽 패널: 시즌 상세      │
│ - 할로윈                   │ 시즌 정보 수정              │
│ - 크리스마스               │ 키워드 관리                 │
│ - 새해                     │                            │
├─────────────────────────────────────────────────────────┤
│ [➕ 시즌 추가] [✏️ 시즌 수정] [🗑️ 시즌 삭제]            │
│ [💾 Excel 저장] [🔄 JSON 컴파일] [👁️ JSON 미리보기]     │
└─────────────────────────────────────────────────────────┘
```

### 2단계: 시즌 추가

#### 예시: 할로윈 시즌 추가

1. **"➕ 시즌 추가"** 버튼 클릭
2. 시즌 정보 입력:
   ```
   시즌 ID: halloween
   시즌명: 할로윈
   타입: Event
   시작일: 10-01          (MM-DD 형식)
   종료일: 10-31
   연도넘김: N
   소싱시작일수: 30일      (시즌 시작 30일 전부터 포함)
   가공완료마감일수: 21일  (시즌 종료 21일 전까지만 포함)
   점수최소값: 2.0         (시즌 감지를 위한 최소 점수)
   ```

3. **저장** 클릭

#### 예시: 겨울 시즌 추가 (연도넘김)

```
시즌 ID: winter
시즌명: 겨울
타입: Climate
시작일: 12-01
종료일: 02-28
연도넘김: Y              ⚠️ 중요: 연도를 넘는 시즌
소싱시작일수: 30일
가공완료마감일수: 21일
```

### 3단계: 키워드 추가

1. 왼쪽 패널에서 시즌 선택 (예: "할로윈")
2. 오른쪽 패널에서 **"➕ 키워드 추가"** 클릭

#### 키워드 타입 설명

**1. include (포함) 키워드**
- 시즌 상품 판단용 키워드
- 상품명에 포함되면 점수 추가
- 가중치 설정 가능 (기본값: 1.0)

**예시:**
```
키워드: 할로윈
타입: include
가중치: 2.0

키워드: 호박
타입: include
가중치: 1.0

키워드: 잭오랜턴
타입: include
가중치: 1.5
```

**2. exclude (제외) 키워드**
- 시즌 상품에서 제외할 키워드
- 상품명에 포함되면 시즌 감지 안 됨

**예시:**
```
키워드: 일반용
타입: exclude
가중치: 없음 (사용 안 함)
```

**3. allowed (예외 허용) 키워드**
- exclude의 예외를 허용하는 키워드
- exclude가 있어도 allowed가 있으면 허용

**예시:**
```
키워드: 장식용
타입: allowed
가중치: 없음 (사용 안 함)
```

**상황 설명:**
- 상품명: "할로윈 호박 장식품 (일반용)"
- exclude: "일반용" → 제외
- allowed: "장식용" → 예외 허용
- 결과: **포함됨** ✅ (allowed가 exclude를 무시)

### 4단계: Excel 저장 및 JSON 컴파일

1. **"💾 Excel 저장"** 클릭
   - Excel 파일에 시즌 및 키워드 정보 저장

2. **"🔄 JSON 컴파일"** 클릭
   - Excel → JSON 변환
   - 데이터 내보내기에서 사용할 수 있도록 준비

3. **"👁️ JSON 미리보기"** 클릭 (선택사항)
   - 컴파일된 JSON 내용 확인

### 5단계: 시즌 필터 관리 창 닫기

- 창을 닫으면 데이터 내보내기 화면으로 돌아옵니다
- 설정이 자동으로 저장되어 다음 출고부터 적용됩니다

---

## 데이터 내보내기 실전 사용법

### 1단계: 파일 설정

#### 1-1. 마켓 계정 엑셀 파일 선택
1. **"📂"** 버튼 클릭
2. `Market_id_pw.xlsx` 파일 선택
3. 파일이 로드되면 오른쪽 패널에 마켓/스토어 목록이 표시됩니다

**💡 팁:**
- 파일 수정 후에는 **"🔄 다시 로드"** 버튼 클릭

#### 1-2. 데이터베이스 파일 선택
1. **"📂"** 버튼 클릭
2. SQLite DB 파일 선택 (예: `products.db`)
3. DB 파일 선택 시 **카테고리 자동 로드**됩니다

**💡 팁:**
- 자주 사용하는 DB는 **"💾 기본 경로로 설정"** 클릭
- 다음 실행 시 자동으로 이 경로가 사용됩니다

### 2단계: 카테고리 선택

#### 왼쪽 패널: 카테고리 트리

**마켓 업로드용 모드:**
- 카테고리는 스토어 메모에서 지정됩니다
- 이 섹션은 **상품수 확인용 보조자료**로 사용됩니다

**미완료 DB 모드:**
- 카테고리를 선택하여 데이터를 출고합니다

**사용 방법:**
1. 트리뷰에서 원하는 카테고리 체크박스 클릭
2. **"전체 선택"** / **"전체 해제"** 버튼으로 일괄 선택
3. **"📂 전체 열기"** / **"📁 전체 닫기"**로 트리 펼치기/접기

**💡 팁:**
- 카테고리는 대>중 형식으로 표시됩니다
- DB 파일 선택 시 자동으로 로드됩니다

### 3단계: 출력 모드 선택

#### 모드 1: 마켓 업로드용 (완료된 DB)
- **목적**: 완료된 상품 데이터를 마켓에 업로드하기 위해 내보냄
- **필요 선택**: 카테고리 + 마켓/스토어

**주요 옵션:**
- ☑ **시즌 필터링 활성화**: 현재 시즌이 지난 상품 자동 제외
- ☑ **새로운 DB만 출력**: 이미 사용한 조합 자동 제외
- **출력 상품 수량 제한**: 각 스토어당 최대 상품 수량 설정

#### 모드 2: 미완료 DB (재가공용)
- **목적**: 미완료된 상품 데이터를 재가공하기 위해 내보냄
- **필요 선택**: 카테고리만 (마켓 선택 불필요)
- **미완료 기준**: ST3_결과상품명, 누끼url, 믹스url 중 하나라도 공백

### 4단계: 마켓/스토어 선택 (마켓 업로드용 모드만)

#### 오른쪽 패널: 마켓/스토어 트리

**컬럼 설명:**
- **마켓/스토어**: 오픈마켓 및 스토어 이름
- **메모/카테고리**: 스토어 메모 및 카테고리 정보
- **상품수**: 해당 스토어의 사용 가능한 상품 수
- **등록된 상품수량**: 스토어별 상품 수량 제한 (더블클릭으로 편집)

**사용 방법:**
1. 트리뷰에서 업로드할 마켓/스토어 체크박스 클릭
2. **"전체 선택"** / **"전체 해제"** 버튼으로 일괄 선택

**💡 메모 편집:**
1. 트리뷰에서 스토어 항목 더블클릭
2. 메모, 카테고리, 등록된 상품수량 편집 가능
3. **Enter** 키로 저장

**💡 등록된 상품수량 설정:**
- 더블클릭하여 숫자 입력
- 빈 값이면 전체 출고
- 예: "100" 입력 시 해당 스토어는 100개만 출력

### 5단계: 시즌 필터링 옵션 (마켓 업로드용 모드)

#### 시즌 필터링 활성화 체크박스

**☑ 체크됨 (기본값):**
- 시즌 필터링이 적용됩니다
- 현재 시즌이 지난 상품은 자동으로 제외됩니다
- 시즌 감지 로직:
  1. 상품명에서 키워드 확인
  2. 시즌 기간 확인 (소싱시작일수 ~ 가공완료마감일수)
  3. 점수 확인 (score >= score_min)

**☐ 체크 해제:**
- 시즌 필터링이 비활성화됩니다
- 모든 상품이 포함됩니다 (시즌과 무관)

**예시:**
```
오늘 날짜: 2024년 11월 15일
할로윈 시즌: 10-01 ~ 10-31
소싱시작일수: 30일 (9-01부터 포함)
가공완료마감일수: 21일 (10-10까지만 포함)

→ 11월 15일은 포함 기간을 지났으므로 할로윈 상품 제외
```

### 6단계: 출력 상품 수량 제한 (선택사항)

**위치**: 카테고리 선택 섹션 하단

**기능:**
- 각 스토어별로 출력할 최대 상품코드 수를 제한합니다
- 비워두면 전체 출고됩니다

**설정 방법:**
1. **"출력 제한"** 입력 필드에 숫자 입력 (예: 100)
2. 각 스토어당 100개씩만 출력됩니다

**💡 우선순위:**
- 출력 상품수 제한이 있으면 **우선적으로 출고된 적 없는 상품코드**가 먼저 출력됩니다

### 7단계: 데이터 출고

1. **"▶ 데이터 출고"** 버튼 클릭
2. 저장 폴더 선택
3. 엑셀 파일로 데이터가 내보내집니다

**진행 상황 확인:**
- 하단 로그창에서 실시간 진행 상황 확인
- 각 스토어별 처리 결과 표시

**출고 파일:**
- 파일명 형식: `[시트명]_[날짜]_[시간].xlsx`
- 각 시트(오픈마켓)별로 독립적인 파일 생성

---

## 시나리오별 사용법

### 시나리오 1: 할로윈 시즌 상품 출고 (10월)

**목표**: 할로윈 시즌 상품만 선택하여 출고

#### 1. 시즌 필터 설정 (이미 완료되어 있다면 생략)
```
시즌 ID: halloween
시작일: 10-01
종료일: 10-31
소싱시작일수: 30일
가공완료마감일수: 21일

키워드:
- 할로윈 (include, 가중치 2.0)
- 호박 (include, 가중치 1.0)
- 잭오랜턴 (include, 가중치 1.5)
```

#### 2. 데이터 내보내기
1. **마켓 업로드용 모드** 선택
2. DB 파일 선택
3. 카테고리 선택 (상품수 확인용)
4. 마켓/스토어 선택
5. **☑ 시즌 필터링 활성화** 확인
6. **"▶ 데이터 출고"** 클릭

**결과:**
- 할로윈 키워드가 포함된 상품만 출고됨
- 시즌 기간이 지난 상품은 자동 제외됨

### 시나리오 2: 겨울 시즌 상품 출고 (12월~2월)

**목표**: 겨울 시즌 상품을 연도넘김 처리하여 출고

#### 1. 시즌 필터 설정
```
시즌 ID: winter
시작일: 12-01
종료일: 02-28
연도넘김: Y  ⚠️ 중요!

키워드:
- 겨울 (include, 가중치 2.0)
- 눈 (include, 가중치 1.0)
- 스노우맨 (include, 가중치 1.5)
```

#### 2. 데이터 내보내기
- 시나리오 1과 동일한 절차

**특징:**
- 12월~2월 기간이 연도를 넘어도 올바르게 처리됩니다
- 현재 날짜가 12월이면 이전 연도 12-01 ~ 현재 연도 02-28로 계산

### 시나리오 3: 시즌 필터 없이 전체 상품 출고

**목표**: 시즌과 무관하게 모든 상품 출고

#### 절차:
1. **마켓 업로드용 모드** 선택
2. **☐ 시즌 필터링 활성화 체크 해제**
3. 나머지 절차는 동일

**결과:**
- 모든 상품이 포함됩니다 (시즌 감지 안 함)

### 시나리오 4: 특정 스토어만 제한 수량 출고

**목표**: A 스토어는 100개, B 스토어는 200개만 출고

#### 절차:
1. 마켓/스토어 트리뷰에서 스토어 선택
2. **"등록된 상품수량"** 컬럼 더블클릭
3. A 스토어: 100 입력
4. B 스토어: 200 입력
5. **"▶ 데이터 출고"** 클릭

**결과:**
- A 스토어: 100개만 출고
- B 스토어: 200개만 출고

### 시나리오 5: 미완료 상품 재가공

**목표**: 미완료된 상품만 추출하여 재가공

#### 절차:
1. **"미완료 DB" 모드** 선택
2. DB 파일 선택
3. 카테고리 선택
4. **"▶ 데이터 출고"** 클릭

**결과:**
- ST3_결과상품명, 누끼url, 믹스url 중 하나라도 공백인 상품만 출고

---

## 주요 기능 설명

### 1. 시즌 필터링 로직

#### 시즌 감지 과정
```
1. 상품명 추출
   ↓
2. 키워드 확인
   - exclude 키워드 확인 → 제외
   - allowed 키워드 확인 → 예외 허용
   - include 키워드 확인 → 점수 추가
   ↓
3. 시즌 기간 확인
   - 포함 시작일 = 시즌시작일 - 소싱시작일수
   - 포함 종료일 = 시즌종료일 - 가공완료마감일수
   - 현재 날짜가 포함 기간 내에 있는지 확인
   ↓
4. 최종 판정
   - validity == "INCLUDE" AND score >= score_min → 포함
   - 그 외 → 제외
```

#### 예시 계산
```
오늘: 2024-10-05
할로윈 시즌: 10-01 ~ 10-31
소싱시작일수: 30일
가공완료마감일수: 21일

포함 시작일: 2024-10-01 - 30일 = 2024-09-01
포함 종료일: 2024-10-31 - 21일 = 2024-10-10

→ 2024-10-05는 포함 기간 내 ✅
```

### 2. 중복 방지 시스템

#### 동작 방식
1. **전체 시트에 대해 동일 조합 추적**
   - 상품코드 + URL + 상품명 조합이 전체 시트에서 중복되지 않도록 관리
   
2. **조합 우선순위**
   - 믹스url > 누끼url
   - 첫 줄 상품명 > 다음 줄 상품명

3. **할당 기록**
   - `combination_assignments` 테이블에 기록
   - 다음 출고 시 자동으로 제외

#### 옵션: 새로운 DB만 출력
- **☑ 체크됨**: 같은 스토어 내 같은 상품코드 출력 불가
- **☐ 체크 해제**: 같은 스토어 내 같은 상품코드 출력 가능

### 3. 스토어별 수량 제한

#### 전체 수량 제한
- **위치**: 카테고리 선택 섹션 하단
- **기능**: 각 스토어별로 동일한 수량 제한 적용
- **예**: 100 입력 → 모든 스토어가 100개씩만 출력

#### 스토어별 개별 수량 제한
- **위치**: 마켓/스토어 트리뷰의 "등록된 상품수량" 컬럼
- **기능**: 스토어별로 다른 수량 설정 가능
- **예**: A 스토어 100개, B 스토어 200개

**우선순위:**
- 스토어별 개별 수량이 전체 수량보다 우선합니다

### 4. 스토어 메모 기능

#### 메모 편집
1. 트리뷰에서 스토어 항목 더블클릭
2. 메모 입력
3. **Enter** 키로 저장

#### 카테고리 지정
- 스토어별로 다른 카테고리 지정 가능
- 메모에 카테고리가 있으면 그것을 우선 사용
- 없으면 선택된 카테고리 사용

### 5. 출고 이력 조회

#### 기능
- **"📋 출고 히스토리"** 버튼 클릭
- 과거 출고 내역 확인
- 날짜 필터, 시트 필터로 검색 가능

---

## 문제 해결

### 문제 1: 시즌 필터가 작동하지 않음

**원인:**
- JSON 컴파일이 안 됨
- 시즌 설정이 잘못됨

**해결:**
1. 시즌 필터 관리 창 열기
2. **"🔄 JSON 컴파일"** 클릭
3. **"👁️ JSON 미리보기"**로 확인

### 문제 2: 시즌 상품이 제대로 감지되지 않음

**원인:**
- 키워드가 상품명과 일치하지 않음
- 점수가 score_min보다 낮음

**해결:**
1. 상품명 확인 (대소문자 구분 안 함)
2. 키워드 가중치 조정
3. score_min 값 낮추기

### 문제 3: 연도넘김 시즌이 잘못 처리됨

**원인:**
- cross_year 설정이 안 됨
- 날짜 형식이 잘못됨

**해결:**
1. 시즌 설정에서 **"연도넘김: Y"** 확인
2. 날짜 형식: "MM-DD" (예: "12-01")

### 문제 4: 중복 상품이 계속 출력됨

**원인:**
- "새로운 DB만 출력" 옵션이 체크 안 됨
- combination_assignments 테이블에 기록 안 됨

**해결:**
1. **"☑ 새로운 DB만 출력"** 옵션 체크 확인
2. 출고 후 자동으로 기록되는지 확인

### 문제 5: 스토어별 수량이 적용되지 않음

**원인:**
- "등록된 상품수량" 입력이 잘못됨
- 전체 수량 제한이 우선 적용됨

**해결:**
1. "등록된 상품수량" 컬럼 더블클릭하여 숫자 입력
2. 빈 값이면 전체 출고됨
3. 스토어별 개별 수량이 전체 수량보다 우선

---

## 💡 실전 팁

### 팁 1: 시즌 설정 미리 준비
- 시즌 시작 전에 미리 시즌 및 키워드 설정
- JSON 컴파일까지 완료

### 팁 2: 키워드 가중치 조정
- 중요한 키워드는 가중치를 높게 설정 (예: 2.0)
- 일반적인 키워드는 낮게 설정 (예: 1.0)

### 팁 3: exclude와 allowed 활용
- "일반용" 같은 제외 키워드는 exclude로 설정
- "장식용" 같은 예외는 allowed로 설정

### 팁 4: 수량 제한으로 테스트
- 처음에는 작은 수량(예: 10개)으로 테스트
- 결과 확인 후 전체 수량으로 출고

### 팁 5: 로그 확인
- 하단 로그창에서 진행 상황 실시간 확인
- 오류 발생 시 로그 확인하여 원인 파악

---

## 📞 추가 도움말

### 관련 문서
- `시즌필터링_사용방법_가이드.md`: 시즌 필터 관리 상세 가이드
- `시즌_인식_과정_상세.md`: 시즌 인식 로직 상세 설명

### 파일 위치
- 시즌 설정 파일: `Season_Filter_Seasons_Keywords.xlsx`
- JSON 설정 파일: `season_filters.json`
- 마켓 계정 파일: `Market_id_pw.xlsx`

---

**작성일**: 2025-01-01
**버전**: 1.0

