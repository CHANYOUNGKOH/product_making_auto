# 시즌 필터링 도구 완전 설계

## 📋 목차
1. [개요](#개요)
2. [핵심 요구사항](#핵심-요구사항)
3. [데이터 구조](#데이터-구조)
4. [키워드 시스템](#키워드-시스템)
5. [3가지 용도별 동작](#3가지-용도별-동작)
6. [필터링 로직](#필터링-로직)
7. [구현 설계](#구현-설계)
8. [사용 예시](#사용-예시)

---

## 개요

시즌 필터링 도구는 **기간 + 키워드** 기반으로 상품을 필터링하는 시스템입니다.

**핵심 목적:**
1. 외부 도매처에서 시즌 상품 소싱
2. 가공된 DB에서 시즌 상품만 추출
3. 마켓에 업로드된 시즌 외 상품 삭제 대상 찾기

**핵심 원칙:**
- **출고 시점 기준 필터링**: 출고 시점에 맞게 필요한 데이터만 출고
- **기간 기반 필터링**: 시작기간/종료기간 지정
- **키워드 기반 필터링**: 소싱 단어 + 금지어 + 예외 허용 문구

---

## 핵심 요구사항

### 1. 시즌 기간 지정
- **시작기간**: 시즌 시작 날짜 (MM-DD 형식)
- **종료기간**: 시즌 종료 날짜 (MM-DD 형식)
- **연도 넘김 지원**: 12-01 ~ 02-28 같은 경우 지원

### 2. 출고 시점 기준 필터링
- **출고 시점**: 데이터 출고 실행 시점의 날짜
- **필터링 기준**: 출고 시점이 시즌 기간 내에 있는지 확인
- **동적 필터링**: 매번 출고 시점에 맞게 자동 필터링

### 3. 마켓 업로드된 상품 삭제
- **시즌 외 상품**: 출고 시점 기준으로 시즌이 지난 상품
- **삭제 대상 추출**: 마켓에 업로드된 상품 중 시즌 외 상품 찾기
- **상품코드 리스트**: 삭제할 상품코드 리스트 출력

### 4. 키워드 시스템
- **소싱 단어 (include)**: 시즌 상품을 찾기 위한 기본 키워드
- **금지어 (exclude)**: 제외할 키워드 (중간에 겹치는 단어 처리)
- **예외 허용 문구 (allowed)**: 금지어가 있어도 허용하는 문구

### 5. 3가지 용도
1. **소싱 용도**: 외부에서 데이터 입고할 가공할 상품 찾기
2. **DB 필터링 용도**: 이미 가공된 DB 내에서 필요한 상품만 추출
3. **삭제 대상 찾기 용도**: 업로드된 마켓에서 지울 상품 찾기

---

## 데이터 구조

### Excel 파일 구조

**파일명**: `Season_Filter_Seasons_Keywords.xlsx`

#### 시트 1: SEASON_MASTER (시즌 기본 정보)

| 시즌ID | 시즌명 | 시작일 | 종료일 | 연도넘김 | 설명 | 용도 |
|--------|--------|--------|--------|----------|------|------|
| halloween | 할로윈 | 10-01 | 10-31 | FALSE | 할로윈 관련 상품 | 소싱,DB필터링,삭제 |
| christmas | 크리스마스 | 12-01 | 12-25 | FALSE | 크리스마스 관련 상품 | 소싱,DB필터링 |
| winter | 겨울 | 12-01 | 02-28 | TRUE | 겨울 시즌 상품 | 소싱,DB필터링 |

**컬럼 설명:**
- **시즌ID**: 고유 식별자 (영문 소문자, 언더스코어 사용)
- **시즌명**: 표시용 이름
- **시작일**: MM-DD 형식
- **종료일**: MM-DD 형식
- **연도넘김**: TRUE면 다음 해까지 포함 (예: 12-01 ~ 02-28)
- **설명**: 시즌 설명
- **용도**: 쉼표로 구분 (소싱, DB필터링, 삭제)

#### 시트 2: KEYWORDS (키워드 설정)

| 시즌ID | 키워드 | 타입 | 가중치 | 설명 |
|--------|--------|------|--------|------|
| halloween | 할로윈 | include | 1.0 | 소싱 단어 |
| halloween | 호박 | include | 1.0 | 소싱 단어 |
| halloween | 유령 | include | 1.0 | 소싱 단어 |
| halloween | 일반용 | exclude | 0.0 | 금지어 |
| halloween | 일반 호박 | exclude | 0.0 | 금지어 |
| halloween | 장식용 | allowed | 0.0 | 예외 허용 문구 |

**컬럼 설명:**
- **시즌ID**: SEASON_MASTER의 시즌ID와 연결
- **키워드**: 검색할 키워드
- **타입**: 
  - `include`: 소싱 단어 (매칭 시 점수 증가)
  - `exclude`: 금지어 (매칭 시 즉시 제외, 단 allowed가 있으면 예외)
  - `allowed`: 예외 허용 문구 (exclude가 있어도 허용)
- **가중치**: include 키워드의 가중치 (기본 1.0)
- **설명**: 키워드 설명

### JSON 구조 (컴파일 결과)

```json
{
  "version": "2.0",
  "settings": {
    "filter_mode": "exclude_expired",
    "case_sensitive": false,
    "default_score_min": 1
  },
  "seasons": [
    {
      "id": "halloween",
      "name": "할로윈",
      "start_date": "10-01",
      "end_date": "10-31",
      "cross_year": false,
      "description": "할로윈 관련 상품",
      "use_cases": ["소싱", "DB필터링", "삭제"],
      "keywords": {
        "include": [
          {"keyword": "할로윈", "weight": 1.0},
          {"keyword": "호박", "weight": 1.0},
          {"keyword": "유령", "weight": 1.0}
        ],
        "exclude": [
          {"keyword": "일반용", "weight": 0.0},
          {"keyword": "일반 호박", "weight": 0.0}
        ],
        "allowed": [
          {"keyword": "장식용", "weight": 0.0}
        ]
      }
    }
  ]
}
```

---

## 키워드 시스템

### 키워드 타입별 동작

#### 1. include (소싱 단어)
- **역할**: 시즌 상품을 찾기 위한 기본 키워드
- **동작**: 상품명에 포함되면 점수 증가
- **가중치**: 키워드별로 다른 가중치 설정 가능

**예시:**
```
상품명: "할로윈 호박 장식품"
include 키워드: ["할로윈", "호박"]
→ 점수: 1.0 + 1.0 = 2.0
```

#### 2. exclude (금지어)
- **역할**: 제외할 키워드 (중간에 겹치는 단어 처리)
- **동작**: 상품명에 포함되면 즉시 제외 (단, allowed가 있으면 예외)
- **우선순위**: include보다 우선 적용

**예시:**
```
상품명: "일반 호박 (할로윈 아님)"
include: ["호박"] → 점수: 1.0
exclude: ["일반 호박"] → 매칭 → 즉시 제외 ❌
```

#### 3. allowed (예외 허용 문구)
- **역할**: 금지어가 있어도 허용하는 문구
- **동작**: exclude가 매칭되어도 allowed가 있으면 통과
- **조건**: exclude와 allowed가 모두 매칭되어야 예외 적용

**예시:**
```
상품명: "할로윈 호박 장식용 (일반용 아님)"
include: ["할로윈", "호박"] → 점수: 2.0
exclude: ["일반용"] → 매칭
allowed: ["장식용"] → 매칭
→ exclude가 있어도 allowed가 있으므로 통과 ✅
```

### 키워드 매칭 순서

```
1. exclude 키워드 확인
   ├─ 매칭됨 → allowed 확인
   │   ├─ allowed 매칭됨 → 통과 (exclude 무시)
   │   └─ allowed 매칭 안됨 → 즉시 제외 ❌
   └─ 매칭 안됨 → 다음 단계
2. include 키워드 확인
   ├─ 매칭됨 → 점수 증가
   └─ 매칭 안됨 → 점수 유지
3. 최종 점수 확인
   ├─ score >= score_min → 통과 ✅
   └─ score < score_min → 제외 ❌
```

---

## 3가지 용도별 동작

### 용도 1: 소싱 용도 (외부 도매처에서 시즌 상품 찾기)

**실제 사용 시나리오:**
- 현재 날짜에 맞는 시즌의 소싱 키워드를 추출
- 해당 키워드로 도매처에서 상품 검색
- 이미 DB에 있는 상품코드는 제외하여 중복 소싱 방지

**동작:**
1. 현재 날짜 기준으로 활성화된 시즌 확인
   - 시즌 기간 내 (시작일 ~ 종료일)
   - 또는 소싱 기간 내 (시작일 - 소싱기간 ~ 종료일 + 여유기간)

2. 활성화된 시즌의 소싱 키워드 추출
   - include 키워드 목록 추출
   - 카테고리별로 그룹화 (선택사항)

3. DB에 이미 있는 상품코드 확인
   - 해당 키워드로 매칭되는 상품코드 조회
   - 중복 방지를 위한 상품코드 리스트 생성

4. 결과 출력
   - 소싱 키워드 리스트 (카테고리별)
   - 이미 DB에 있는 상품코드 리스트 (중복 방지용)

**출력 예시:**
```
현재 날짜: 2024-10-15 (할로윈 시즌)
소싱 키워드: ["할로윈", "호박", "유령", "마녀"]
이미 DB에 있는 상품코드: ["PROD001", "PROD002", "PROD003"]
→ 도매처에서 이 상품코드는 제외하고 소싱
```

### 용도 2: DB에서 시즌 키워드 없는 상품 출력 (일반 상품만)

**실제 사용 시나리오:**
- DB 내에서 시즌 키워드가 들어가지 않은 일반 상품만 추출
- 시즌 상품이 아닌 상품만 필터링하여 출력

**동작:**
1. DB에서 모든 상품 조회
2. 각 상품에 대해 시즌 키워드 매칭 확인
   - include 키워드 매칭 여부 확인
   - 매칭되면 시즌 상품으로 판단
3. 시즌 키워드가 없는 상품만 필터링
4. 결과 출력
   - 시즌 키워드 없는 상품 리스트
   - 상품코드, 상품명

**출력 예시:**
```
상품명: "일반 티셔츠" → 시즌 키워드 없음 → 포함 ✅
상품명: "할로윈 호박 장식품" → 시즌 키워드 있음 → 제외 ❌
상품명: "겨울 코트" → 시즌 키워드 있음 → 제외 ❌
→ 결과: "일반 티셔츠"만 출력
```

### 용도 3: DB에서 현재 시즌인 상품만 출력

**실제 사용 시나리오:**
- DB 내에서 현재 날짜 기준으로 시즌 기간 내인 상품만 추출
- 데이터 출고 시 현재 시즌에 맞는 상품만 출력

**동작:**
1. 현재 날짜 기준으로 활성화된 시즌 확인
   - 시즌 기간 내 (시작일 ~ 종료일)
2. DB에서 상품 조회
3. 각 상품에 대해 시즌 키워드 매칭 확인
   - include 키워드 매칭 여부
   - exclude 키워드 매칭 여부 (제외)
   - allowed 키워드 매칭 여부 (예외 허용)
4. 현재 시즌 기간 내이고 키워드 매칭되는 상품만 필터링
5. 결과 출력
   - 현재 시즌 상품 리스트
   - 상품코드, 상품명, 시즌 정보

**출력 예시:**
```
현재 날짜: 2024-10-15 (할로윈 시즌: 10-01 ~ 10-31)
상품명: "할로윈 호박 장식품" → 시즌 기간 내 + 키워드 매칭 → 포함 ✅
상품명: "크리스마스 트리" → 시즌 기간 외 → 제외 ❌
상품명: "일반 티셔츠" → 시즌 키워드 없음 → 제외 ❌
→ 결과: "할로윈 호박 장식품"만 출력
```

---

## 필터링 로직

### 시즌 기간 확인

```python
def check_season_period(season: Dict, current_date: datetime) -> str:
    """
    시즌 기간 확인
    
    Returns:
        "PREP": 소싱 가능, 업로드 불가
        "ACTIVE": 소싱 및 업로드 가능
        "GRACE": 소싱 가능, 업로드 불가
        "EXPIRE": 소싱 및 업로드 불가
    """
    start_date = parse_date(season["start_date"], current_date.year)
    end_date = parse_date(season["end_date"], current_date.year)
    
    # 연도 넘김 처리
    if season["cross_year"] and end_date < start_date:
        if current_date.month >= start_date.month:
            end_date = parse_date(season["end_date"], current_date.year + 1)
        else:
            start_date = parse_date(season["start_date"], current_date.year - 1)
    
    # PREP 기간 (시즌 시작 전 소싱 기간)
    prep_days = season.get("prep_days", 30)
    prep_start = start_date - timedelta(days=prep_days)
    
    if prep_start <= current_date < start_date:
        return "PREP"
    
    # ACTIVE 기간
    if start_date <= current_date <= end_date:
        return "ACTIVE"
    
    # GRACE 기간 (시즌 종료 후 일정 기간)
    grace_days = season.get("grace_days", 7)
    grace_end = end_date + timedelta(days=grace_days)
    
    if end_date < current_date <= grace_end:
        return "GRACE"
    
    # EXPIRE 기간
    return "EXPIRE"
```

### 키워드 매칭

```python
def match_keywords(product_name: str, season: Dict) -> tuple:
    """
    키워드 매칭
    
    Returns:
        (score, is_excluded, is_allowed)
        - score: include 키워드 매칭 점수
        - is_excluded: exclude 키워드 매칭 여부
        - is_allowed: allowed 키워드 매칭 여부
    """
    product_name_lower = product_name.lower()
    score = 0
    is_excluded = False
    is_allowed = False
    
    # 1. exclude 키워드 확인 (우선순위)
    for exclude_kw in season["keywords"]["exclude"]:
        keyword = exclude_kw["keyword"].lower()
        if keyword in product_name_lower:
            is_excluded = True
            break
    
    # 2. allowed 키워드 확인 (exclude가 있을 때만)
    if is_excluded:
        for allowed_kw in season["keywords"]["allowed"]:
            keyword = allowed_kw["keyword"].lower()
            if keyword in product_name_lower:
                is_allowed = True
                break
    
    # 3. include 키워드 확인 (exclude가 없거나 allowed가 있을 때만)
    if not is_excluded or is_allowed:
        for include_kw in season["keywords"]["include"]:
            keyword = include_kw["keyword"].lower()
            weight = include_kw.get("weight", 1.0)
            if keyword in product_name_lower:
                score += weight
    
    return score, is_excluded, is_allowed
```

### 필터링 함수 설계

#### 1. 소싱 키워드 추출 함수

```python
def get_sourcing_keywords(
    season_config: Dict,
    current_date: Optional[datetime] = None
) -> List[str]:
    """
    현재 날짜에 맞는 소싱 키워드 추출
    
    Args:
        season_config: 시즌 설정
        current_date: 현재 날짜 (기본값: 오늘)
    
    Returns:
        소싱 키워드 리스트
    """
    if current_date is None:
        current_date = datetime.now()
    
    keywords = []
    for season in season_config["seasons"]:
        # 시즌 기간 확인
        if is_season_active(season, current_date):
            # include 키워드 추출
            for kw_info in season["keywords"]["include"]:
                keyword = kw_info["keyword"]
                if keyword not in keywords:
                    keywords.append(keyword)
    
    return keywords
```

#### 2. DB에 이미 있는 상품코드 추출 함수

```python
def get_existing_product_codes(
    db_handler,
    season_config: Dict,
    current_date: Optional[datetime] = None
) -> List[str]:
    """
    DB에 이미 있는 상품코드 추출 (중복 방지용)
    
    Args:
        db_handler: DB 핸들러
        season_config: 시즌 설정
        current_date: 현재 날짜 (기본값: 오늘)
    
    Returns:
        상품코드 리스트
    """
    if current_date is None:
        current_date = datetime.now()
    
    # 소싱 키워드 추출
    keywords = get_sourcing_keywords(season_config, current_date)
    
    # DB에서 해당 키워드로 매칭되는 상품코드 조회
    product_codes = []
    for keyword in keywords:
        # DB에서 키워드로 상품 검색
        products = db_handler.search_products_by_keyword(keyword)
        for product in products:
            product_code = product.get("상품코드")
            if product_code and product_code not in product_codes:
                product_codes.append(product_code)
    
    return product_codes
```

#### 3. 시즌 키워드 없는 상품 필터링 함수

```python
def filter_non_season_products(
    products: List[Dict],
    season_config: Dict
) -> List[Dict]:
    """
    시즌 키워드 없는 상품만 필터링 (일반 상품만)
    
    Args:
        products: 상품 리스트
        season_config: 시즌 설정
    
    Returns:
        시즌 키워드 없는 상품 리스트
    """
    filtered_products = []
    
    for product in products:
        product_name = product.get("원본상품명", product.get("상품명", ""))
        if not product_name:
            # 상품명이 없으면 포함 (일반 상품으로 간주)
            filtered_products.append(product)
            continue
        
        # 모든 시즌에 대해 키워드 매칭 확인
        has_season_keyword = False
        for season in season_config["seasons"]:
            score, is_excluded, is_allowed = match_keywords(product_name, season)
            # include 키워드가 매칭되면 시즌 상품
            if score > 0:
                has_season_keyword = True
                break
        
        # 시즌 키워드가 없으면 포함
        if not has_season_keyword:
            filtered_products.append(product)
    
    return filtered_products
```

#### 4. 현재 시즌 상품만 필터링 함수

```python
def filter_current_season_products(
    products: List[Dict],
    season_config: Dict,
    current_date: Optional[datetime] = None
) -> List[Dict]:
    """
    현재 시즌인 상품만 필터링
    
    Args:
        products: 상품 리스트
        season_config: 시즌 설정
        current_date: 현재 날짜 (기본값: 오늘)
    
    Returns:
        현재 시즌 상품 리스트
    """
    if current_date is None:
        current_date = datetime.now()
    
    filtered_products = []
    
    for product in products:
        product_name = product.get("원본상품명", product.get("상품명", ""))
        if not product_name:
            continue
        
        # 각 시즌에 대해 확인
        matched_seasons = []
        for season in season_config["seasons"]:
            # 시즌 기간 확인 (현재 날짜가 시즌 기간 내인지)
            if not is_season_active(season, current_date):
                continue
            
            # 키워드 매칭
            score, is_excluded, is_allowed = match_keywords(product_name, season)
            
            # 필터링 조건
            # 1. exclude가 있고 allowed가 없으면 제외
            if is_excluded and not is_allowed:
                continue
            
            # 2. include 키워드가 매칭되어야 함
            if score >= season.get("score_min", 1):
                matched_seasons.append(season["id"])
        
        # 매칭된 시즌이 있으면 포함
        if matched_seasons:
            filtered_products.append({
                **product,
                "matched_seasons": matched_seasons
            })
    
    return filtered_products
```

---

## 구현 설계

### 파일 구조

```
DB_save/
├── Season_Filter_Seasons_Keywords.xlsx  # Excel 설정 파일
├── season_filters.json                  # JSON 캐시 파일
├── season_filter_manager_gui.py         # GUI 관리 도구
├── database/
│   ├── season_filter_loader.py          # Excel → JSON 컴파일
│   └── season_filter.py                 # 필터링 로직
└── 시즌필터링_완전설계.md                # 이 문서
```

### 주요 함수

#### 1. `load_season_config(excel_path, json_path) -> Dict`
- Excel → JSON 자동 컴파일
- mtime 기반 캐시 갱신

#### 2. `parse_excel_to_config(excel_path) -> Dict`
- Excel 파일 파싱
- JSON 구조로 변환

#### 3. `check_season_period(season, current_date) -> str`
- 시즌 기간 확인
- PREP/ACTIVE/GRACE/EXPIRE 반환

#### 4. `match_keywords(product_name, season) -> tuple`
- 키워드 매칭
- 점수, exclude, allowed 반환

#### 5. `filter_products_by_season(products, season_config, use_case, current_date) -> tuple`
- 상품 필터링
- 용도별 필터링 적용

---

## 실제 사용 예시

### 예시 1: 소싱 용도 - 현재 날짜에 맞는 소싱 키워드 + 상품코드 추출

**상황**: 2024년 10월 15일, 할로윈 시즌 소싱 준비

**시즌 설정:**
- 할로윈: 10-01 ~ 10-31
- 소싱 키워드: ["할로윈", "호박", "유령", "마녀"]
- 금지어: ["일반용", "일반 호박"]
- 예외 허용: ["장식용"]

**DB에 이미 있는 상품:**
- 상품코드: "PROD001", 상품명: "할로윈 호박 장식품"
- 상품코드: "PROD002", 상품명: "할로윈 유령 장식"

**사용 방법:**
```python
from database.season_filter_loader import load_season_config
from database.season_filter import get_sourcing_keywords, get_existing_product_codes

# 시즌 설정 로드
season_config = load_season_config(
    excel_path="Season_Filter_Seasons_Keywords.xlsx",
    json_path="season_filters.json"
)

# 현재 날짜에 맞는 소싱 키워드 추출
sourcing_keywords = get_sourcing_keywords(
    season_config=season_config,
    current_date=datetime(2024, 10, 15)
)
# 결과: ["할로윈", "호박", "유령", "마녀"]

# DB에 이미 있는 상품코드 추출 (중복 방지용)
existing_codes = get_existing_product_codes(
    db_handler=db_handler,
    season_config=season_config,
    current_date=datetime(2024, 10, 15)
)
# 결과: ["PROD001", "PROD002"]

# 도매처에서 소싱할 때
# - 키워드: "할로윈", "호박", "유령", "마녀"로 검색
# - 상품코드 "PROD001", "PROD002"는 이미 있으므로 제외
```

**출력 결과:**
```
=== 소싱 키워드 ===
할로윈, 호박, 유령, 마녀

=== 이미 DB에 있는 상품코드 (중복 방지) ===
PROD001, PROD002
```

### 예시 2: DB에서 시즌 키워드 없는 상품 출력 (일반 상품만)

**상황**: DB에서 시즌 상품이 아닌 일반 상품만 추출

**DB 상품 예시:**
- 상품코드: "PROD001", 상품명: "일반 티셔츠"
- 상품코드: "PROD002", 상품명: "할로윈 호박 장식품"
- 상품코드: "PROD003", 상품명: "겨울 코트"
- 상품코드: "PROD004", 상품명: "기본 반팔"

**사용 방법:**
```python
from database.season_filter import filter_non_season_products

# DB에서 모든 상품 조회
all_products = db_handler.get_all_products()

# 시즌 키워드 없는 상품만 필터링
non_season_products = filter_non_season_products(
    products=all_products,
    season_config=season_config
)

# 결과: PROD001, PROD004만 포함
# - PROD001: "일반 티셔츠" → 시즌 키워드 없음 ✅
# - PROD002: "할로윈 호박 장식품" → 시즌 키워드 있음 ❌
# - PROD003: "겨울 코트" → 시즌 키워드 있음 ❌
# - PROD004: "기본 반팔" → 시즌 키워드 없음 ✅
```

**출력 결과:**
```
=== 시즌 키워드 없는 상품 (일반 상품) ===
상품코드: PROD001, 상품명: 일반 티셔츠
상품코드: PROD004, 상품명: 기본 반팔
총 2개
```

### 예시 3: DB에서 현재 시즌인 상품만 출력

**상황**: 2024년 10월 15일, 할로윈 시즌 상품만 데이터 출고

**시즌 설정:**
- 할로윈: 10-01 ~ 10-31
- 소싱 키워드: ["할로윈", "호박", "유령"]
- 금지어: ["일반용"]
- 예외 허용: ["장식용"]

**DB 상품 예시:**
- 상품코드: "PROD001", 상품명: "할로윈 호박 장식품"
- 상품코드: "PROD002", 상품명: "일반 호박 (할로윈 아님)"
- 상품코드: "PROD003", 상품명: "할로윈 호박 장식용 (일반용 아님)"
- 상품코드: "PROD004", 상품명: "크리스마스 트리"
- 상품코드: "PROD005", 상품명: "일반 티셔츠"

**사용 방법:**
```python
from database.season_filter import filter_current_season_products

# DB에서 상품 조회
all_products = db_handler.get_products_by_category("의류>상의")

# 현재 시즌 상품만 필터링
current_season_products = filter_current_season_products(
    products=all_products,
    season_config=season_config,
    current_date=datetime(2024, 10, 15)  # 할로윈 시즌
)

# 결과: PROD001, PROD003만 포함
# - PROD001: "할로윈 호박 장식품" → 시즌 기간 내 + 키워드 매칭 ✅
# - PROD002: "일반 호박" → 금지어 매칭 ❌
# - PROD003: "할로윈 호박 장식용" → 시즌 기간 내 + 키워드 매칭 + 예외 허용 ✅
# - PROD004: "크리스마스 트리" → 시즌 기간 외 ❌
# - PROD005: "일반 티셔츠" → 시즌 키워드 없음 ❌
```

**출력 결과:**
```
=== 현재 시즌 상품 (할로윈: 10-01 ~ 10-31) ===
상품코드: PROD001, 상품명: 할로윈 호박 장식품
상품코드: PROD003, 상품명: 할로윈 호박 장식용 (일반용 아님)
총 2개
```

### 예시 4: 키워드 매칭 상세 예시

**상품명: "할로윈 호박 장식용 (일반용 아님)"**

**시즌 설정:**
- include: ["할로윈", "호박"]
- exclude: ["일반용"]
- allowed: ["장식용"]

**매칭 과정:**
```
1. exclude 확인: "일반용" → 매칭됨 ❌
2. allowed 확인: "장식용" → 매칭됨 ✅
   → exclude가 있어도 allowed가 있으므로 통과
3. include 확인: "할로윈", "호박" → 매칭됨 ✅
   → 점수: 1.0 + 1.0 = 2.0
4. 최종: 통과 ✅
```

**상품명: "일반 호박 (할로윈 아님)"**

**매칭 과정:**
```
1. exclude 확인: "일반 호박" → 매칭됨 ❌
2. allowed 확인: 없음 ❌
   → exclude가 있고 allowed가 없으므로 즉시 제외
3. 최종: 제외 ❌
```

---

## 체크리스트

### Phase 1: 핵심 기능

- [ ] Excel 파일 구조 설계
  - [ ] SEASON_MASTER 시트 구조
  - [ ] KEYWORDS 시트 구조
  - [ ] 용도 컬럼 추가

- [ ] Excel → JSON 컴파일
  - [ ] `parse_excel_to_config()` 함수
  - [ ] 키워드 타입별 처리 (include/exclude/allowed)
  - [ ] 용도별 필터링 지원

- [ ] 필터링 로직
  - [ ] `check_season_period()` 함수
  - [ ] `match_keywords()` 함수
  - [ ] `filter_products_by_season()` 함수
  - [ ] 용도별 필터링 로직

- [ ] 테스트
  - [ ] 소싱 용도 테스트
  - [ ] DB 필터링 용도 테스트
  - [ ] 삭제 대상 찾기 용도 테스트
  - [ ] 키워드 매칭 테스트 (include/exclude/allowed)

---

## 참고사항

### 키워드 매칭 우선순위

1. **exclude 확인** (최우선)
   - 매칭되면 → allowed 확인
   - allowed가 있으면 → 통과
   - allowed가 없으면 → 즉시 제외

2. **include 확인** (exclude가 없거나 allowed가 있을 때만)
   - 매칭되면 → 점수 증가
   - 최종 점수가 score_min 이상이면 → 통과

### 용도별 필터 모드 요약

| 용도 | 설명 | 필터 조건 |
|------|------|-----------|
| **소싱** | 현재 날짜에 맞는 소싱 키워드 + 상품코드 추출 | 시즌 기간 내 + 키워드 매칭 |
| **일반 상품** | 시즌 키워드 없는 상품만 출력 | 시즌 키워드 없음 |
| **현재 시즌** | 현재 시즌인 상품만 출력 | 시즌 기간 내 + 키워드 매칭 |

### 예외 처리

- Excel 파일 없음 → JSON 캐시 사용 또는 필터링 건너뜀
- Excel 파싱 실패 → 이전 JSON 캐시 사용 또는 필터링 건너뜀
- 시즌 설정 없음 → 필터링 건너뜀 (모든 상품 통과)

