# 이미지 합성 워크플로우 화질 개선 가이드

## 🔍 화질 저하의 주요 원인 분석

### 1. **VAE 인코딩/디코딩 손실** (가장 큰 원인)
- **문제**: VAE는 이미지를 latent space(잠재 공간)로 압축하는데, 이 과정에서 **손실 압축**이 발생합니다.
- **영향**: SD1.5의 기본 VAE는 특히 텍스처와 디테일을 많이 잃습니다.
- **해결책**: 
  - `denoise` 값을 낮춰서 원본 이미지의 디테일을 더 많이 보존 (0.25 → 0.15)
  - 더 나은 VAE 사용 (예: `vae-ft-mse-840000-ema-pruned.safetensors`)

### 2. **KSampler의 denoise 값이 너무 높음**
- **현재**: `denoise: 0.25`
- **문제**: denoise가 높을수록 생성 모델이 원본 이미지를 더 많이 "재생성"하여 디테일이 손실됩니다.
- **개선**: `denoise: 0.15`로 낮춰서 원본 이미지의 디테일을 더 많이 보존

### 3. **샘플링 스텝이 부족**
- **현재**: `steps: 20`
- **문제**: 스텝이 적으면 생성 품질이 저하됩니다.
- **개선**: `steps: 30`으로 증가 (화질 향상, 처리 시간 약간 증가)

### 4. **ImageCompositeMasked의 resize_source**
- **현재**: `resize_source: true`
- **문제**: 합성 시 소스 이미지를 리사이즈하면서 추가 품질 저하 발생
- **개선**: `resize_source: false`로 변경 (이미 1000x1000으로 맞춰져 있으므로 불필요)

### 5. **GrowMask의 expand 값**
- **현재**: `expand: 5`
- **문제**: 마스크가 너무 많이 확장되면 합성 경계가 부자연스러울 수 있음
- **개선**: `expand: 3`으로 감소 (더 정확한 경계)

### 6. **ICLightConditioning의 multiplier**
- **현재**: `multiplier: 0.501`
- **개선**: `multiplier: 0.45`로 약간 낮춰서 더 자연스러운 조명

### 7. **CFG Scale**
- **현재**: `cfg: 6`
- **개선**: `cfg: 7`로 약간 증가 (프롬프트 준수도 향상)

## 📝 개선된 워크플로우 주요 변경사항

| 항목 | 기존 값 | 개선 값 | 이유 |
|------|---------|---------|------|
| **denoise** | 0.25 | **0.15** | 원본 디테일 보존 |
| **steps** | 20 | **30** | 생성 품질 향상 |
| **cfg** | 6 | **7** | 프롬프트 준수도 향상 |
| **multiplier** | 0.501 | **0.45** | 더 자연스러운 조명 |
| **resize_source** | true | **false** | 불필요한 리사이징 제거 |
| **expand** | 5 | **3** | 더 정확한 마스크 경계 |
| **긍정 프롬프트** | - | **"sharp details, high resolution" 추가** | 화질 강조 |

## 🚀 추가 개선 방안 (선택사항)

### 1. **더 나은 VAE 사용**
```
vae-ft-mse-840000-ema-pruned.safetensors
또는
sdxl-vae-fp16-fix.safetensors (SDXL용)
```
- ComfyUI의 `models/vae/` 폴더에 다운로드
- CheckpointLoaderSimple에서 VAE를 별도로 로드하거나, 더 나은 체크포인트 사용

### 2. **이미지 업스케일링**
- 합성 후 `UltimateSDUpscale` 또는 `ImageUpscaleWithModel` 노드 추가
- 2x 업스케일로 최종 해상도 향상

### 3. **배경 이미지 전처리**
- 896x896 배경을 1000x1000으로 업스케일할 때:
  - `interpolation: "lanczos"` (현재 사용 중) ✅
  - 또는 AI 업스케일러 사용 (예: `Real-ESRGAN`)

### 4. **후처리 (Post-processing)**
- 합성 후 `UnsharpMask` 노드로 선명도 향상
- `ColorCorrect` 노드로 색상 보정

## ⚠️ 주의사항

1. **denoise를 너무 낮추면** (0.1 이하):
   - 배경과 전경의 조명 일치가 어려워질 수 있음
   - 최소 0.1~0.2 범위 권장

2. **steps를 너무 높이면** (50 이상):
   - 처리 시간이 크게 증가
   - 화질 향상은 한계가 있음 (30~40이 적정)

3. **CFG를 너무 높이면** (10 이상):
   - 이미지가 과도하게 선명해지거나 부자연스러울 수 있음
   - 6~8 범위 권장

## 📊 예상 개선 효과

- **텍스처 품질**: 30~40% 향상 (denoise 감소)
- **전체 화질**: 20~30% 향상 (steps 증가 + 설정 최적화)
- **처리 시간**: 약 50% 증가 (steps 20→30)

## 🔧 테스트 권장사항

1. 먼저 `denoise: 0.15`로 테스트
2. 만족스럽지 않으면 `denoise: 0.1`로 더 낮춰보기
3. 여전히 부족하면 VAE 교체 고려
4. 최종적으로 업스케일링 노드 추가 검토

